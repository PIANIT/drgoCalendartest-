<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>DRGO CRM</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #111111;
  --surface: #1c1c1c;
  --surface2: #272727;
  --surface3: #303030;
  --border: #3a3a3a;
  --accent: #d4bc96;
  --accent2: #90bcd4;
  --text: #f0ebe2;
  --text-muted: #a09890;
  --red: #d48888;
  --green: #88d488;
  --chip-gold-bg: #c8a870;   --chip-gold-text: #1a1207;
  --chip-blue-bg: #7aaec8;   --chip-blue-text: #061825;
  --chip-red-bg:  #c87070;   --chip-red-text:  #200808;
  --chip-green-bg:#70c870;   --chip-green-text:#08200a;
  --chip-purple-bg:#9b70c8;  --chip-purple-text:#f0eaff;
  --font-main: "Malgun Gothic","ë§‘ì€ ê³ ë”•",-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
  --font-mono: 'DM Mono',"Malgun Gothic","ë§‘ì€ ê³ ë”•",monospace;
}
html.light {
  --bg:#f7f4f0; --surface:#ffffff; --surface2:#efebe4; --surface3:#e8e2d8;
  --border:#d8d0c4; --accent:#9c7d48; --accent2:#3a7a9a;
  --text:#1e1812; --text-muted:#7a6e60; --red:#a84444; --green:#3a8a3a;
  --chip-gold-bg:#b89558; --chip-gold-text:#ffffff;
  --chip-blue-bg:#5898ba; --chip-blue-text:#ffffff;
  --chip-red-bg:#b85858;  --chip-red-text:#ffffff;
  --chip-green-bg:#58b058;--chip-green-text:#ffffff;
  --chip-purple-bg:#7b50a8;--chip-purple-text:#ffffff;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--font-main);min-height:100vh;overflow-x:hidden;transition:background .25s,color .25s;}

/* AUTH */
#authOverlay{display:flex;position:fixed;inset:0;z-index:9999;background:var(--bg);align-items:center;justify-content:center;}
#authOverlay.hidden{display:none;}
.auth-box{width:100%;max-width:380px;padding:48px 36px 40px;background:var(--surface);border:1px solid var(--border);border-radius:20px;box-shadow:0 24px 64px rgba(0,0,0,.55);display:flex;flex-direction:column;align-items:center;}
.auth-logo{font-family:var(--font-mono);font-size:11px;letter-spacing:.25em;color:var(--text-muted);text-transform:uppercase;margin-bottom:24px;}
.auth-icon{font-size:36px;margin-bottom:8px;}
.auth-title{font-size:20px;font-weight:700;color:var(--accent);margin-bottom:4px;}
.auth-sub{font-size:11px;color:var(--text-muted);letter-spacing:.1em;margin-bottom:32px;}
.auth-input-wrap{width:100%;margin-bottom:14px;}
.auth-input{width:100%;padding:13px 16px;font-size:15px;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:var(--font-main);outline:none;transition:border-color .2s;letter-spacing:.1em;}
.auth-input:focus{border-color:var(--accent);}
.auth-input.error{border-color:var(--red);animation:shake .35s ease;}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
.auth-btn{width:100%;padding:14px;background:var(--accent);color:#1a1207;border:none;border-radius:10px;font-size:14px;font-weight:700;font-family:var(--font-main);cursor:pointer;transition:all .2s;letter-spacing:.06em;}
.auth-btn:hover:not(:disabled){background:#dcc8a4;transform:translateY(-1px);}
.auth-btn:disabled{opacity:.45;cursor:not-allowed;}
.auth-error{margin-top:10px;font-size:12px;color:var(--red);text-align:center;min-height:18px;}

/* LOADING */
#loadingOverlay{display:none;position:fixed;inset:0;z-index:8888;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);align-items:center;justify-content:center;flex-direction:column;gap:12px;}
#loadingOverlay.show{display:flex;}
.loading-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-family:var(--font-mono);font-size:12px;letter-spacing:.15em;color:var(--text-muted);}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding:16px 28px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;background:var(--bg);}
.header-left{display:flex;align-items:center;gap:14px;}
.app-title{font-family:var(--font-mono);font-size:13px;letter-spacing:.2em;color:var(--accent);text-transform:uppercase;}
.app-sub{font-family:var(--font-mono);font-size:10px;letter-spacing:.15em;color:var(--text-muted);text-transform:uppercase;}
.header-right{display:flex;align-items:center;gap:8px;}
.icon-btn{background:none;border:1px solid var(--border);color:var(--text-muted);cursor:pointer;width:32px;height:32px;border-radius:6px;font-size:15px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.icon-btn:hover{border-color:var(--accent);color:var(--accent);}
.add-btn{background:var(--accent);color:#1a1207;border:none;padding:8px 18px;border-radius:6px;font-family:var(--font-main);font-size:13px;cursor:pointer;transition:all .2s;font-weight:600;}
.add-btn:hover{background:#dcc8a4;transform:translateY(-1px);}

/* LAYOUT */
.layout{display:flex;height:calc(100vh - 61px);}

/* CLIENT PANEL */
.client-panel{width:300px;min-width:260px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--surface);flex-shrink:0;}
.panel-header{padding:14px 16px 10px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:10px;}
.panel-title{font-size:11px;font-family:var(--font-mono);letter-spacing:.15em;color:var(--text-muted);text-transform:uppercase;}
.search-wrap{position:relative;}
.search-input{width:100%;padding:9px 12px 9px 32px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font-main);font-size:13px;outline:none;transition:border-color .2s;}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--text-muted);}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--text-muted);pointer-events:none;}
.client-filter-row{display:flex;gap:5px;flex-wrap:wrap;}
.cf-btn{padding:3px 9px;border-radius:12px;border:1px solid var(--border);background:none;font-family:var(--font-mono);font-size:10px;letter-spacing:.04em;color:var(--text-muted);cursor:pointer;transition:all .15s;}
.cf-btn:hover,.cf-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(212,188,150,.1);}
.client-list{flex:1;overflow-y:auto;padding:6px;}
.client-list::-webkit-scrollbar{width:3px;}
.client-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
.client-item{padding:10px 11px;border-radius:9px;cursor:pointer;transition:all .15s;border:1px solid transparent;margin-bottom:3px;display:flex;align-items:center;gap:9px;}
.client-item:hover{background:var(--surface2);}
.client-item.active{background:var(--surface2);border-color:var(--accent);}
.client-avatar{width:34px;height:34px;border-radius:50%;background:var(--surface3);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--accent);flex-shrink:0;}
.client-info{flex:1;min-width:0;}
.client-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.client-meta{font-size:11px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.type-chip{font-size:10px;padding:2px 7px;border-radius:10px;font-weight:600;letter-spacing:.03em;white-space:nowrap;}
.type-personal{background:rgba(200,168,112,.2);color:var(--chip-gold-bg);}
.type-enter{background:rgba(122,174,200,.2);color:var(--chip-blue-bg);}
.type-corp{background:rgba(200,112,112,.2);color:var(--chip-red-bg);}
.type-rental{background:rgba(112,200,112,.2);color:var(--chip-green-bg);}
.type-unknown{background:rgba(155,112,200,.2);color:var(--chip-purple-bg);}
.empty-state{padding:36px 16px;text-align:center;color:var(--text-muted);font-size:12px;line-height:1.9;}

/* MAIN PANEL */
.main-panel{flex:1;min-width:0;display:flex;flex-direction:column;overflow:hidden;}
.no-client{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;color:var(--text-muted);}
.no-client-icon{font-size:44px;opacity:.25;}
.no-client-text{font-size:13px;letter-spacing:.04em;}

.detail-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.detail-header{padding:18px 26px 14px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0;}
.detail-name-row{display:flex;align-items:center;gap:12px;}
.detail-avatar{width:46px;height:46px;border-radius:50%;background:var(--surface2);border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:var(--accent);flex-shrink:0;}
.detail-name{font-size:19px;font-weight:700;color:var(--text);}
.detail-nick{font-size:12px;color:var(--text-muted);margin-top:3px;}
.detail-actions{display:flex;gap:7px;}
.detail-tabs{padding:0 26px;border-bottom:1px solid var(--border);display:flex;gap:0;flex-shrink:0;}
.dtab{padding:11px 16px;font-size:13px;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;font-weight:500;}
.dtab:hover{color:var(--text);}
.dtab.active{color:var(--accent);border-bottom-color:var(--accent);}

/* INFO TAB */
.info-tab{padding:20px 26px;overflow-y:auto;flex:1;}
.info-tab::-webkit-scrollbar{width:3px;}
.info-tab::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.info-field{background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:12px 14px;}
.info-field-label{font-size:10px;font-family:var(--font-mono);letter-spacing:.12em;color:var(--text-muted);text-transform:uppercase;margin-bottom:5px;}
.info-field-value{font-size:13px;color:var(--text);font-weight:500;word-break:break-all;}
.info-field-value.empty{color:var(--text-muted);font-weight:400;font-size:12px;}
.info-field.full{grid-column:1/-1;}
.section-head{font-size:10px;font-family:var(--font-mono);letter-spacing:.15em;color:var(--text-muted);text-transform:uppercase;grid-column:1/-1;display:flex;align-items:center;gap:8px;margin-top:8px;}
.section-head::after{content:'';flex:1;height:1px;background:var(--border);}

/* CONSULT TAB */
.consult-tab{display:flex;flex-direction:column;flex:1;overflow:hidden;}
.consult-toolbar{padding:12px 26px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.consult-count{font-size:11px;font-family:var(--font-mono);color:var(--text-muted);letter-spacing:.08em;}
.new-consult-btn{background:var(--accent);color:#1a1207;border:none;padding:7px 14px;border-radius:6px;font-family:var(--font-main);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;}
.new-consult-btn:hover{background:#dcc8a4;transform:translateY(-1px);}
.consult-list{flex:1;overflow-y:auto;padding:14px 26px;display:flex;flex-direction:column;gap:10px;}
.consult-list::-webkit-scrollbar{width:3px;}
.consult-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
.consult-card{background:var(--surface);border:1px solid var(--border);border-radius:11px;overflow:hidden;transition:border-color .15s;cursor:pointer;}
.consult-card:hover{border-color:var(--accent);}
.consult-card-header{padding:12px 14px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
.consult-card-title{font-size:14px;font-weight:600;color:var(--text);}
.consult-card-meta{display:flex;align-items:center;gap:7px;margin-top:4px;flex-wrap:wrap;}
.consult-type-chip{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;}
.ct-visit{background:rgba(200,168,112,.2);color:var(--chip-gold-bg);}
.ct-remote{background:rgba(122,174,200,.2);color:var(--chip-blue-bg);}
.ct-rental{background:rgba(112,200,112,.2);color:var(--chip-green-bg);}
.ct-repair{background:rgba(200,112,112,.2);color:var(--chip-red-bg);}
.ct-as{background:rgba(155,112,200,.2);color:var(--chip-purple-bg);}
.ct-simple{background:rgba(160,152,144,.2);color:var(--text-muted);}
.ct-refund{background:rgba(200,112,112,.2);color:var(--chip-red-bg);}
.ct-design{background:rgba(122,174,200,.2);color:var(--chip-blue-bg);}
.consult-date-badge{font-size:11px;font-family:var(--font-mono);color:var(--text-muted);white-space:nowrap;flex-shrink:0;}
.consult-card-body{padding:0 14px 12px;font-size:12px;color:var(--text-muted);line-height:1.6;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.consult-card-footer{padding:8px 14px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface2);}
.consult-counselor{font-size:10px;font-family:var(--font-mono);color:var(--text-muted);}
.consult-entry-count{font-size:10px;color:var(--text-muted);}
.consult-empty{padding:40px;text-align:center;color:var(--text-muted);font-size:13px;}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:560px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 32px 80px rgba(0,0,0,.55);}
.modal-header{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.modal-title{font-size:15px;font-weight:700;color:var(--text);}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all .15s;}
.modal-close:hover{background:var(--surface2);color:var(--red);}
.modal-body{padding:18px 22px;overflow-y:auto;flex:1;}
.modal-body::-webkit-scrollbar{width:3px;}
.modal-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
.modal-footer{padding:14px 22px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:9px;flex-shrink:0;}

/* FORM */
.form-group{margin-bottom:14px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
.form-label{display:block;font-size:10px;font-family:var(--font-mono);letter-spacing:.12em;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px;}
.form-label .req{color:var(--accent);}
.form-input,.form-select,.form-textarea{width:100%;padding:10px 13px;background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font-main);font-size:13px;outline:none;transition:border-color .2s;}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent);}
.form-input::placeholder,.form-textarea::placeholder{color:var(--text-muted);}
.form-input.error{border-color:var(--red);animation:shake .35s ease;}
.form-select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M5 6L0 0h10z' fill='%23a09890'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;}
.form-select option{background:var(--surface);}
.form-textarea{resize:vertical;min-height:76px;line-height:1.6;}
.btn-cancel{padding:9px 18px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);font-family:var(--font-main);font-size:13px;cursor:pointer;transition:all .15s;}
.btn-cancel:hover{border-color:var(--red);color:var(--red);}
.btn-save{padding:9px 22px;background:var(--accent);color:#1a1207;border:none;border-radius:8px;font-family:var(--font-main);font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-save:hover{background:#dcc8a4;transform:translateY(-1px);}
.btn-save:disabled{opacity:.45;cursor:not-allowed;transform:none;}
.btn-danger{padding:9px 18px;background:none;border:1px solid var(--red);border-radius:8px;color:var(--red);font-family:var(--font-main);font-size:13px;cursor:pointer;transition:all .15s;}
.btn-danger:hover{background:rgba(212,136,136,.1);}

/* CONSULT DETAIL */
.consult-modal{max-width:660px;}
.tl-section-title{font-size:10px;font-family:var(--font-mono);letter-spacing:.15em;color:var(--text-muted);text-transform:uppercase;margin:18px 0 12px;display:flex;align-items:center;gap:8px;}
.tl-section-title::after{content:'';flex:1;height:1px;background:var(--border);}
.timeline{display:flex;flex-direction:column;}
.tl-item{display:flex;gap:12px;}
.tl-line{display:flex;flex-direction:column;align-items:center;flex-shrink:0;}
.tl-dot{width:9px;height:9px;border-radius:50%;background:var(--accent);border:2px solid var(--bg);flex-shrink:0;margin-top:4px;}
.tl-connector{width:2px;flex:1;min-height:16px;background:var(--border);}
.tl-item:last-child .tl-connector{background:transparent;}
.tl-content{flex:1;padding-bottom:16px;}
.tl-time{font-size:10px;font-family:var(--font-mono);color:var(--text-muted);margin-bottom:4px;}
.tl-bubble{background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:11px 13px;font-size:13px;color:var(--text);line-height:1.65;white-space:pre-wrap;word-break:break-word;}
.tl-author{font-size:10px;font-family:var(--font-mono);color:var(--text-muted);margin-top:5px;}
.tl-add{margin-top:12px;border:1px solid var(--border);border-radius:9px;overflow:hidden;}
.tl-add-head{padding:9px 13px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.taf-label{font-size:10px;font-family:var(--font-mono);color:var(--text-muted);letter-spacing:.1em;}
.taf-dt{padding:5px 9px;background:var(--surface3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;font-family:var(--font-mono);outline:none;transition:border-color .2s;}
.taf-dt:focus{border-color:var(--accent);}
.tl-add-body{display:flex;align-items:flex-end;}
.tl-textarea{flex:1;padding:11px 13px;background:var(--surface);border:none;color:var(--text);font-family:var(--font-main);font-size:13px;resize:none;outline:none;min-height:68px;line-height:1.6;}
.tl-textarea::placeholder{color:var(--text-muted);}
.tl-submit{padding:11px 14px;background:var(--accent);color:#1a1207;border:none;font-family:var(--font-main);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;border-left:1px solid var(--border);align-self:stretch;min-width:56px;}
.tl-submit:hover{background:#dcc8a4;}

/* TOAST */
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(16px);z-index:9000;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:11px 18px;font-size:13px;color:var(--text);box-shadow:0 8px 28px rgba(0,0,0,.4);opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.success{border-color:var(--green);color:var(--green);}
.toast.error{border-color:var(--red);color:var(--red);}

/* CONFIRM */
.confirm-overlay{display:none;position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);align-items:center;justify-content:center;}
.confirm-overlay.open{display:flex;}
.confirm-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:26px 26px 20px;max-width:340px;width:100%;margin:20px;box-shadow:0 24px 64px rgba(0,0,0,.5);}
.confirm-icon{font-size:30px;text-align:center;margin-bottom:10px;}
.confirm-title{font-size:15px;font-weight:700;color:var(--text);text-align:center;margin-bottom:7px;}
.confirm-text{font-size:12px;color:var(--text-muted);text-align:center;line-height:1.6;margin-bottom:18px;}
.confirm-btns{display:flex;gap:9px;}
.confirm-cancel{flex:1;padding:9px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);font-family:var(--font-main);font-size:13px;cursor:pointer;transition:all .15s;}
.confirm-cancel:hover{border-color:var(--accent);color:var(--text);}
.confirm-ok{flex:1;padding:9px;background:var(--red);color:#fff;border:none;border-radius:8px;font-family:var(--font-main);font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;}
.confirm-ok:hover{opacity:.85;}

/* RESPONSIVE */
@media(max-width:760px){
  .layout{flex-direction:column;height:auto;min-height:calc(100vh - 57px);}
  .client-panel{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--border);}
  .client-list{max-height:220px;}
  .main-panel{flex:1;}
  .detail-header{padding:14px 16px 10px;}
  .detail-tabs{padding:0 16px;}
  .info-tab{padding:14px 16px;}
  .consult-toolbar,.consult-list{padding-left:16px;padding-right:16px;}
  .info-grid{grid-template-columns:1fr;}
  .info-field.full{grid-column:1;}
  header{padding:12px 16px;}
  .modal-overlay{padding:0;align-items:flex-end;}
  .modal{border-radius:18px 18px 0 0;max-height:92vh;}
  .form-row{grid-template-columns:1fr;}
}

/* â”€â”€ ê³µí†µ íƒ­ ë ˆì´ì•„ì›ƒ â”€â”€ */
.generic-tab{display:flex;flex-direction:column;flex:1;overflow:hidden;}
.generic-toolbar{padding:12px 26px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.generic-list{flex:1;overflow-y:auto;padding:14px 26px;display:flex;flex-direction:column;gap:10px;}
.generic-list::-webkit-scrollbar{width:3px;}
.generic-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
.generic-empty{padding:40px;text-align:center;color:var(--text-muted);font-size:13px;}
.item-card{background:var(--surface);border:1px solid var(--border);border-radius:11px;overflow:hidden;transition:border-color .15s;cursor:pointer;}
.item-card:hover{border-color:var(--accent);}
.item-card-header{padding:12px 14px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
.item-card-title{font-size:14px;font-weight:600;color:var(--text);}
.item-card-meta{display:flex;align-items:center;gap:7px;margin-top:4px;flex-wrap:wrap;font-size:11px;color:var(--text-muted);}
.item-card-body{padding:0 14px 10px;font-size:12px;color:var(--text-muted);line-height:1.6;}
.item-card-footer{padding:8px 14px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface2);font-size:11px;color:var(--text-muted);}
.item-date{font-size:11px;font-family:var(--font-mono);color:var(--text-muted);white-space:nowrap;flex-shrink:0;}

/* ìº˜ë¦°ë” ê²€ìƒ‰ */
.cal-search-wrap{position:relative;margin-bottom:14px;}
.cal-search-input{width:100%;padding:9px 13px 9px 34px;background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font-main);font-size:13px;outline:none;transition:border-color .2s;}
.cal-search-input:focus{border-color:var(--accent);}
.cal-search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:12px;pointer-events:none;}
.cal-result-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto;margin-bottom:14px;}
.cal-result-item{padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;cursor:pointer;transition:all .15s;font-size:12px;}
.cal-result-item:hover{border-color:var(--accent);background:rgba(212,188,150,.06);}
.cal-result-item.selected{border-color:var(--accent);background:rgba(212,188,150,.1);}
.cal-result-title{font-weight:600;color:var(--text);margin-bottom:2px;}
.cal-result-meta{color:var(--text-muted);font-family:var(--font-mono);font-size:10px;}
.cal-linked-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;background:rgba(212,188,150,.12);border:1px solid rgba(212,188,150,.3);border-radius:6px;font-size:11px;color:var(--accent);font-family:var(--font-mono);}
.cal-loading{text-align:center;padding:12px;color:var(--text-muted);font-size:12px;}

/* ê²¬ì  ì´ë¯¸ì§€ */
.quote-images-wrap{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
.quote-img-thumb{width:80px;height:80px;object-fit:cover;border-radius:7px;border:1px solid var(--border);cursor:zoom-in;transition:opacity .15s;}
.quote-img-thumb:hover{opacity:.85;}

/* ê¸ˆì•¡ ë°°ì§€ */
.amount-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;background:rgba(136,212,136,.1);border:1px solid rgba(136,212,136,.3);border-radius:7px;font-size:13px;font-weight:700;color:var(--green);}
.balance-badge{background:rgba(212,136,136,.1);border-color:rgba(212,136,136,.3);color:var(--red);}
.refund-badge{background:rgba(144,188,212,.1);border-color:rgba(144,188,212,.3);color:var(--accent2);}

/* ìƒíƒœ ì¹© */
.status-chip{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;font-family:var(--font-mono);}
.status-pending {background:rgba(212,188,150,.15);color:var(--accent);}
.status-done    {background:rgba(136,212,136,.15);color:var(--green);}
.status-cancel  {background:rgba(212,136,136,.15);color:var(--red);}

/* ë§¤ì¶œ í†µê³„ ë°” */
.sales-summary{padding:14px 26px;border-bottom:1px solid var(--border);display:flex;gap:12px;flex-wrap:wrap;flex-shrink:0;}
.sales-sum-card{flex:1;min-width:120px;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:10px 14px;}
.sales-sum-label{font-size:10px;font-family:var(--font-mono);letter-spacing:.1em;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;}
.sales-sum-value{font-size:16px;font-weight:700;color:var(--text);}
.sales-sum-value.green{color:var(--green);}
.sales-sum-value.red{color:var(--red);}

/* í° ëª¨ë‹¬ */
.modal-lg{max-width:700px;}
.form-section-head{font-size:10px;font-family:var(--font-mono);letter-spacing:.14em;color:var(--text-muted);text-transform:uppercase;margin:16px 0 10px;display:flex;align-items:center;gap:8px;}
.form-section-head::after{content:'';flex:1;height:1px;background:var(--border);}
.field-readonly{width:100%;padding:9px 13px;background:var(--surface);border:1.5px solid var(--border);border-radius:8px;color:var(--text-muted);font-family:var(--font-main);font-size:13px;pointer-events:none;}

/* ë¼ì´íŠ¸ë°•ìŠ¤ */
#lightbox{display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.9);align-items:center;justify-content:center;cursor:zoom-out;}
#lightbox.open{display:flex;}
#lightbox img{max-width:90vw;max-height:90vh;border-radius:8px;object-fit:contain;}

@media(max-width:760px){
  .generic-toolbar,.generic-list{padding-left:16px;padding-right:16px;}
  .sales-summary{padding:10px 16px;}
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="authOverlay">
  <div class="auth-box">
    <div class="auth-logo">DRGO System</div>
    <div class="auth-icon">ğŸ‘¤</div>
    <div class="auth-title">CRM</div>
    <div class="auth-sub">ê³ ê° ê´€ê³„ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
    <div class="auth-input-wrap">
      <input class="auth-input" id="authIdInput" type="text" placeholder="ì•„ì´ë””" autocomplete="username">
    </div>
    <div class="auth-input-wrap">
      <input class="auth-input" id="authPwInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
    </div>
    <button class="auth-btn" id="authBtn">ë¡œê·¸ì¸</button>
    <div class="auth-error" id="authError"></div>
  </div>
</div>

<!-- LOADING -->
<div id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">LOADING...</div>
</div>

<!-- HEADER -->
<header>
  <div class="header-left">
    <div>
      <div class="app-title">DRGO CRM</div>
      <div class="app-sub">Client Relation Manager</div>
    </div>
  </div>
  <div class="header-right">
    <a href="index.html" style="text-decoration:none;"><button class="icon-btn" title="ìº˜ë¦°ë”ë¡œ ì´ë™">ğŸ“…</button></a>
    <button class="icon-btn" id="themeBtn" title="í…Œë§ˆ ì „í™˜">ğŸŒ™</button>
    <button class="add-btn" id="addClientBtn">+ ê³ ê° ë“±ë¡</button>
  </div>
</header>

<!-- LAYOUT -->
<div class="layout">

  <!-- CLIENT LIST -->
  <div class="client-panel">
    <div class="panel-header">
      <div class="panel-title">ê³ ê° ëª©ë¡ <span id="clientCountBadge" style="color:var(--accent);"></span></div>
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input class="search-input" id="searchInput" type="text" placeholder="ì´ë¦„, ë‹‰ë„¤ì„, ì „í™”ë²ˆí˜¸ ê²€ìƒ‰">
      </div>
      <div class="client-filter-row">
        <button class="cf-btn active" data-type="all">ì „ì²´</button>
        <button class="cf-btn" data-type="personal">ê°œì¸</button>
        <button class="cf-btn" data-type="enter">ì—”í„°</button>
        <button class="cf-btn" data-type="corp">ê¸°ì—…</button>
        <button class="cf-btn" data-type="rental">ë Œíƒˆ</button>
        <button class="cf-btn" data-type="unknown">ë¯¸ì •</button>
      </div>
    </div>
    <div class="client-list" id="clientList">
      <div class="empty-state">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>

  <!-- MAIN PANEL -->
  <div class="main-panel">
    <div class="no-client" id="noClientView">
      <div class="no-client-icon">ğŸ‘¥</div>
      <div class="no-client-text">ê³ ê°ì„ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>

    <div id="clientDetail" class="detail-wrap" style="display:none;">
      <div class="detail-header">
        <div class="detail-name-row">
          <div class="detail-avatar" id="detailAvatar"></div>
          <div>
            <div class="detail-name" id="detailName"></div>
            <div class="detail-nick" id="detailNick"></div>
          </div>
        </div>
        <div class="detail-actions">
          <button class="icon-btn" id="editClientBtn" title="ê³ ê° ì •ë³´ ìˆ˜ì •">âœï¸</button>
          <button class="icon-btn" id="deleteClientBtn" title="ê³ ê° ì‚­ì œ" style="color:var(--red);">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="detail-tabs">
        <div class="dtab active" data-tab="info">ê¸°ë³¸ ì •ë³´</div>
        <div class="dtab" data-tab="consult">ìƒë‹´ ë‚´ì—­ <span id="consultTabCount" style="font-size:11px;color:var(--text-muted);"></span></div>
        <div class="dtab" data-tab="visit_req">ë°©ë¬¸ì˜ë¢° <span id="visitReqTabCount" style="font-size:11px;color:var(--text-muted);"></span></div>
        <div class="dtab" data-tab="visit_rep">ë°©ë¬¸ë³´ê³  <span id="visitRepTabCount" style="font-size:11px;color:var(--text-muted);"></span></div>
        <div class="dtab" data-tab="sales">ë§¤ì¶œê¸°ë¡ <span id="salesTabCount" style="font-size:11px;color:var(--text-muted);"></span></div>
      </div>

      <!-- INFO -->
      <div id="tabInfo" class="info-tab">
        <div class="info-grid" id="infoGrid"></div>
      </div>

      <!-- CONSULT -->
      <div id="tabConsult" class="consult-tab" style="display:none;">
        <div class="consult-toolbar">
          <div class="consult-count" id="consultCountLabel"></div>
          <button class="new-consult-btn" id="newConsultBtn">+ ìƒë‹´ ë“±ë¡</button>
        </div>
        <div class="consult-list" id="consultList"></div>
      </div>

      <!-- ë°©ë¬¸ì˜ë¢° -->
      <div id="tabVisitReq" class="generic-tab" style="display:none;">
        <div class="generic-toolbar">
          <div class="consult-count" id="visitReqCountLabel"></div>
          <button class="new-consult-btn" id="newVisitReqBtn">+ ë°©ë¬¸ì˜ë¢° ë“±ë¡</button>
        </div>
        <div class="generic-list" id="visitReqList"></div>
      </div>

      <!-- ë°©ë¬¸ë³´ê³  -->
      <div id="tabVisitRep" class="generic-tab" style="display:none;">
        <div class="generic-toolbar">
          <div class="consult-count" id="visitRepCountLabel"></div>
          <button class="new-consult-btn" id="newVisitRepBtn">+ ë°©ë¬¸ë³´ê³  ë“±ë¡</button>
        </div>
        <div class="generic-list" id="visitRepList"></div>
      </div>

      <!-- ë§¤ì¶œê¸°ë¡ -->
      <div id="tabSales" class="generic-tab" style="display:none;">
        <div class="sales-summary" id="salesSummary"></div>
        <div class="generic-toolbar">
          <div class="consult-count" id="salesCountLabel"></div>
          <button class="new-consult-btn" id="newSalesBtn">+ ë§¤ì¶œ ë“±ë¡</button>
        </div>
        <div class="generic-list" id="salesList"></div>
      </div>
    </div>
  </div>

</div>

<!-- MODAL: ê³ ê° ë“±ë¡/ìˆ˜ì • -->
<div class="modal-overlay" id="clientModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="clientModalTitle">ê³ ê° ë“±ë¡</div>
      <button class="modal-close" id="clientModalClose">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div>
          <label class="form-label">ì´ë¦„ <span class="req">*</span></label>
          <input class="form-input" id="fName" type="text" placeholder="ì‹¤ëª…">
        </div>
        <div>
          <label class="form-label">ë‹‰ë„¤ì„</label>
          <input class="form-input" id="fNick" type="text" placeholder="ë‹‰ë„¤ì„ ë˜ëŠ” ì±„ë„ëª…">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label class="form-label">ì „í™”ë²ˆí˜¸</label>
          <input class="form-input" id="fPhone" type="tel" placeholder="010-0000-0000">
        </div>
        <div>
          <label class="form-label">êµ¬ë¶„</label>
          <select class="form-select" id="fType">
            <option value="unknown">ë¯¸ì •</option>
            <option value="personal">ê°œì¸</option>
            <option value="enter">ì—”í„°</option>
            <option value="corp">ê¸°ì—…</option>
            <option value="rental">ë Œíƒˆ</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div>
          <label class="form-label">í”Œë«í¼</label>
          <input class="form-input" id="fPlatform" type="text" placeholder="ìœ íŠœë¸Œ, íŠ¸ìœ„ì¹˜, ì•„í”„ë¦¬ì¹´...">
        </div>
        <div>
          <label class="form-label">ë°©ì†¡ì£¼ì†Œ / ID</label>
          <input class="form-input" id="fStreamId" type="text" placeholder="ì±„ë„ ì£¼ì†Œ ë˜ëŠ” ì•„ì´ë””">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ë°©ì¢… ì£¼ì œ</label>
        <input class="form-input" id="fStreamTopic" type="text" placeholder="ê²Œì„, í† í¬, ë¨¹ë°©...">
      </div>
      <div class="form-group">
        <label class="form-label">ì£¼ì†Œ</label>
        <input class="form-input" id="fAddress" type="text" placeholder="ë°©ë¬¸ ì˜ë¢° ì‹œ ì£¼ì†Œ">
      </div>
      <div class="form-group">
        <label class="form-label">PC ì‚¬ì–‘</label>
        <textarea class="form-textarea" id="fPcSpec" placeholder="CPU, GPU, RAM, ë©”ì¸ë³´ë“œ..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">ì¥ë¹„ ëª©ë¡</label>
        <textarea class="form-textarea" id="fEquipment" placeholder="ì¹´ë©”ë¼, ë§ˆì´í¬, ì˜¤ë””ì˜¤ ì¸í„°í˜ì´ìŠ¤..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">íŠ¹ì´ì‚¬í•­</label>
        <textarea class="form-textarea" id="fNote" placeholder="íŠ¹ì´ì‚¬í•­ ë˜ëŠ” ë©”ëª¨"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="clientModalCancel">ì·¨ì†Œ</button>
      <button class="btn-save" id="clientModalSave">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- MODAL: ìƒë‹´ ë“±ë¡ -->
<div class="modal-overlay" id="consultModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ìƒë‹´ ë“±ë¡</div>
      <button class="modal-close" id="consultModalClose">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ìƒë‹´ ì œëª© <span class="req">*</span></label>
        <input class="form-input" id="cTitle" type="text" placeholder="ìƒë‹´ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      <div class="form-row">
        <div>
          <label class="form-label">ë¬¸ì˜ ìœ í˜•</label>
          <select class="form-select" id="cType">
            <option value="visit">ë°©ë¬¸</option>
            <option value="remote">ì›ê²©</option>
            <option value="rental">ë Œíƒˆ</option>
            <option value="repair">ë¬¸ì œí•´ê²°</option>
            <option value="as">AS</option>
            <option value="simple">ë‹¨ìˆœ</option>
            <option value="refund">í™˜ë¶ˆ</option>
            <option value="design">ë””ìì¸</option>
          </select>
        </div>
        <div>
          <label class="form-label">ë‹´ë‹¹ ìƒë‹´ì‚¬</label>
          <input class="form-input" id="cCounselor" type="text" placeholder="ìƒë‹´ì‚¬ ì´ë¦„">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ì´ˆê¸° ìƒë‹´ ë‚´ìš©</label>
        <textarea class="form-textarea" id="cContent" placeholder="ìƒë‹´ ë‚´ìš©ì„ ê°„ëµíˆ ì ì–´ì£¼ì„¸ìš”" style="min-height:96px;"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="consultModalCancel">ì·¨ì†Œ</button>
      <button class="btn-save" id="consultModalSave">ë“±ë¡</button>
    </div>
  </div>
</div>

<!-- MODAL: ìƒë‹´ ìƒì„¸ -->
<div class="modal-overlay" id="consultDetailModal">
  <div class="modal consult-modal">
    <div class="modal-header">
      <div style="flex:1;min-width:0;">
        <div class="modal-title" id="cdTitle" style="margin-bottom:6px;"></div>
        <div style="display:flex;gap:7px;flex-wrap:wrap;" id="cdMeta"></div>
      </div>
      <button class="modal-close" id="cdClose">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="cdSummary" style="background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:12px 14px;font-size:13px;color:var(--text-muted);line-height:1.65;"></div>
      <div class="tl-section-title">ìƒë‹´ íƒ€ì„ë¼ì¸</div>
      <div class="timeline" id="cdTimeline"></div>
      <div class="tl-add">
        <div class="tl-add-head">
          <span class="taf-label">ìƒë‹´ ì‹œê°„</span>
          <input class="taf-dt" type="datetime-local" id="cdEntryTime">
        </div>
        <div class="tl-add-body">
          <textarea class="tl-textarea" id="cdEntryText" placeholder="ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
          <button class="tl-submit" id="cdEntrySubmit">ë“±ë¡</button>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="justify-content:space-between;">
      <button class="btn-danger" id="cdDeleteConsult">ìƒë‹´ ì‚­ì œ</button>
      <button class="btn-cancel" id="cdClose2">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- â•â•â• ë°©ë¬¸ì˜ë¢° ëª¨ë‹¬ â•â•â• -->
<div class="modal-overlay" id="visitReqModal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title" id="visitReqModalTitle">ë°©ë¬¸ì˜ë¢° ë“±ë¡</div>
      <button class="modal-close" id="visitReqModalClose">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- ìº˜ë¦°ë” ì—°ë™ -->
      <div class="form-section-head">ğŸ“… ìº˜ë¦°ë” ì¼ì • ì—°ë™</div>
      <div class="cal-search-wrap">
        <span class="cal-search-icon">ğŸ”</span>
        <input class="cal-search-input" id="vrCalSearch" placeholder="ì¼ì • ì œëª©, ë‚ ì§œ, ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰â€¦">
      </div>
      <div id="vrCalResults" class="cal-result-list" style="display:none;"></div>
      <div id="vrLinkedBadge" style="margin-bottom:14px;display:none;">
        <span class="cal-linked-badge">ğŸ“… <span id="vrLinkedTitle"></span></span>
        <button id="vrUnlinkBtn" style="margin-left:8px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:11px;">ì—°ê²° í•´ì œ</button>
      </div>
      <!-- ê¸°ë³¸ ì •ë³´ -->
      <div class="form-section-head">ê¸°ë³¸ ì •ë³´</div>
      <div class="form-row">
        <div><label class="form-label">ë°©ë¬¸ ì¼ì <span class="req">*</span></label><input class="form-input" type="date" id="vrDate"></div>
        <div><label class="form-label">ìƒíƒœ</label>
          <select class="form-select" id="vrStatus">
            <option value="pending">ì˜ˆì •</option>
            <option value="done">ì™„ë£Œ</option>
            <option value="cancel">ì·¨ì†Œ</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div><label class="form-label">ë‹´ë‹¹ì</label><input class="form-input" id="vrAssignee" placeholder="ë‹´ë‹¹ì ì´ë¦„"></div>
        <div><label class="form-label">ë°©ë¬¸ ìœ í˜•</label>
          <select class="form-select" id="vrType">
            <option value="visit">ë°©ë¬¸</option>
            <option value="remote">ì›ê²©</option>
            <option value="rental">ë Œíƒˆ</option>
          </select>
        </div>
      </div>
      <!-- ìº˜ë¦°ë”ì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ (ì½ê¸°ì „ìš©) -->
      <div id="vrCalInfo" style="display:none;">
        <div class="form-section-head">ìº˜ë¦°ë” ì—°ë™ ì •ë³´</div>
        <div class="form-row">
          <div><label class="form-label">ì˜ë¢°ìëª…</label><div class="field-readonly" id="vrCalName">â€”</div></div>
          <div><label class="form-label">ì—°ë½ì²˜</label><div class="field-readonly" id="vrCalPhone">â€”</div></div>
        </div>
        <div class="form-row">
          <div><label class="form-label">ê²¬ì  ì´ì•¡</label><div class="field-readonly" id="vrCalEstimate">â€”</div></div>
          <div><label class="form-label">ì”ê¸ˆ</label><div class="field-readonly" id="vrCalBalance">â€”</div></div>
        </div>
        <div style="margin-bottom:14px;">
          <label class="form-label">ê²¬ì ì„œ ì´ë¯¸ì§€</label>
          <div class="quote-images-wrap" id="vrQuoteImages"></div>
        </div>
      </div>
      <!-- ì˜ë¢° ë‚´ìš© -->
      <div class="form-section-head">ì˜ë¢° ë‚´ìš©</div>
      <div class="form-group">
        <label class="form-label">ì œëª© <span class="req">*</span></label>
        <input class="form-input" id="vrTitle" placeholder="ë°©ë¬¸ì˜ë¢° ì œëª©">
      </div>
      <div class="form-group">
        <label class="form-label">ì£¼ì†Œ</label>
        <input class="form-input" id="vrAddress" placeholder="ë°©ë¬¸ ì£¼ì†Œ">
      </div>
      <div class="form-group">
        <label class="form-label">ìš”ì²­ ë‚´ìš©</label>
        <textarea class="form-textarea" id="vrContent" placeholder="ë°©ë¬¸ ì˜ë¢° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="min-height:90px;"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="visitReqDeleteBtn" style="display:none;margin-right:auto;">ì‚­ì œ</button>
      <button class="btn-cancel" id="visitReqCancelBtn">ì·¨ì†Œ</button>
      <button class="btn-save" id="visitReqSaveBtn">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â• ë°©ë¬¸ë³´ê³  ëª¨ë‹¬ â•â•â• -->
<div class="modal-overlay" id="visitRepModal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title" id="visitRepModalTitle">ë°©ë¬¸ë³´ê³  ë“±ë¡</div>
      <button class="modal-close" id="visitRepModalClose">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- ìº˜ë¦°ë” ì—°ë™ -->
      <div class="form-section-head">ğŸ“… ìº˜ë¦°ë” ì¼ì • ì—°ë™</div>
      <div class="cal-search-wrap">
        <span class="cal-search-icon">ğŸ”</span>
        <input class="cal-search-input" id="repCalSearch" placeholder="ì¼ì • ì œëª©, ë‚ ì§œ, ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰â€¦">
      </div>
      <div id="repCalResults" class="cal-result-list" style="display:none;"></div>
      <div id="repLinkedBadge" style="margin-bottom:14px;display:none;">
        <span class="cal-linked-badge">ğŸ“… <span id="repLinkedTitle"></span></span>
        <button id="repUnlinkBtn" style="margin-left:8px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:11px;">ì—°ê²° í•´ì œ</button>
      </div>
      <!-- ê¸°ë³¸ ì •ë³´ -->
      <div class="form-section-head">ê¸°ë³¸ ì •ë³´</div>
      <div class="form-row">
        <div><label class="form-label">ë°©ë¬¸ ì¼ì <span class="req">*</span></label><input class="form-input" type="date" id="repDate"></div>
        <div><label class="form-label">ì‘ì„±ì</label><input class="form-input" id="repAuthor" placeholder="ë³´ê³ ì„œ ì‘ì„±ì"></div>
      </div>
      <!-- ìº˜ë¦°ë” ì—°ë™ ì •ë³´ -->
      <div id="repCalInfo" style="display:none;">
        <div class="form-section-head">ìº˜ë¦°ë” ì—°ë™ ì •ë³´</div>
        <div class="form-row">
          <div><label class="form-label">ì˜ë¢°ìëª…</label><div class="field-readonly" id="repCalName">â€”</div></div>
          <div><label class="form-label">ì—°ë½ì²˜</label><div class="field-readonly" id="repCalPhone">â€”</div></div>
        </div>
      </div>
      <!-- ë³´ê³  ë‚´ìš© -->
      <div class="form-section-head">ë³´ê³  ë‚´ìš©</div>
      <div class="form-group">
        <label class="form-label">ì œëª© <span class="req">*</span></label>
        <input class="form-input" id="repTitle" placeholder="ë°©ë¬¸ë³´ê³  ì œëª©">
      </div>
      <div class="form-group">
        <label class="form-label">ë°©ë¬¸ ê²°ê³¼</label>
        <select class="form-select" id="repResult" style="margin-bottom:10px;">
          <option value="success">ì •ìƒ ì™„ë£Œ</option>
          <option value="partial">ë¶€ë¶„ ì™„ë£Œ</option>
          <option value="fail">ë¯¸ì™„ë£Œ</option>
          <option value="followup">í›„ì† ë°©ë¬¸ í•„ìš”</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ë³´ê³  ë‚´ìš©</label>
        <textarea class="form-textarea" id="repContent" placeholder="ë°©ë¬¸ ê²°ê³¼ ë° ë‚´ìš©ì„ ìƒì„¸í•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”" style="min-height:110px;"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">íŠ¹ì´ì‚¬í•­</label>
        <textarea class="form-textarea" id="repNote" placeholder="íŠ¹ì´ì‚¬í•­, í›„ì† ì¡°ì¹˜ í•„ìš”ì‚¬í•­ ë“±"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="visitRepDeleteBtn" style="display:none;margin-right:auto;">ì‚­ì œ</button>
      <button class="btn-cancel" id="visitRepCancelBtn">ì·¨ì†Œ</button>
      <button class="btn-save" id="visitRepSaveBtn">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â• ë§¤ì¶œê¸°ë¡ ëª¨ë‹¬ â•â•â• -->
<div class="modal-overlay" id="salesModal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title" id="salesModalTitle">ë§¤ì¶œ ë“±ë¡</div>
      <button class="modal-close" id="salesModalClose">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- ìº˜ë¦°ë” ì—°ë™ -->
      <div class="form-section-head">ğŸ“… ìº˜ë¦°ë” ì¼ì • ì—°ë™</div>
      <div class="cal-search-wrap">
        <span class="cal-search-icon">ğŸ”</span>
        <input class="cal-search-input" id="slCalSearch" placeholder="ì¼ì • ì œëª©, ë‚ ì§œ, ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰â€¦">
      </div>
      <div id="slCalResults" class="cal-result-list" style="display:none;"></div>
      <div id="slLinkedBadge" style="margin-bottom:14px;display:none;">
        <span class="cal-linked-badge">ğŸ“… <span id="slLinkedTitle"></span></span>
        <button id="slUnlinkBtn" style="margin-left:8px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:11px;">ì—°ê²° í•´ì œ</button>
      </div>
      <!-- ìº˜ë¦°ë” ì—°ë™ ê²¬ì  ì •ë³´ -->
      <div id="slCalInfo" style="display:none;">
        <div class="form-section-head">ìº˜ë¦°ë” ì—°ë™ ê²¬ì  ì •ë³´</div>
        <div class="form-row">
          <div><label class="form-label">ê²¬ì  ì´ì•¡</label><div class="field-readonly" id="slCalEstimate">â€”</div></div>
          <div><label class="form-label">ì”ê¸ˆ</label><div class="field-readonly" id="slCalBalance">â€”</div></div>
        </div>
        <div style="margin-bottom:14px;">
          <label class="form-label">ê²¬ì ì„œ ì´ë¯¸ì§€</label>
          <div class="quote-images-wrap" id="slQuoteImages"></div>
        </div>
      </div>
      <!-- ë§¤ì¶œ ì •ë³´ -->
      <div class="form-section-head">ë§¤ì¶œ ì •ë³´</div>
      <div class="form-row">
        <div><label class="form-label">ë§¤ì¶œ ì¼ì <span class="req">*</span></label><input class="form-input" type="date" id="slDate"></div>
        <div><label class="form-label">ë§¤ì¶œ ìœ í˜•</label>
          <select class="form-select" id="slType">
            <option value="visit">ë°©ë¬¸ì˜ë¢°</option>
            <option value="remote">ì›ê²©</option>
            <option value="rental">ë Œíƒˆ</option>
            <option value="design">ë””ìì¸</option>
            <option value="other">ê¸°íƒ€</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ì œëª© <span class="req">*</span></label>
        <input class="form-input" id="slTitle" placeholder="ë§¤ì¶œ ê±´ ì œëª©">
      </div>
      <div class="form-row">
        <div><label class="form-label">ë§¤ì¶œ ê¸ˆì•¡ (ì›) <span class="req">*</span></label><input class="form-input" type="number" id="slAmount" placeholder="0" min="0"></div>
        <div><label class="form-label">ì”ê¸ˆ (ì›)</label><input class="form-input" type="number" id="slBalance" placeholder="0" min="0"></div>
      </div>
      <div class="form-row">
        <div><label class="form-label">í™˜ë¶ˆ ê¸ˆì•¡ (ì›)</label><input class="form-input" type="number" id="slRefund" placeholder="0" min="0"></div>
        <div><label class="form-label">ê²°ì œ ìƒíƒœ</label>
          <select class="form-select" id="slPayStatus">
            <option value="paid">ê²°ì œ ì™„ë£Œ</option>
            <option value="partial">ë¶€ë¶„ ê²°ì œ</option>
            <option value="unpaid">ë¯¸ê²°ì œ</option>
            <option value="refunded">í™˜ë¶ˆ</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ë©”ëª¨</label>
        <textarea class="form-textarea" id="slNote" placeholder="íŠ¹ì´ì‚¬í•­, í™˜ë¶ˆ ì‚¬ìœ  ë“±"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="salesDeleteBtn" style="display:none;margin-right:auto;">ì‚­ì œ</button>
      <button class="btn-cancel" id="salesCancelBtn">ì·¨ì†Œ</button>
      <button class="btn-save" id="salesSaveBtn">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ë¼ì´íŠ¸ë°•ìŠ¤ -->
<div id="lightbox"><img id="lightboxImg" src="" alt=""></div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-icon" id="confirmIcon">âš ï¸</div>
    <div class="confirm-title" id="confirmTitle"></div>
    <div class="confirm-text" id="confirmText"></div>
    <div class="confirm-btns">
      <button class="confirm-cancel" id="confirmCancel">ì·¨ì†Œ</button>
      <button class="confirm-ok" id="confirmOk">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, deleteDoc, addDoc, getDoc, getDocs,
         onSnapshot, query, orderBy, serverTimestamp, updateDoc, arrayUnion }
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "AIzaSyDnEOATYmwq0WJr6pCl-86-Q3ZEQjrrfeY",
  authDomain:        "drgo-calender.firebaseapp.com",
  projectId:         "drgo-calender",
  storageBucket:     "drgo-calender.firebasestorage.app",
  messagingSenderId: "163730741115",
  appId:             "1:163730741115:web:73a06d5b1cf1a477734fde"
};

/* â”€â”€ AUTH â”€â”€ */
const SESSION_KEY='crm_auth_ok', SESSION_UID='crm_uid';
const TRIES_KEY='crm_tries', LOCK_KEY='crm_lock';
const MAX_TRIES=5, LOCK_MS=120000;

async function sha256(msg){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(msg));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function isAuth(){ return sessionStorage.getItem(SESSION_KEY)==='1'; }
function getLockRemaining(){ const l=localStorage.getItem(LOCK_KEY); return l?Math.max(0,parseInt(l)-Date.now()):0; }
function updateLockUI(){
  const rem=getLockRemaining();
  const errEl=document.getElementById('authError');
  const btn=document.getElementById('authBtn');
  if(rem>0){
    errEl.textContent=`ì ê¸ˆ ì¤‘ â€” ${Math.ceil(rem/1000)}ì´ˆ í›„ ì¬ì‹œë„`;
    btn.disabled=true;
    setTimeout(updateLockUI,1000);
  } else {
    if(btn.disabled && errEl.textContent.includes('ì ê¸ˆ')){ btn.disabled=false; errEl.textContent=''; }
  }
}
async function tryAuth(){
  if(getLockRemaining()>0) return;
  const idEl=document.getElementById('authIdInput'), pwEl=document.getElementById('authPwInput'), errEl=document.getElementById('authError');
  const userId=idEl.value.trim(), userPw=pwEl.value;
  idEl.classList.remove('error'); pwEl.classList.remove('error');
  if(!userId){ idEl.classList.add('error'); idEl.focus(); errEl.textContent='ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
  if(!userPw){ pwEl.classList.add('error'); pwEl.focus(); errEl.textContent='ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
  const btn=document.getElementById('authBtn');
  btn.disabled=true; btn.textContent='í™•ì¸ ì¤‘â€¦';
  try{
    const pwHash=await sha256(userPw);
    const tmpApp=initializeApp(firebaseConfig,'auth_tmp');
    const tmpDb=getFirestore(tmpApp);
    const uDoc=await getDoc(doc(tmpDb,'users',userId));
    if(uDoc.exists()&&uDoc.data().passwordHash===pwHash){
      sessionStorage.setItem(SESSION_KEY,'1'); sessionStorage.setItem(SESSION_UID,userId);
      localStorage.removeItem(TRIES_KEY); localStorage.removeItem(LOCK_KEY);
      document.getElementById('authOverlay').classList.add('hidden');
      initApp();
    } else {
      const tries=parseInt(localStorage.getItem(TRIES_KEY)||'0')+1;
      localStorage.setItem(TRIES_KEY,tries);
      pwEl.value=''; pwEl.classList.add('error');
      if(tries>=MAX_TRIES){ localStorage.setItem(LOCK_KEY,Date.now()+LOCK_MS); errEl.textContent='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'; updateLockUI(); }
      else errEl.textContent=`ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. (${MAX_TRIES-tries}íšŒ ë‚¨ìŒ)`;
      btn.disabled=false; btn.textContent='ë¡œê·¸ì¸';
    }
  } catch(e){ console.error(e); errEl.textContent='ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'; btn.disabled=false; btn.textContent='ë¡œê·¸ì¸'; }
}
document.getElementById('authBtn').addEventListener('click',tryAuth);
document.getElementById('authPwInput').addEventListener('keydown',e=>{ if(e.key==='Enter') tryAuth(); });
document.getElementById('authIdInput').addEventListener('keydown',e=>{ if(e.key==='Enter') document.getElementById('authPwInput').focus(); });

if(isAuth()){ document.getElementById('authOverlay').classList.add('hidden'); initApp(); }
else{ updateLockUI(); setTimeout(()=>document.getElementById('authIdInput').focus(),100); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initApp(){
  const app=initializeApp(firebaseConfig);
  const db=getFirestore(app);
  const clientsCol=collection(db,'crm_clients');
  const cCol=id=>collection(db,`crm_clients/${id}/consultations`);
  const eventsCol=collection(db,'events');  /* ìº˜ë¦°ë” DB */

  /* ìƒˆ íƒ­ ì»¬ë ‰ì…˜ */
  const vrCol =id=>collection(db,`crm_clients/${id}/visit_requests`);
  const repCol=id=>collection(db,`crm_clients/${id}/visit_reports`);
  const slCol =id=>collection(db,`crm_clients/${id}/sales_records`);

  let clients=[], filteredType='all', searchQuery='';
  let selectedClient=null, currentTab='info';
  let consultations=[], consultUnsub=null;
  let editingClientId=null, editingConsultId=null;
  /* ìƒˆ íƒ­ ìƒíƒœ */
  let visitReqs=[], visitReps=[], salesRecs=[];
  let vrUnsub=null, repUnsub=null, slUnsub=null;
  let editingVrId=null, editingRepId=null, editingSlId=null;

  /* theme */
  const savedTheme=localStorage.getItem('cal_theme');
  if(savedTheme==='light') document.documentElement.classList.add('light');
  document.getElementById('themeBtn').textContent=document.documentElement.classList.contains('light')?'â˜€ï¸':'ğŸŒ™';
  document.getElementById('themeBtn').addEventListener('click',()=>{
    const isL=document.documentElement.classList.toggle('light');
    localStorage.setItem('cal_theme',isL?'light':'dark');
    document.getElementById('themeBtn').textContent=isL?'â˜€ï¸':'ğŸŒ™';
  });

  /* toast */
  let toastTimer;
  function showToast(msg,type=''){
    const t=document.getElementById('toast');
    t.textContent=msg; t.className='toast '+(type||'');
    requestAnimationFrame(()=>t.classList.add('show'));
    clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),2600);
  }

  /* confirm */
  function showConfirm(title,text,icon='âš ï¸'){
    return new Promise(res=>{
      document.getElementById('confirmIcon').textContent=icon;
      document.getElementById('confirmTitle').textContent=title;
      document.getElementById('confirmText').textContent=text;
      document.getElementById('confirmOverlay').classList.add('open');
      const ok=document.getElementById('confirmOk'), cancel=document.getElementById('confirmCancel');
      function cleanup(){ document.getElementById('confirmOverlay').classList.remove('open'); ok.removeEventListener('click',onOk); cancel.removeEventListener('click',onCancel); }
      function onOk(){ cleanup(); res(true); }
      function onCancel(){ cleanup(); res(false); }
      ok.addEventListener('click',onOk); cancel.addEventListener('click',onCancel);
    });
  }

  function setLoading(on){ document.getElementById('loadingOverlay').classList.toggle('show',on); }

  /* constants */
  const TYPE_MAP={personal:'ê°œì¸',enter:'ì—”í„°',corp:'ê¸°ì—…',rental:'ë Œíƒˆ',unknown:'ë¯¸ì •'};
  const TYPE_CLASS={personal:'type-personal',enter:'type-enter',corp:'type-corp',rental:'type-rental',unknown:'type-unknown'};
  const CT_MAP={visit:'ë°©ë¬¸',remote:'ì›ê²©',rental:'ë Œíƒˆ',repair:'ë¬¸ì œí•´ê²°',as:'AS',simple:'ë‹¨ìˆœ',refund:'í™˜ë¶ˆ',design:'ë””ìì¸'};
  const CT_CLASS={visit:'ct-visit',remote:'ct-remote',rental:'ct-rental',repair:'ct-repair',as:'ct-as',simple:'ct-simple',refund:'ct-refund',design:'ct-design'};

  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function avatarChar(n){ return n?n.charAt(0):'?'; }
  function fmtDate(ts){
    if(!ts) return '';
    const d=ts.toDate?ts.toDate():new Date(ts);
    return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
  }
  function fmtDateTime(ts){
    if(!ts) return '';
    const d=ts.toDate?ts.toDate():new Date(ts);
    return `${fmtDate(ts)} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  function nowLocalStr(){
    const d=new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }

  /* â”€â”€ RENDER CLIENT LIST â”€â”€ */
  function getFiltered(){
    let list=[...clients];
    if(filteredType!=='all') list=list.filter(c=>c.type===filteredType);
    if(searchQuery){
      const q=searchQuery.toLowerCase();
      list=list.filter(c=>(c.name||'').toLowerCase().includes(q)||(c.nick||'').toLowerCase().includes(q)||(c.phone||'').includes(q));
    }
    return list;
  }

  function renderClientList(){
    const list=getFiltered();
    const el=document.getElementById('clientList');
    document.getElementById('clientCountBadge').textContent=`(${clients.length})`;
    if(!list.length){
      el.innerHTML=`<div class="empty-state">${clients.length?'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤':'ë“±ë¡ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤<br>ìƒë‹¨ì˜ + ê³ ê° ë“±ë¡ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”'}</div>`;
      return;
    }
    el.innerHTML=list.map(c=>`
      <div class="client-item${selectedClient&&selectedClient._id===c._id?' active':''}" data-id="${c._id}">
        <div class="client-avatar">${avatarChar(c.name)}</div>
        <div class="client-info">
          <div class="client-name">${esc(c.name||'(ì´ë¦„ ì—†ìŒ)')}${c.nick?` <span style="font-weight:400;color:var(--text-muted);font-size:11px;">/ ${esc(c.nick)}</span>`:''}</div>
          <div class="client-meta">${esc(c.phone||'')}${c.platform?' Â· '+esc(c.platform):''}</div>
        </div>
        <span class="type-chip ${TYPE_CLASS[c.type]||'type-unknown'}">${TYPE_MAP[c.type]||'ë¯¸ì •'}</span>
      </div>
    `).join('');
    el.querySelectorAll('.client-item').forEach(item=>item.addEventListener('click',()=>selectClient(item.dataset.id)));
  }

  /* â”€â”€ SELECT CLIENT â”€â”€ */
  function selectClient(id){
    selectedClient=clients.find(c=>c._id===id)||null;
    renderClientList();
    const noView=document.getElementById('noClientView');
    const detail=document.getElementById('clientDetail');
    if(!selectedClient){ noView.style.display='flex'; detail.style.display='none'; return; }
    noView.style.display='none'; detail.style.display='flex';
    document.getElementById('detailAvatar').textContent=avatarChar(selectedClient.name);
    document.getElementById('detailName').textContent=selectedClient.name||'(ì´ë¦„ ì—†ìŒ)';
    document.getElementById('detailNick').textContent=selectedClient.nick?`"${selectedClient.nick}"`:'';
    switchTab('info');
    loadConsultations(id);
    loadVisitReqs(id);
    loadVisitReps(id);
    loadSales(id);
  }

  /* â”€â”€ RENDER INFO â”€â”€ */
  function renderInfo(c){
    const field=(label,val)=>`<div class="info-field"><div class="info-field-label">${label}</div><div class="info-field-value${!val?' empty':''}">${val||'â€”'}</div></div>`;
    const fieldFull=(label,val)=>`<div class="info-field full"><div class="info-field-label">${label}</div><div class="info-field-value${!val?' empty':''}" style="white-space:pre-wrap;">${val?esc(val):'â€”'}</div></div>`;
    const sec=(t)=>`<div class="section-head">${t}</div>`;
    document.getElementById('infoGrid').innerHTML=`
      ${sec('ê¸°ë³¸ ì •ë³´')}
      ${field('êµ¬ë¶„',`<span class="type-chip ${TYPE_CLASS[c.type]||'type-unknown'}">${TYPE_MAP[c.type]||'ë¯¸ì •'}</span>`)}
      ${field('ì „í™”ë²ˆí˜¸',esc(c.phone))}
      ${sec('ë°©ì†¡ ì •ë³´')}
      ${field('í”Œë«í¼',esc(c.platform))}
      ${field('ë°©ì†¡ì£¼ì†Œ / ID',esc(c.streamId))}
      ${fieldFull('ë°©ì¢… ì£¼ì œ',c.streamTopic)}
      ${sec('ë°©ë¬¸ ì •ë³´')}
      ${fieldFull('ì£¼ì†Œ',c.address)}
      ${sec('ì¥ë¹„ ì •ë³´')}
      ${fieldFull('PC ì‚¬ì–‘',c.pcSpec)}
      ${fieldFull('ì¥ë¹„ ëª©ë¡',c.equipment)}
      ${sec('ë©”ëª¨')}
      ${fieldFull('íŠ¹ì´ì‚¬í•­',c.note)}
      <div class="info-field full" style="background:none;border:none;padding:4px 0 0;"><div class="info-field-label">ë“±ë¡ì¼</div><div class="info-field-value empty" style="font-size:11px;">${fmtDate(c.createdAt)}</div></div>
    `;
  }

  /* â”€â”€ TAB â”€â”€ */
  function switchTab(tab){
    currentTab=tab;
    document.querySelectorAll('.dtab').forEach(d=>d.classList.toggle('active',d.dataset.tab===tab));
    document.getElementById('tabInfo').style.display     =tab==='info'     ?'block':'none';
    document.getElementById('tabConsult').style.display  =tab==='consult'  ?'flex' :'none';
    document.getElementById('tabVisitReq').style.display =tab==='visit_req'?'flex' :'none';
    document.getElementById('tabVisitRep').style.display =tab==='visit_rep'?'flex' :'none';
    document.getElementById('tabSales').style.display    =tab==='sales'    ?'flex' :'none';
    if(tab==='info'&&selectedClient) renderInfo(selectedClient);
  }
  document.querySelectorAll('.dtab').forEach(d=>d.addEventListener('click',()=>switchTab(d.dataset.tab)));

  /* â”€â”€ LOAD CONSULTATIONS â”€â”€ */
  function loadConsultations(clientId){
    if(consultUnsub){ consultUnsub(); consultUnsub=null; }
    const q=query(cCol(clientId),orderBy('createdAt','desc'));
    consultUnsub=onSnapshot(q,snap=>{
      consultations=snap.docs.map(d=>({_id:d.id,...d.data()}));
      document.getElementById('consultTabCount').textContent=consultations.length?`(${consultations.length})`:'';
      document.getElementById('consultCountLabel').textContent=`ì´ ${consultations.length}ê±´ì˜ ìƒë‹´`;
      renderConsultList();
    });
  }

  function renderConsultList(){
    const el=document.getElementById('consultList');
    if(!consultations.length){ el.innerHTML=`<div class="consult-empty">ì•„ì§ ë“±ë¡ëœ ìƒë‹´ì´ ì—†ìŠµë‹ˆë‹¤</div>`; return; }
    el.innerHTML=consultations.map(c=>`
      <div class="consult-card" data-cid="${c._id}">
        <div class="consult-card-header">
          <div>
            <div class="consult-card-title">${esc(c.title||'(ì œëª© ì—†ìŒ)')}</div>
            <div class="consult-card-meta">
              <span class="consult-type-chip ${CT_CLASS[c.type]||'ct-simple'}">${CT_MAP[c.type]||c.type||''}</span>
              ${c.counselor?`<span style="font-size:10px;font-family:var(--font-mono);color:var(--text-muted);">ë‹´ë‹¹: ${esc(c.counselor)}</span>`:''}
            </div>
          </div>
          <div class="consult-date-badge">${fmtDate(c.createdAt)}</div>
        </div>
        ${c.content?`<div class="consult-card-body">${esc(c.content)}</div>`:''}
        <div class="consult-card-footer">
          <span class="consult-counselor">${c.counselor?'ğŸ‘¤ '+esc(c.counselor):''}</span>
          <span class="consult-entry-count">ğŸ’¬ ${(c.entries||[]).length}ê±´</span>
        </div>
      </div>
    `).join('');
    el.querySelectorAll('.consult-card').forEach(card=>card.addEventListener('click',()=>openConsultDetail(card.dataset.cid)));
  }

  /* â”€â”€ CONSULT DETAIL â”€â”€ */
  function openConsultDetail(cid){
    const c=consultations.find(x=>x._id===cid); if(!c) return;
    editingConsultId=cid;
    document.getElementById('cdTitle').textContent=c.title||'(ì œëª© ì—†ìŒ)';
    document.getElementById('cdMeta').innerHTML=`
      <span class="consult-type-chip ${CT_CLASS[c.type]||'ct-simple'}" style="font-size:10px;">${CT_MAP[c.type]||''}</span>
      ${c.counselor?`<span style="font-size:10px;font-family:var(--font-mono);color:var(--text-muted);">ë‹´ë‹¹: ${esc(c.counselor)}</span>`:''}
      <span style="font-size:10px;font-family:var(--font-mono);color:var(--text-muted);">${fmtDate(c.createdAt)}</span>
    `;
    document.getElementById('cdSummary').textContent=c.content||'(ì´ˆê¸° ìƒë‹´ ë‚´ìš© ì—†ìŒ)';
    renderTimeline(c.entries||[]);
    document.getElementById('cdEntryTime').value=nowLocalStr();
    document.getElementById('cdEntryText').value='';
    document.getElementById('consultDetailModal').classList.add('open');
  }

  function renderTimeline(entries){
    const el=document.getElementById('cdTimeline');
    if(!entries.length){ el.innerHTML=`<div style="color:var(--text-muted);font-size:13px;padding:6px 0 12px;">ì•„ì§ ìƒë‹´ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>`; return; }
    const sorted=[...entries].sort((a,b)=>{
      const ta=a.time||a.createdAt||0, tb=b.time||b.createdAt||0;
      const da=ta.toDate?ta.toDate():new Date(ta), db2=tb.toDate?tb.toDate():new Date(tb);
      return da-db2;
    });
    el.innerHTML=sorted.map(e=>`
      <div class="tl-item">
        <div class="tl-line"><div class="tl-dot"></div><div class="tl-connector"></div></div>
        <div class="tl-content">
          <div class="tl-time">${fmtDateTime(e.time||e.createdAt)}</div>
          <div class="tl-bubble">${esc(e.text||'')}</div>
          ${e.author?`<div class="tl-author">â€” ${esc(e.author)}</div>`:''}
        </div>
      </div>
    `).join('');
  }

  /* timeline entry submit */
  document.getElementById('cdEntrySubmit').addEventListener('click', async ()=>{
    if(!selectedClient||!editingConsultId) return;
    const text=document.getElementById('cdEntryText').value.trim();
    if(!text){ showToast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”','error'); return; }
    const timeVal=document.getElementById('cdEntryTime').value;
    const entry={ text, author:sessionStorage.getItem(SESSION_UID)||'', time:timeVal?new Date(timeVal):new Date(), createdAt:new Date() };
    const btn=document.getElementById('cdEntrySubmit');
    btn.disabled=true; btn.textContent='â€¦';
    try{
      const cdoc=doc(db,`crm_clients/${selectedClient._id}/consultations`,editingConsultId);
      await updateDoc(cdoc,{ entries:arrayUnion(entry) });
      document.getElementById('cdEntryText').value='';
      document.getElementById('cdEntryTime').value=nowLocalStr();
      const snap=await getDoc(cdoc);
      const updated={_id:snap.id,...snap.data()};
      consultations=consultations.map(c=>c._id===editingConsultId?updated:c);
      renderTimeline(updated.entries||[]);
      showToast('ìƒë‹´ ë‚´ìš©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤','success');
    } catch(e){ console.error(e); showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤','error'); }
    btn.disabled=false; btn.textContent='ë“±ë¡';
  });

  /* delete consult */
  document.getElementById('cdDeleteConsult').addEventListener('click', async ()=>{
    if(!selectedClient||!editingConsultId) return;
    const ok=await showConfirm('ìƒë‹´ ì‚­ì œ','ì´ ìƒë‹´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?','ğŸ—‘ï¸');
    if(!ok) return;
    try{
      await deleteDoc(doc(db,`crm_clients/${selectedClient._id}/consultations`,editingConsultId));
      document.getElementById('consultDetailModal').classList.remove('open');
      showToast('ìƒë‹´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    } catch(e){ showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤','error'); }
  });

  /* â”€â”€ FIREBASE LISTENER â”€â”€ */
  setLoading(true);
  const loadTO=setTimeout(()=>{ setLoading(false); },10000);
  onSnapshot(query(clientsCol,orderBy('createdAt','desc')),snap=>{
    clearTimeout(loadTO);
    clients=snap.docs.map(d=>({_id:d.id,...d.data()}));
    setLoading(false);
    renderClientList();
    if(selectedClient){ const updated=clients.find(c=>c._id===selectedClient._id); if(updated){ selectedClient=updated; if(currentTab==='info') renderInfo(updated); } }
  },err=>{ clearTimeout(loadTO); setLoading(false); console.error(err); showToast('DB ì—°ê²° ì˜¤ë¥˜','error'); });

  /* filter/search */
  document.querySelectorAll('.cf-btn').forEach(btn=>btn.addEventListener('click',()=>{
    filteredType=btn.dataset.type;
    document.querySelectorAll('.cf-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    renderClientList();
  }));
  document.getElementById('searchInput').addEventListener('input',e=>{ searchQuery=e.target.value; renderClientList(); });

  /* â”€â”€ CLIENT MODAL â”€â”€ */
  function openClientModal(client=null){
    editingClientId=client?client._id:null;
    document.getElementById('clientModalTitle').textContent=client?'ê³ ê° ì •ë³´ ìˆ˜ì •':'ê³ ê° ë“±ë¡';
    document.getElementById('fName').value=client?.name||'';
    document.getElementById('fNick').value=client?.nick||'';
    document.getElementById('fPhone').value=client?.phone||'';
    document.getElementById('fType').value=client?.type||'unknown';
    document.getElementById('fPlatform').value=client?.platform||'';
    document.getElementById('fStreamId').value=client?.streamId||'';
    document.getElementById('fStreamTopic').value=client?.streamTopic||'';
    document.getElementById('fAddress').value=client?.address||'';
    document.getElementById('fPcSpec').value=client?.pcSpec||'';
    document.getElementById('fEquipment').value=client?.equipment||'';
    document.getElementById('fNote').value=client?.note||'';
    document.getElementById('clientModal').classList.add('open');
    setTimeout(()=>document.getElementById('fName').focus(),120);
  }
  function closeClientModal(){ document.getElementById('clientModal').classList.remove('open'); }

  document.getElementById('addClientBtn').addEventListener('click',()=>openClientModal());
  document.getElementById('editClientBtn').addEventListener('click',()=>{ if(selectedClient) openClientModal(selectedClient); });
  document.getElementById('clientModalClose').addEventListener('click',closeClientModal);
  document.getElementById('clientModalCancel').addEventListener('click',closeClientModal);

  document.getElementById('clientModalSave').addEventListener('click', async ()=>{
    const name=document.getElementById('fName').value.trim();
    if(!name){ document.getElementById('fName').classList.add('error'); setTimeout(()=>document.getElementById('fName').classList.remove('error'),600); return; }
    const data={
      name, nick:document.getElementById('fNick').value.trim(),
      phone:document.getElementById('fPhone').value.trim(),
      type:document.getElementById('fType').value,
      platform:document.getElementById('fPlatform').value.trim(),
      streamId:document.getElementById('fStreamId').value.trim(),
      streamTopic:document.getElementById('fStreamTopic').value.trim(),
      address:document.getElementById('fAddress').value.trim(),
      pcSpec:document.getElementById('fPcSpec').value.trim(),
      equipment:document.getElementById('fEquipment').value.trim(),
      note:document.getElementById('fNote').value.trim(),
    };
    const saveBtn=document.getElementById('clientModalSave');
    saveBtn.disabled=true; saveBtn.textContent='ì €ì¥ ì¤‘â€¦';
    try{
      if(editingClientId){
        await updateDoc(doc(db,'crm_clients',editingClientId),data);
        showToast('ê³ ê° ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤','success');
      } else {
        data.createdAt=serverTimestamp();
        const ref=await addDoc(clientsCol,data);
        showToast('ê³ ê°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤','success');
        setTimeout(()=>{ const nc=clients.find(c=>c._id===ref.id); if(nc) selectClient(nc._id); },800);
      }
      closeClientModal();
    } catch(e){ console.error(e); showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤','error'); }
    saveBtn.disabled=false; saveBtn.textContent='ì €ì¥';
  });

  /* delete client */
  document.getElementById('deleteClientBtn').addEventListener('click', async ()=>{
    if(!selectedClient) return;
    const ok=await showConfirm('ê³ ê° ì‚­ì œ',`"${selectedClient.name}" ê³ ê°ê³¼ ëª¨ë“  ìƒë‹´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,'ğŸ—‘ï¸');
    if(!ok) return;
    try{
      const cSnap=await getDocs(cCol(selectedClient._id));
      for(const d of cSnap.docs) await deleteDoc(d.ref);
      await deleteDoc(doc(db,'crm_clients',selectedClient._id));
      selectedClient=null;
      document.getElementById('noClientView').style.display='flex';
      document.getElementById('clientDetail').style.display='none';
      showToast('ê³ ê°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    } catch(e){ console.error(e); showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤','error'); }
  });

  /* â”€â”€ NEW CONSULT MODAL â”€â”€ */
  function closeConsultModal(){ document.getElementById('consultModal').classList.remove('open'); }
  document.getElementById('newConsultBtn').addEventListener('click',()=>{
    document.getElementById('cTitle').value='';
    document.getElementById('cType').value='visit';
    document.getElementById('cCounselor').value=sessionStorage.getItem(SESSION_UID)||'';
    document.getElementById('cContent').value='';
    document.getElementById('consultModal').classList.add('open');
    setTimeout(()=>document.getElementById('cTitle').focus(),120);
  });
  document.getElementById('consultModalClose').addEventListener('click',closeConsultModal);
  document.getElementById('consultModalCancel').addEventListener('click',closeConsultModal);

  document.getElementById('consultModalSave').addEventListener('click', async ()=>{
    if(!selectedClient) return;
    const title=document.getElementById('cTitle').value.trim();
    if(!title){ document.getElementById('cTitle').classList.add('error'); setTimeout(()=>document.getElementById('cTitle').classList.remove('error'),600); return; }
    const data={
      title, type:document.getElementById('cType').value,
      counselor:document.getElementById('cCounselor').value.trim(),
      content:document.getElementById('cContent').value.trim(),
      createdAt:serverTimestamp(), entries:[]
    };
    const saveBtn=document.getElementById('consultModalSave');
    saveBtn.disabled=true; saveBtn.textContent='ë“±ë¡ ì¤‘â€¦';
    try{
      const ref=await addDoc(cCol(selectedClient._id),data);
      showToast('ìƒë‹´ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤','success');
      closeConsultModal();
      switchTab('consult');
      setTimeout(()=>{ const nc=consultations.find(c=>c._id===ref.id); if(nc) openConsultDetail(nc._id); },700);
    } catch(e){ console.error(e); showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤','error'); }
    saveBtn.disabled=false; saveBtn.textContent='ë“±ë¡';
  });

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ìº˜ë¦°ë” ê²€ìƒ‰ ê³µí†µ ìœ í‹¸
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function searchCalendarEvents(query){
    if(!query||query.length<1) return [];
    const snap=await getDocs(eventsCol);
    const q=query.toLowerCase();
    return snap.docs
      .map(d=>({_id:d.id,...d.data()}))
      .filter(ev=>{
        if(ev.color!=='gold') return false; /* ë°©ë¬¸ì˜ë¢°(gold)ë§Œ */
        const hay=[ev.title||'',ev.startDate||'',ev.gold?.name||'',ev.name||''].join(' ').toLowerCase();
        return hay.includes(q);
      })
      .sort((a,b)=>(b.startDate||'').localeCompare(a.startDate||''))
      .slice(0,10);
  }

  function renderCalResults(events, containerEl, onSelect){
    if(!events.length){ containerEl.innerHTML='<div style="padding:8px 12px;color:var(--text-muted);font-size:12px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>'; containerEl.style.display=''; return; }
    containerEl.innerHTML=events.map(ev=>`
      <div class="cal-result-item" data-id="${ev._id}">
        <div class="cal-result-title">${esc(ev.title||'(ì œëª© ì—†ìŒ)')}</div>
        <div class="cal-result-meta">${ev.startDate||''} Â· ${esc(ev.gold?.name||ev.name||'')} ${ev.gold?.phone?'Â· '+esc(ev.gold.phone):''}</div>
      </div>`).join('');
    containerEl.style.display='';
    containerEl.querySelectorAll('.cal-result-item').forEach(item=>{
      item.addEventListener('click',()=>{ onSelect(events.find(e=>e._id===item.dataset.id)); });
    });
  }

  function setupCalSearch(searchInputId, resultsId, onSelect){
    let timer;
    document.getElementById(searchInputId).addEventListener('input',e=>{
      clearTimeout(timer);
      const v=e.target.value.trim();
      const resEl=document.getElementById(resultsId);
      if(!v){ resEl.style.display='none'; resEl.innerHTML=''; return; }
      resEl.innerHTML='<div class="cal-loading">ê²€ìƒ‰ ì¤‘â€¦</div>'; resEl.style.display='';
      timer=setTimeout(async()=>{
        const evs=await searchCalendarEvents(v);
        renderCalResults(evs,resEl,onSelect);
      },350);
    });
  }

  function fmtAmount(n){ if(!n) return ''; return Number(n).toLocaleString('ko-KR')+'ì›'; }

  function showLightbox(src){ document.getElementById('lightboxImg').src=src; document.getElementById('lightbox').classList.add('open'); }
  document.getElementById('lightbox').addEventListener('click',()=>document.getElementById('lightbox').classList.remove('open'));

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë°©ë¬¸ì˜ë¢° íƒ­
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function loadVisitReqs(clientId){
    if(vrUnsub){ vrUnsub(); vrUnsub=null; }
    vrUnsub=onSnapshot(query(vrCol(clientId),orderBy('createdAt','desc')),snap=>{
      visitReqs=snap.docs.map(d=>({_id:d.id,...d.data()}));
      document.getElementById('visitReqTabCount').textContent=visitReqs.length?`(${visitReqs.length})`:'';
      document.getElementById('visitReqCountLabel').textContent=`ì´ ${visitReqs.length}ê±´`;
      renderVisitReqList();
    });
  }

  const STATUS_LABEL={pending:'ì˜ˆì •',done:'ì™„ë£Œ',cancel:'ì·¨ì†Œ'};
  const STATUS_CLASS={pending:'status-pending',done:'status-done',cancel:'status-cancel'};
  const VR_TYPE_LABEL={visit:'ë°©ë¬¸',remote:'ì›ê²©',rental:'ë Œíƒˆ'};
  const REP_RESULT_LABEL={success:'ì •ìƒ ì™„ë£Œ',partial:'ë¶€ë¶„ ì™„ë£Œ',fail:'ë¯¸ì™„ë£Œ',followup:'í›„ì† í•„ìš”'};
  const SL_TYPE_LABEL={visit:'ë°©ë¬¸ì˜ë¢°',remote:'ì›ê²©',rental:'ë Œíƒˆ',design:'ë””ìì¸',other:'ê¸°íƒ€'};
  const SL_PAY_LABEL={paid:'ê²°ì œì™„ë£Œ',partial:'ë¶€ë¶„ê²°ì œ',unpaid:'ë¯¸ê²°ì œ',refunded:'í™˜ë¶ˆ'};
  const SL_PAY_CLASS={paid:'status-done',partial:'status-pending',unpaid:'status-cancel',refunded:'status-cancel'};

  function renderVisitReqList(){
    const el=document.getElementById('visitReqList');
    if(!visitReqs.length){ el.innerHTML='<div class="generic-empty">ë“±ë¡ëœ ë°©ë¬¸ì˜ë¢°ê°€ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
    el.innerHTML=visitReqs.map(r=>`
      <div class="item-card" data-id="${r._id}">
        <div class="item-card-header">
          <div>
            <div class="item-card-title">${esc(r.title||'(ì œëª© ì—†ìŒ)')}</div>
            <div class="item-card-meta">
              <span class="status-chip ${STATUS_CLASS[r.status]||'status-pending'}">${STATUS_LABEL[r.status]||'ì˜ˆì •'}</span>
              <span>${VR_TYPE_LABEL[r.type]||'ë°©ë¬¸'}</span>
              ${r.calEventId?'<span class="cal-linked-badge" style="font-size:9px;padding:1px 6px;">ğŸ“… ìº˜ë¦°ë” ì—°ë™</span>':''}
            </div>
          </div>
          <div class="item-date">${r.visitDate||fmtDate(r.createdAt)}</div>
        </div>
        ${r.calEstimate?`<div class="item-card-footer"><span>ê²¬ì  ${fmtAmount(r.calEstimate)}</span>${r.calBalance?`<span style="color:var(--red);">ì”ê¸ˆ ${fmtAmount(r.calBalance)}</span>`:''}</div>`:''}
      </div>`).join('');
    el.querySelectorAll('.item-card').forEach(c=>c.addEventListener('click',()=>openVisitReqModal(visitReqs.find(r=>r._id===c.dataset.id))));
  }

  /* ë°©ë¬¸ì˜ë¢° ëª¨ë‹¬ */
  let vrLinkedEvent=null;

  function openVisitReqModal(item=null){
    editingVrId=item?item._id:null;
    vrLinkedEvent=null;
    document.getElementById('visitReqModalTitle').textContent=item?'ë°©ë¬¸ì˜ë¢° ìˆ˜ì •':'ë°©ë¬¸ì˜ë¢° ë“±ë¡';
    document.getElementById('visitReqDeleteBtn').style.display=item?'':'none';
    document.getElementById('vrCalSearch').value='';
    document.getElementById('vrCalResults').style.display='none';
    document.getElementById('vrCalResults').innerHTML='';
    document.getElementById('vrLinkedBadge').style.display='none';
    document.getElementById('vrCalInfo').style.display='none';
    document.getElementById('vrDate').value=item?.visitDate||new Date().toISOString().slice(0,10);
    document.getElementById('vrStatus').value=item?.status||'pending';
    document.getElementById('vrAssignee').value=item?.assignee||sessionStorage.getItem('crm_display_name')||'';
    document.getElementById('vrType').value=item?.type||'visit';
    document.getElementById('vrTitle').value=item?.title||'';
    document.getElementById('vrAddress').value=item?.address||selectedClient?.address||'';
    document.getElementById('vrContent').value=item?.content||'';
    if(item?.calEventId){
      vrLinkedEvent={_id:item.calEventId,title:item.calTitle};
      document.getElementById('vrLinkedTitle').textContent=item.calTitle||item.calEventId;
      document.getElementById('vrLinkedBadge').style.display='';
      if(item.calEstimate||item.calBalance){
        document.getElementById('vrCalName').textContent=item.calName||'â€”';
        document.getElementById('vrCalPhone').textContent=item.calPhone||'â€”';
        document.getElementById('vrCalEstimate').textContent=item.calEstimate?fmtAmount(item.calEstimate):'â€”';
        document.getElementById('vrCalBalance').textContent=item.calBalance?fmtAmount(item.calBalance):'ì—†ìŒ';
        document.getElementById('vrQuoteImages').innerHTML=(item.calQuoteImgs||[]).map(img=>`<img class="quote-img-thumb" src="${img.data||img}" alt="ê²¬ì ì„œ">`).join('');
        document.getElementById('vrQuoteImages').querySelectorAll('.quote-img-thumb').forEach(img=>img.addEventListener('click',()=>showLightbox(img.src)));
        document.getElementById('vrCalInfo').style.display='';
      }
    }
    document.getElementById('visitReqModal').classList.add('open');
    setTimeout(()=>document.getElementById('vrTitle').focus(),100);
  }

  setupCalSearch('vrCalSearch','vrCalResults',(ev)=>{
    vrLinkedEvent=ev;
    document.getElementById('vrCalResults').style.display='none';
    document.getElementById('vrLinkedTitle').textContent=ev.title||ev._id;
    document.getElementById('vrLinkedBadge').style.display='';
    /* ìº˜ë¦°ë” ë°ì´í„° ìë™ ì±„ìš°ê¸° */
    document.getElementById('vrDate').value=ev.startDate||document.getElementById('vrDate').value;
    if(!document.getElementById('vrTitle').value) document.getElementById('vrTitle').value=ev.title||'';
    if(ev.gold?.name||ev.name) document.getElementById('vrAddress').value=document.getElementById('vrAddress').value||ev.gold?.address||ev.address||'';
    const name=ev.gold?.name||ev.name||''; const phone=ev.gold?.phone||ev.phone||'';
    const est=ev.gold?.estimate_amount||''; const bal=ev.gold?.balance_amount||'';
    const imgs=ev.quoteImgs||[];
    document.getElementById('vrCalName').textContent=name||'â€”';
    document.getElementById('vrCalPhone').textContent=phone||'â€”';
    document.getElementById('vrCalEstimate').textContent=est?fmtAmount(est):'â€”';
    document.getElementById('vrCalBalance').textContent=bal?fmtAmount(bal):'ì—†ìŒ';
    document.getElementById('vrQuoteImages').innerHTML=imgs.map(img=>`<img class="quote-img-thumb" src="${img.data||img}" alt="ê²¬ì ì„œ">`).join('');
    document.getElementById('vrQuoteImages').querySelectorAll('.quote-img-thumb').forEach(img=>img.addEventListener('click',()=>showLightbox(img.src)));
    document.getElementById('vrCalInfo').style.display='';
  });

  document.getElementById('vrUnlinkBtn').addEventListener('click',()=>{
    vrLinkedEvent=null;
    document.getElementById('vrLinkedBadge').style.display='none';
    document.getElementById('vrCalInfo').style.display='none';
  });

  document.getElementById('visitReqDeleteBtn').addEventListener('click',async()=>{
    if(!editingVrId||!selectedClient) return;
    const ok=await showConfirm('ë°©ë¬¸ì˜ë¢° ì‚­ì œ','ì´ ë°©ë¬¸ì˜ë¢°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?','ğŸ—‘ï¸');
    if(!ok) return;
    await deleteDoc(doc(db,`crm_clients/${selectedClient._id}/visit_requests`,editingVrId));
    document.getElementById('visitReqModal').classList.remove('open');
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  });

  document.getElementById('visitReqSaveBtn').addEventListener('click',async()=>{
    const title=document.getElementById('vrTitle').value.trim();
    if(!title){ document.getElementById('vrTitle').classList.add('error'); setTimeout(()=>document.getElementById('vrTitle').classList.remove('error'),600); return; }
    if(!selectedClient) return;
    const btn=document.getElementById('visitReqSaveBtn');
    btn.disabled=true; btn.textContent='ì €ì¥ ì¤‘â€¦';
    const data={
      title,
      visitDate:document.getElementById('vrDate').value,
      status:document.getElementById('vrStatus').value,
      assignee:document.getElementById('vrAssignee').value.trim(),
      type:document.getElementById('vrType').value,
      address:document.getElementById('vrAddress').value.trim(),
      content:document.getElementById('vrContent').value.trim(),
    };
    if(vrLinkedEvent){
      data.calEventId=vrLinkedEvent._id;
      data.calTitle=vrLinkedEvent.title||'';
      data.calName=document.getElementById('vrCalName').textContent;
      data.calPhone=document.getElementById('vrCalPhone').textContent;
      const estText=document.getElementById('vrCalEstimate').textContent;
      data.calEstimate=estText&&estText!=='â€”'?estText.replace(/[^0-9]/g,''):'';
      const balText=document.getElementById('vrCalBalance').textContent;
      data.calBalance=balText&&balText!=='ì—†ìŒ'&&balText!=='â€”'?balText.replace(/[^0-9]/g,''):'';
      /* ê²¬ì ì„œ ì´ë¯¸ì§€ëŠ” eventIdë¡œ ì¡°íšŒì‹œ ì›ë³¸ì—ì„œ ê°€ì ¸ì˜¤ë¯€ë¡œ ì €ì¥ ì•ˆ í•¨ (ìš©ëŸ‰ ì ˆì•½) */
    }
    try{
      if(editingVrId){ await updateDoc(doc(db,`crm_clients/${selectedClient._id}/visit_requests`,editingVrId),data); showToast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤','success'); }
      else { data.createdAt=serverTimestamp(); await addDoc(vrCol(selectedClient._id),data); showToast('ë°©ë¬¸ì˜ë¢°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤','success'); }
      document.getElementById('visitReqModal').classList.remove('open');
    } catch(e){ console.error(e); showToast('ì €ì¥ ì‹¤íŒ¨','error'); }
    btn.disabled=false; btn.textContent='ì €ì¥';
  });

  document.getElementById('newVisitReqBtn').addEventListener('click',()=>openVisitReqModal());
  document.getElementById('visitReqModalClose').addEventListener('click',()=>document.getElementById('visitReqModal').classList.remove('open'));
  document.getElementById('visitReqCancelBtn').addEventListener('click',()=>document.getElementById('visitReqModal').classList.remove('open'));

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë°©ë¬¸ë³´ê³  íƒ­
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function loadVisitReps(clientId){
    if(repUnsub){ repUnsub(); repUnsub=null; }
    repUnsub=onSnapshot(query(repCol(clientId),orderBy('createdAt','desc')),snap=>{
      visitReps=snap.docs.map(d=>({_id:d.id,...d.data()}));
      document.getElementById('visitRepTabCount').textContent=visitReps.length?`(${visitReps.length})`:'';
      document.getElementById('visitRepCountLabel').textContent=`ì´ ${visitReps.length}ê±´`;
      renderVisitRepList();
    });
  }

  function renderVisitRepList(){
    const el=document.getElementById('visitRepList');
    if(!visitReps.length){ el.innerHTML='<div class="generic-empty">ë“±ë¡ëœ ë°©ë¬¸ë³´ê³ ê°€ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
    el.innerHTML=visitReps.map(r=>`
      <div class="item-card" data-id="${r._id}">
        <div class="item-card-header">
          <div>
            <div class="item-card-title">${esc(r.title||'(ì œëª© ì—†ìŒ)')}</div>
            <div class="item-card-meta">
              <span class="status-chip ${r.result==='success'?'status-done':r.result==='fail'?'status-cancel':'status-pending'}">${REP_RESULT_LABEL[r.result]||'ì™„ë£Œ'}</span>
              ${r.author?`<span>ì‘ì„±: ${esc(r.author)}</span>`:''}
              ${r.calEventId?'<span class="cal-linked-badge" style="font-size:9px;padding:1px 6px;">ğŸ“… ìº˜ë¦°ë” ì—°ë™</span>':''}
            </div>
          </div>
          <div class="item-date">${r.visitDate||fmtDate(r.createdAt)}</div>
        </div>
        ${r.content?`<div class="item-card-body">${esc(r.content).slice(0,80)}â€¦</div>`:''}
      </div>`).join('');
    el.querySelectorAll('.item-card').forEach(c=>c.addEventListener('click',()=>openVisitRepModal(visitReps.find(r=>r._id===c.dataset.id))));
  }

  let repLinkedEvent=null;

  function openVisitRepModal(item=null){
    editingRepId=item?item._id:null;
    repLinkedEvent=null;
    document.getElementById('visitRepModalTitle').textContent=item?'ë°©ë¬¸ë³´ê³  ìˆ˜ì •':'ë°©ë¬¸ë³´ê³  ë“±ë¡';
    document.getElementById('visitRepDeleteBtn').style.display=item?'':'none';
    document.getElementById('repCalSearch').value='';
    document.getElementById('repCalResults').style.display='none';
    document.getElementById('repCalResults').innerHTML='';
    document.getElementById('repLinkedBadge').style.display='none';
    document.getElementById('repCalInfo').style.display='none';
    document.getElementById('repDate').value=item?.visitDate||new Date().toISOString().slice(0,10);
    document.getElementById('repAuthor').value=item?.author||sessionStorage.getItem('crm_display_name')||'';
    document.getElementById('repTitle').value=item?.title||'';
    document.getElementById('repResult').value=item?.result||'success';
    document.getElementById('repContent').value=item?.content||'';
    document.getElementById('repNote').value=item?.note||'';
    if(item?.calEventId){
      repLinkedEvent={_id:item.calEventId,title:item.calTitle};
      document.getElementById('repLinkedTitle').textContent=item.calTitle||item.calEventId;
      document.getElementById('repLinkedBadge').style.display='';
      if(item.calName||item.calPhone){
        document.getElementById('repCalName').textContent=item.calName||'â€”';
        document.getElementById('repCalPhone').textContent=item.calPhone||'â€”';
        document.getElementById('repCalInfo').style.display='';
      }
    }
    document.getElementById('visitRepModal').classList.add('open');
    setTimeout(()=>document.getElementById('repTitle').focus(),100);
  }

  setupCalSearch('repCalSearch','repCalResults',(ev)=>{
    repLinkedEvent=ev;
    document.getElementById('repCalResults').style.display='none';
    document.getElementById('repLinkedTitle').textContent=ev.title||ev._id;
    document.getElementById('repLinkedBadge').style.display='';
    document.getElementById('repDate').value=ev.startDate||document.getElementById('repDate').value;
    if(!document.getElementById('repTitle').value) document.getElementById('repTitle').value=(ev.title||'')+ ' ë°©ë¬¸ë³´ê³ ';
    document.getElementById('repCalName').textContent=ev.gold?.name||ev.name||'â€”';
    document.getElementById('repCalPhone').textContent=ev.gold?.phone||ev.phone||'â€”';
    document.getElementById('repCalInfo').style.display='';
  });

  document.getElementById('repUnlinkBtn').addEventListener('click',()=>{
    repLinkedEvent=null;
    document.getElementById('repLinkedBadge').style.display='none';
    document.getElementById('repCalInfo').style.display='none';
  });

  document.getElementById('visitRepDeleteBtn').addEventListener('click',async()=>{
    if(!editingRepId||!selectedClient) return;
    const ok=await showConfirm('ë°©ë¬¸ë³´ê³  ì‚­ì œ','ì´ ë°©ë¬¸ë³´ê³ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?','ğŸ—‘ï¸');
    if(!ok) return;
    await deleteDoc(doc(db,`crm_clients/${selectedClient._id}/visit_reports`,editingRepId));
    document.getElementById('visitRepModal').classList.remove('open');
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  });

  document.getElementById('visitRepSaveBtn').addEventListener('click',async()=>{
    const title=document.getElementById('repTitle').value.trim();
    if(!title){ document.getElementById('repTitle').classList.add('error'); setTimeout(()=>document.getElementById('repTitle').classList.remove('error'),600); return; }
    if(!selectedClient) return;
    const btn=document.getElementById('visitRepSaveBtn');
    btn.disabled=true; btn.textContent='ì €ì¥ ì¤‘â€¦';
    const data={
      title,
      visitDate:document.getElementById('repDate').value,
      author:document.getElementById('repAuthor').value.trim(),
      result:document.getElementById('repResult').value,
      content:document.getElementById('repContent').value.trim(),
      note:document.getElementById('repNote').value.trim(),
    };
    if(repLinkedEvent){
      data.calEventId=repLinkedEvent._id;
      data.calTitle=repLinkedEvent.title||'';
      data.calName=document.getElementById('repCalName').textContent;
      data.calPhone=document.getElementById('repCalPhone').textContent;
    }
    try{
      if(editingRepId){ await updateDoc(doc(db,`crm_clients/${selectedClient._id}/visit_reports`,editingRepId),data); showToast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤','success'); }
      else { data.createdAt=serverTimestamp(); await addDoc(repCol(selectedClient._id),data); showToast('ë°©ë¬¸ë³´ê³ ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤','success'); }
      document.getElementById('visitRepModal').classList.remove('open');
    } catch(e){ console.error(e); showToast('ì €ì¥ ì‹¤íŒ¨','error'); }
    btn.disabled=false; btn.textContent='ì €ì¥';
  });

  document.getElementById('newVisitRepBtn').addEventListener('click',()=>openVisitRepModal());
  document.getElementById('visitRepModalClose').addEventListener('click',()=>document.getElementById('visitRepModal').classList.remove('open'));
  document.getElementById('visitRepCancelBtn').addEventListener('click',()=>document.getElementById('visitRepModal').classList.remove('open'));

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ë§¤ì¶œê¸°ë¡ íƒ­
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function loadSales(clientId){
    if(slUnsub){ slUnsub(); slUnsub=null; }
    slUnsub=onSnapshot(query(slCol(clientId),orderBy('createdAt','desc')),snap=>{
      salesRecs=snap.docs.map(d=>({_id:d.id,...d.data()}));
      document.getElementById('salesTabCount').textContent=salesRecs.length?`(${salesRecs.length})`:'';
      document.getElementById('salesCountLabel').textContent=`ì´ ${salesRecs.length}ê±´`;
      renderSalesSummary();
      renderSalesList();
    });
  }

  function renderSalesSummary(){
    const total=salesRecs.reduce((s,r)=>s+(Number(r.amount)||0),0);
    const refund=salesRecs.reduce((s,r)=>s+(Number(r.refund)||0),0);
    const net=total-refund;
    document.getElementById('salesSummary').innerHTML=`
      <div class="sales-sum-card"><div class="sales-sum-label">ì´ ë§¤ì¶œ</div><div class="sales-sum-value green">${fmtAmount(total)}</div></div>
      <div class="sales-sum-card"><div class="sales-sum-label">í™˜ë¶ˆ í•©ê³„</div><div class="sales-sum-value red">${refund?fmtAmount(refund):'ì—†ìŒ'}</div></div>
      <div class="sales-sum-card"><div class="sales-sum-label">ì‹¤ ë§¤ì¶œ</div><div class="sales-sum-value">${fmtAmount(net)}</div></div>
      <div class="sales-sum-card"><div class="sales-sum-label">ê±´ìˆ˜</div><div class="sales-sum-value">${salesRecs.length}ê±´</div></div>`;
  }

  function renderSalesList(){
    const el=document.getElementById('salesList');
    if(!salesRecs.length){ el.innerHTML='<div class="generic-empty">ë“±ë¡ëœ ë§¤ì¶œê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
    el.innerHTML=salesRecs.map(r=>`
      <div class="item-card" data-id="${r._id}">
        <div class="item-card-header">
          <div>
            <div class="item-card-title">${esc(r.title||'(ì œëª© ì—†ìŒ)')}</div>
            <div class="item-card-meta">
              <span class="status-chip ${SL_PAY_CLASS[r.payStatus]||'status-done'}">${SL_PAY_LABEL[r.payStatus]||'ê²°ì œì™„ë£Œ'}</span>
              <span>${SL_TYPE_LABEL[r.type]||''}</span>
              ${r.calEventId?'<span class="cal-linked-badge" style="font-size:9px;padding:1px 6px;">ğŸ“… ìº˜ë¦°ë” ì—°ë™</span>':''}
            </div>
          </div>
          <div class="item-date">${r.salesDate||fmtDate(r.createdAt)}</div>
        </div>
        <div class="item-card-footer">
          <span class="amount-badge">ğŸ’° ${fmtAmount(r.amount)}</span>
          ${r.balance?`<span class="amount-badge balance-badge">ì”ê¸ˆ ${fmtAmount(r.balance)}</span>`:''}
          ${r.refund?`<span class="amount-badge refund-badge">í™˜ë¶ˆ ${fmtAmount(r.refund)}</span>`:''}
        </div>
      </div>`).join('');
    el.querySelectorAll('.item-card').forEach(c=>c.addEventListener('click',()=>openSalesModal(salesRecs.find(r=>r._id===c.dataset.id))));
  }

  let slLinkedEvent=null;

  function openSalesModal(item=null){
    editingSlId=item?item._id:null;
    slLinkedEvent=null;
    document.getElementById('salesModalTitle').textContent=item?'ë§¤ì¶œ ìˆ˜ì •':'ë§¤ì¶œ ë“±ë¡';
    document.getElementById('salesDeleteBtn').style.display=item?'':'none';
    document.getElementById('slCalSearch').value='';
    document.getElementById('slCalResults').style.display='none';
    document.getElementById('slCalResults').innerHTML='';
    document.getElementById('slLinkedBadge').style.display='none';
    document.getElementById('slCalInfo').style.display='none';
    document.getElementById('slDate').value=item?.salesDate||new Date().toISOString().slice(0,10);
    document.getElementById('slType').value=item?.type||'visit';
    document.getElementById('slTitle').value=item?.title||'';
    document.getElementById('slAmount').value=item?.amount||'';
    document.getElementById('slBalance').value=item?.balance||'';
    document.getElementById('slRefund').value=item?.refund||'';
    document.getElementById('slPayStatus').value=item?.payStatus||'paid';
    document.getElementById('slNote').value=item?.note||'';
    if(item?.calEventId){
      slLinkedEvent={_id:item.calEventId,title:item.calTitle};
      document.getElementById('slLinkedTitle').textContent=item.calTitle||item.calEventId;
      document.getElementById('slLinkedBadge').style.display='';
      if(item.calEstimate){
        document.getElementById('slCalEstimate').textContent=fmtAmount(item.calEstimate);
        document.getElementById('slCalBalance').textContent=item.calBalance?fmtAmount(item.calBalance):'ì—†ìŒ';
        document.getElementById('slQuoteImages').innerHTML=(item.calQuoteImgs||[]).map(img=>`<img class="quote-img-thumb" src="${img.data||img}" alt="ê²¬ì ì„œ">`).join('');
        document.getElementById('slQuoteImages').querySelectorAll('.quote-img-thumb').forEach(img=>img.addEventListener('click',()=>showLightbox(img.src)));
        document.getElementById('slCalInfo').style.display='';
      }
    }
    document.getElementById('salesModal').classList.add('open');
    setTimeout(()=>document.getElementById('slTitle').focus(),100);
  }

  setupCalSearch('slCalSearch','slCalResults',(ev)=>{
    slLinkedEvent=ev;
    document.getElementById('slCalResults').style.display='none';
    document.getElementById('slLinkedTitle').textContent=ev.title||ev._id;
    document.getElementById('slLinkedBadge').style.display='';
    document.getElementById('slDate').value=ev.startDate||document.getElementById('slDate').value;
    if(!document.getElementById('slTitle').value) document.getElementById('slTitle').value=ev.title||'';
    const est=ev.gold?.estimate_amount||''; const bal=ev.gold?.balance_amount||'';
    const imgs=ev.quoteImgs||[];
    document.getElementById('slCalEstimate').textContent=est?fmtAmount(est):'â€”';
    document.getElementById('slCalBalance').textContent=bal?fmtAmount(bal):'ì—†ìŒ';
    document.getElementById('slQuoteImages').innerHTML=imgs.map(img=>`<img class="quote-img-thumb" src="${img.data||img}" alt="ê²¬ì ì„œ">`).join('');
    document.getElementById('slQuoteImages').querySelectorAll('.quote-img-thumb').forEach(img=>img.addEventListener('click',()=>showLightbox(img.src)));
    document.getElementById('slCalInfo').style.display='';
    /* ê²¬ì  ê¸ˆì•¡ ìë™ ì…ë ¥ */
    if(est&&!document.getElementById('slAmount').value) document.getElementById('slAmount').value=est.replace(/[^0-9]/g,'');
    if(bal&&!document.getElementById('slBalance').value) document.getElementById('slBalance').value=bal.replace(/[^0-9]/g,'');
  });

  document.getElementById('slUnlinkBtn').addEventListener('click',()=>{
    slLinkedEvent=null;
    document.getElementById('slLinkedBadge').style.display='none';
    document.getElementById('slCalInfo').style.display='none';
  });

  document.getElementById('salesDeleteBtn').addEventListener('click',async()=>{
    if(!editingSlId||!selectedClient) return;
    const ok=await showConfirm('ë§¤ì¶œ ì‚­ì œ','ì´ ë§¤ì¶œ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?','ğŸ—‘ï¸');
    if(!ok) return;
    await deleteDoc(doc(db,`crm_clients/${selectedClient._id}/sales_records`,editingSlId));
    document.getElementById('salesModal').classList.remove('open');
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  });

  document.getElementById('salesSaveBtn').addEventListener('click',async()=>{
    const title=document.getElementById('slTitle').value.trim();
    const amount=document.getElementById('slAmount').value;
    if(!title){ document.getElementById('slTitle').classList.add('error'); setTimeout(()=>document.getElementById('slTitle').classList.remove('error'),600); return; }
    if(!amount||isNaN(Number(amount))){ document.getElementById('slAmount').classList.add('error'); setTimeout(()=>document.getElementById('slAmount').classList.remove('error'),600); showToast('ë§¤ì¶œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”','error'); return; }
    if(!selectedClient) return;
    const btn=document.getElementById('salesSaveBtn');
    btn.disabled=true; btn.textContent='ì €ì¥ ì¤‘â€¦';
    const data={
      title,
      salesDate:document.getElementById('slDate').value,
      type:document.getElementById('slType').value,
      amount:Number(amount)||0,
      balance:Number(document.getElementById('slBalance').value)||0,
      refund:Number(document.getElementById('slRefund').value)||0,
      payStatus:document.getElementById('slPayStatus').value,
      note:document.getElementById('slNote').value.trim(),
    };
    if(slLinkedEvent){
      data.calEventId=slLinkedEvent._id;
      data.calTitle=slLinkedEvent.title||'';
      const estText=document.getElementById('slCalEstimate').textContent;
      data.calEstimate=estText&&estText!=='â€”'?estText.replace(/[^0-9]/g,''):'';
      const balText=document.getElementById('slCalBalance').textContent;
      data.calBalance=balText&&balText!=='ì—†ìŒ'&&balText!=='â€”'?balText.replace(/[^0-9]/g,''):'';
    }
    try{
      if(editingSlId){ await updateDoc(doc(db,`crm_clients/${selectedClient._id}/sales_records`,editingSlId),data); showToast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤','success'); }
      else { data.createdAt=serverTimestamp(); await addDoc(slCol(selectedClient._id),data); showToast('ë§¤ì¶œì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤','success'); }
      document.getElementById('salesModal').classList.remove('open');
    } catch(e){ console.error(e); showToast('ì €ì¥ ì‹¤íŒ¨','error'); }
    btn.disabled=false; btn.textContent='ì €ì¥';
  });

  document.getElementById('newSalesBtn').addEventListener('click',()=>openSalesModal());
  document.getElementById('salesModalClose').addEventListener('click',()=>document.getElementById('salesModal').classList.remove('open'));
  document.getElementById('salesCancelBtn').addEventListener('click',()=>document.getElementById('salesModal').classList.remove('open'));

  /* close detail modal */
  [document.getElementById('cdClose'),document.getElementById('cdClose2')].forEach(b=>b.addEventListener('click',()=>document.getElementById('consultDetailModal').classList.remove('open')));

  /* overlay click close */
  ['clientModal','consultModal','consultDetailModal','visitReqModal','visitRepModal','salesModal'].forEach(id=>{
    document.getElementById(id).addEventListener('click',e=>{ if(e.target.id===id) document.getElementById(id).classList.remove('open'); });
  });
}
</script>
</body>
</html>
