<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Ï∫òÎ¶∞Îçî</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  /* ÎßëÏùÄ Í≥†Îîï Ïö∞ÏÑ† Ìè∞Ìä∏ Ïä§ÌÉù */
  :root {
    --font-main: "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    --font-mono: 'DM Mono', "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", monospace;
  }
</style>
<style>
  /* ‚îÄ‚îÄ Î°úÍ∑∏Ïù∏ Ïò§Î≤ÑÎ†àÏù¥ ‚îÄ‚îÄ */
  #authOverlay {
    display:flex; position:fixed; inset:0; z-index:9999;
    background:var(--bg, #1a1207);
    align-items:center; justify-content:center;
    font-family:"Malgun Gothic","ÎßëÏùÄ Í≥†Îîï",sans-serif;
  }
  #authOverlay.hidden { display:none; }
  .auth-box {
    width:100%; max-width:360px; padding:40px 32px 36px;
    background:var(--surface, #231a0e);
    border:1px solid var(--border, rgba(200,176,138,0.2));
    border-radius:18px;
    box-shadow:0 24px 64px rgba(0,0,0,0.55);
    display:flex; flex-direction:column; align-items:center; gap:0;
  }
  .auth-logo {
    font-size:28px; margin-bottom:6px;
    letter-spacing:0.08em; color:var(--accent,#c8b08a);
    font-weight:700;
  }
  .auth-subtitle {
    font-size:11px; letter-spacing:0.18em;
    color:var(--text-muted,rgba(200,176,138,0.45));
    text-transform:uppercase; margin-bottom:32px;
  }
  .auth-label {
    width:100%; font-size:11px; letter-spacing:0.12em;
    color:var(--text-muted,rgba(200,176,138,0.45));
    text-transform:uppercase; margin-bottom:8px;
  }
  .auth-input {
    width:100%; padding:13px 16px; font-size:15px;
    background:var(--surface2,#2c2010);
    border:1.5px solid var(--border,rgba(200,176,138,0.2));
    border-radius:10px; color:var(--text,#f0e8d8);
    font-family:"Malgun Gothic","ÎßëÏùÄ Í≥†Îîï",sans-serif;
    outline:none; box-sizing:border-box;
    transition:border-color 0.2s;
    letter-spacing:0.15em;
  }
  .auth-input:focus { border-color:var(--accent,#c8b08a); }
  .auth-input.error { border-color:#c87a7a; animation:shake 0.35s ease; }
  @keyframes shake {
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-8px)}
    40%{transform:translateX(8px)}
    60%{transform:translateX(-5px)}
    80%{transform:translateX(5px)}
  }
  .auth-btn {
    width:100%; margin-top:14px; padding:14px;
    background:var(--accent,#c8b08a); color:#1a1207;
    border:none; border-radius:10px; font-size:14px; font-weight:700;
    font-family:"Malgun Gothic","ÎßëÏùÄ Í≥†Îîï",sans-serif;
    cursor:pointer; transition:all 0.2s; letter-spacing:0.08em;
  }
  .auth-btn:hover:not(:disabled) { background:#d4c09a; transform:translateY(-1px); }
  .auth-btn:disabled { opacity:0.45; cursor:not-allowed; transform:none; }
  .auth-error {
    margin-top:12px; font-size:12px; color:#c87a7a;
    text-align:center; min-height:18px; letter-spacing:0.03em;
  }
  .auth-lock-msg {
    margin-top:8px; font-size:11px;
    color:var(--text-muted,rgba(200,176,138,0.45));
    text-align:center;
  }
  @media (max-width:480px) {
    .auth-box { padding:32px 20px 28px; margin:16px; max-width:100%; }
  }
</style>
<style>
  /* ‚îÄ‚îÄ DARK theme (default) ‚îÄ‚îÄ */
  :root {
    --bg: #111111;
    --surface: #1c1c1c;
    --surface2: #272727;
    --border: #3a3a3a;
    --accent: #d4bc96;
    --accent2: #90bcd4;
    --text: #f0ebe2;
    --text-muted: #a09890;
    --red: #d48888;
    --green: #88d488;
    --chip-gold-bg: #c8a870;
    --chip-gold-text: #1a1207;
    --chip-blue-bg: #7aaec8;
    --chip-blue-text: #061825;
    --chip-red-bg: #c87070;
    --chip-red-text: #200808;
    --chip-green-bg: #70c870;
    --chip-green-text: #08200a;
    --chip-purple-bg: #9b70c8;
    --chip-purple-text: #f0eaff;
    --chip-single-bg: #303030;
  }
  /* ‚îÄ‚îÄ LIGHT theme ‚îÄ‚îÄ */
  html.light {
    --bg: #f7f4f0;
    --surface: #ffffff;
    --surface2: #efebe4;
    --border: #d8d0c4;
    --accent: #9c7d48;
    --accent2: #3a7a9a;
    --text: #1e1812;
    --text-muted: #7a6e60;
    --red: #a84444;
    --green: #3a8a3a;
    --chip-gold-bg: #b89558;
    --chip-gold-text: #ffffff;
    --chip-blue-bg: #5898ba;
    --chip-blue-text: #ffffff;
    --chip-red-bg: #b85858;
    --chip-red-text: #ffffff;
    --chip-green-bg: #58b058;
    --chip-green-text: #ffffff;
    --chip-purple-bg: #7b50a8;
    --chip-purple-text: #ffffff;
    --chip-single-bg: #e8e2d8;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:var(--font-main); min-height:100vh; overflow-x:hidden; transition:background 0.25s, color 0.25s; }

  header { display:flex; align-items:center; justify-content:space-between; padding:20px 32px; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10; background:var(--bg); }
  .header-left { display:flex; align-items:center; gap:16px; }
  .app-title { font-family:var(--font-mono); font-size:13px; letter-spacing:0.2em; color:var(--accent); text-transform:uppercase; }
  .nav-btn { background:none; border:1px solid var(--border); color:var(--text-muted); cursor:pointer; width:32px; height:32px; border-radius:6px; font-size:16px; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
  .nav-btn:hover { border-color:var(--accent); color:var(--accent); }
  .theme-btn { background:none; border:1px solid var(--border); color:var(--text-muted); cursor:pointer; width:32px; height:32px; border-radius:6px; font-size:16px; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
  .theme-btn:hover { border-color:var(--accent); transform:rotate(20deg); }

  /* ‚îÄ‚îÄ ÏÉâÏÉÅ ÏÑ§Ï†ï Ìå®ÎÑê ‚îÄ‚îÄ */
  .settings-btn { background:none; border:1px solid var(--border); color:var(--text-muted); cursor:pointer; width:32px; height:32px; border-radius:6px; font-size:16px; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
  .settings-btn:hover { border-color:var(--accent); color:var(--accent); }
  .settings-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:150; backdrop-filter:blur(3px); }
  .settings-overlay.open { display:block; }
  .settings-panel { position:fixed; top:0; right:0; bottom:0; width:320px; max-width:92vw; background:var(--surface); border-left:1px solid var(--border); z-index:151; display:flex; flex-direction:column; transform:translateX(100%); transition:transform 0.28s cubic-bezier(.4,0,.2,1); overflow-y:auto; }
  .settings-panel.open { transform:translateX(0); }
  .settings-panel-header { display:flex; align-items:center; justify-content:space-between; padding:20px 20px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:var(--surface); z-index:1; }
  .settings-panel-title { font-size:15px; font-weight:700; letter-spacing:0.04em; color:var(--text); }
  .settings-panel-body { padding:20px; display:flex; flex-direction:column; gap:16px; }
  .settings-section-title { font-size:11px; font-family:var(--font-mono); letter-spacing:0.12em; color:var(--text-muted); text-transform:uppercase; margin-bottom:4px; }
  .color-setting-row { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:8px; background:var(--surface2); border:1px solid var(--border); gap:10px; }
  .color-setting-label { font-size:13px; font-weight:500; color:var(--text); flex:1; }
  .color-setting-swatch { width:28px; height:28px; border-radius:6px; flex-shrink:0; border:2px solid rgba(255,255,255,0.15); cursor:pointer; transition:transform 0.15s, box-shadow 0.15s; position:relative; overflow:hidden; }
  .color-setting-swatch:hover { transform:scale(1.1); box-shadow:0 2px 8px rgba(0,0,0,0.35); }
  .color-setting-swatch input[type=color] { position:absolute; inset:-4px; width:calc(100% + 8px); height:calc(100% + 8px); opacity:0; cursor:pointer; border:none; padding:0; }
  .settings-reset-btn { padding:10px; border-radius:8px; border:1px solid var(--border); background:none; color:var(--text-muted); font-family:var(--font-main); font-size:13px; cursor:pointer; transition:all 0.15s; width:100%; }
  .settings-reset-btn:hover { border-color:var(--red); color:var(--red); background:rgba(200,100,100,0.07); }
  @media (max-width:600px) {
    .settings-panel { width:100%; border-left:none; top:auto; border-radius:20px 20px 0 0; transform:translateY(100%); }
    .settings-panel.open { transform:translateY(0); }
  }
  .month-label { font-size:18px; font-weight:500; letter-spacing:0.05em; min-width:180px; text-align:center; }
  .add-btn { background:var(--accent); color:#1a1207; border:none; padding:8px 20px; border-radius:6px; font-family:var(--font-main); font-size:13px; cursor:pointer; transition:all 0.2s; font-weight:500; }
  .add-btn:hover { background:#d4c09a; transform:translateY(-1px); }

  .legend { display:flex; gap:8px; align-items:center; padding:10px 32px; border-bottom:1px solid var(--border); flex-wrap:wrap; }
  /* ÌïÑÌÑ∞ Î≤ÑÌäº */
  .filter-btn {
    display:flex; align-items:center; gap:6px;
    padding:5px 12px; border-radius:20px; cursor:pointer;
    border:1px solid var(--border); background:none;
    font-family:var(--font-mono); font-size:12px; letter-spacing:0.06em;
    color:var(--text-muted); transition:all 0.18s; user-select:none; flex-shrink:0;
  }
  .filter-btn:hover { border-color:var(--accent); color:var(--text); }
  .filter-btn .filter-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; transition:all 0.18s; }
  /* ÌôúÏÑ± ÏÉÅÌÉú */
  .filter-btn.active { color:var(--text); }
  .filter-btn.active.f-gold   { background:rgba(200,176,138,0.15); border-color:var(--chip-gold-bg); }
  .filter-btn.active.f-blue   { background:rgba(138,180,200,0.15); border-color:var(--chip-blue-bg); }
  .filter-btn.active.f-red    { background:rgba(200,122,122,0.15); border-color:var(--chip-red-bg); }
  .filter-btn.active.f-green  { background:rgba(122,200,122,0.15); border-color:var(--chip-green-bg); }
  .filter-btn.active.f-purple { background:rgba(180,122,200,0.15); border-color:var(--chip-purple-bg); }
  /* ÎπÑÌôúÏÑ± ÏÉÅÌÉú - dot ÌùêÎ¶¨Í≤å */
  .filter-btn:not(.active) .filter-dot { opacity:0.25; }
  .filter-btn:not(.active) { opacity:0.55; }
  /* legend-dot (ÏÉâÏÉÅÏÑ§Ï†ï Ìå®ÎÑêÏóêÏÑú ÏÇ¨Ïö©) */
  .legend-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
  .legend-dot.gold   { background:#c8b08a; }
  .legend-dot.blue   { background:#8ab4c8; }
  .legend-dot.red    { background:#c87a7a; }
  .legend-dot.green  { background:#7ac87a; }
  .legend-dot.purple { background:#9b70c8; }

  .calendar-wrap { padding:20px 32px; }
  .weekdays { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; margin-bottom:4px; }
  .weekday { text-align:center; font-family:var(--font-mono); font-size:13px; letter-spacing:0.12em; color:var(--text-muted); padding:8px 0; }
  .weekday:first-child { color:var(--red); }
  .weekday:last-child  { color:var(--accent2); }

  .days-grid {
    border:1px solid var(--border);
    border-radius:12px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    gap:1px;
    background:var(--border);
  }

  .week-row {
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:1px;
    position:relative;
    background:var(--border);
  }

  .day-cell {
    background:var(--surface);
    min-height:0;
    padding:6px 6px 6px 6px;
    position:relative;
    transition:background 0.15s;
    cursor:default;
    overflow:hidden;
  }
  .week-row { min-height:110px; }
  .day-cell:hover { background:var(--surface2); }
  .day-cell.other-month { background:#111; }
  .day-cell.today .day-num {
    background:var(--accent);
    color:#1a1207 !important;
    font-weight:700;
    border-radius:50%;
  }
  .day-num-row {
    display:flex; align-items:center; gap:4px;
    margin-bottom:2px; min-width:0;
  }
  .day-num {
    font-family:var(--font-mono); font-size:13px; color:var(--text-muted);
    position:relative; z-index:1;
    width:24px; height:24px; flex-shrink:0;
    display:flex; align-items:center; justify-content:center;
  }
  .day-num.sun { color:var(--red); }
  .day-num.sat { color:var(--accent2); }
  .day-num.holiday { color:var(--red) !important; }
  .holiday-label {
    font-family:var(--font-mono);
    font-size:11px;
    color:var(--red);
    opacity:0.85;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    min-width:0;
    letter-spacing:0.02em;
    line-height:1;
  }

  .lane-spacer { height:24px; margin-bottom:2px; flex-shrink:0; }

  .event-chip {
    border-radius:4px; padding:4px 6px; font-size:12px;
    white-space:normal; overflow:hidden;
    cursor:pointer; transition:all 0.15s;
    display:flex; align-items:flex-start; gap:4px;
    line-height:1.4; min-height:22px; box-sizing:border-box;
    min-width:0; word-break:break-word;
  }
  .event-chip span { min-width:0; overflow:hidden; white-space:normal; word-break:break-word; }
  /* ÏõîÍ∞Ñ Î∑∞: Ìïú Ï§Ñ Í≥†Ï†ï */
  .event-chip.chip-month { white-space:nowrap; min-height:unset; height:22px; padding:2px 6px; align-items:center; word-break:normal; }
  .event-chip.chip-month span { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; word-break:normal; }
  .sched-icon-badge {
    flex-shrink:0; font-size:12px; margin-left:3px;
    display:inline-flex; align-items:center;
  }
  .event-chip.single { background:var(--chip-single-bg); color:var(--text); border-left:3px solid var(--accent); }
  .event-chip.single:hover { filter:brightness(1.12); transform:translateX(1px); }
  .event-chip.single.color-gold   { background:var(--chip-gold-bg-soft,   rgba(200,176,138,0.22)); border-left-color:var(--chip-gold-bg);   color:var(--text); }
  .event-chip.single.color-blue   { background:var(--chip-blue-bg-soft,   rgba(138,180,200,0.22)); border-left-color:var(--chip-blue-bg);   color:var(--text); }
  .event-chip.single.color-red    { background:var(--chip-red-bg-soft,    rgba(200,122,122,0.22)); border-left-color:var(--chip-red-bg);    color:var(--text); }
  .event-chip.single.color-green  { background:var(--chip-green-bg-soft,  rgba(122,200,122,0.22)); border-left-color:var(--chip-green-bg);  color:var(--text); }
  .event-chip.single.color-purple { background:var(--chip-purple-bg-soft, rgba(155,112,200,0.22)); border-left-color:var(--chip-purple-bg); color:var(--text); }

  .span-chip-overlay {
    position:absolute;
    top:0; left:0; right:0;
    pointer-events:none;
    z-index:2;
  }
  .span-chip {
    position:absolute;
    height:22px;
    font-size:12px;
    font-weight:500;
    color:#111;
    display:flex; align-items:center;
    overflow:hidden;
    white-space:nowrap;
    cursor:pointer;
    pointer-events:all;
    box-sizing:border-box;
    padding:0 7px;
    transition:filter 0.15s;
    min-width:0;
  }
  .span-chip:hover { filter:brightness(1.12); }
  .span-chip.color-gold  { background:var(--chip-gold-bg);  color:var(--chip-gold-text); font-weight:600; }
  .span-chip.color-blue  { background:var(--chip-blue-bg);  color:var(--chip-blue-text); font-weight:600; }
  .span-chip.color-red   { background:var(--chip-red-bg);   color:var(--chip-red-text); font-weight:600; }
  .span-chip.color-green  { background:var(--chip-green-bg);  color:var(--chip-green-text);  font-weight:600; }
  .span-chip.color-purple { background:var(--chip-purple-bg); color:var(--chip-purple-text); font-weight:600; }
  .span-chip.is-start { border-radius:4px 0 0 4px; }
  .span-chip.is-end   { border-radius:0 4px 4px 0; }
  .span-chip.is-solo  { border-radius:4px; }

  .events-list { display:flex; flex-direction:column; gap:2px; }

  .chip-time { font-family:var(--font-mono); font-size:12px; opacity:0.85; flex-shrink:0; margin-right:3px; }

  .more-badge { font-size:12px; color:var(--text-muted); font-family:var(--font-mono); padding:1px 6px; cursor:pointer; border-radius:3px; transition:all 0.15s; }
  .more-badge:hover { color:var(--accent); background:rgba(200,176,138,0.1); }

  .special-opts { display:flex; gap:7px; flex-wrap:wrap; margin-top:4px; }
  .special-opt-btn {
    display:flex; align-items:center; gap:6px;
    padding:7px 12px; border-radius:8px; cursor:pointer;
    border:1.5px solid var(--border); background:var(--surface2);
    font-size:12px; transition:all 0.15s; user-select:none;
    color:var(--text-muted); white-space:nowrap;
  }
  .special-opt-btn .opt-icon { font-size:15px; flex-shrink:0; }
  .special-opt-btn:hover { border-color:var(--accent); background:rgba(200,176,138,0.1); color:var(--text); }
  .special-opt-btn.active {
    border-color:var(--accent); background:rgba(200,176,138,0.18);
    color:var(--accent); box-shadow:0 0 0 2px rgba(200,176,138,0.2);
  }
  .sched-opt-btn {
    display:flex; align-items:center; gap:6px;
    padding:7px 14px; border-radius:8px; cursor:pointer;
    border:1.5px solid var(--border); background:var(--surface2);
    font-size:12px; font-weight:600; transition:all 0.15s;
    color:var(--text-muted); white-space:nowrap; user-select:none;
  }
  .sched-opt-btn .opt-icon { font-size:15px; flex-shrink:0; }
  .sched-opt-btn:hover { border-color:var(--accent); color:var(--text); }
  .sched-opt-btn.active[data-sopt="suggest"] {
    border-color:#8ab4c8; background:rgba(138,180,200,0.18);
    color:#8ab4c8; box-shadow:0 0 0 2px rgba(138,180,200,0.18);
  }
  .sched-opt-btn.active[data-sopt="hope"] {
    border-color:#c8b08a; background:rgba(200,176,138,0.18);
    color:var(--accent); box-shadow:0 0 0 2px rgba(200,176,138,0.18);
  }
  .sched-opt-btn.active[data-sopt="target"] {
    border-color:#7ac87a; background:rgba(122,200,122,0.18);
    color:#7ac87a; box-shadow:0 0 0 2px rgba(122,200,122,0.18);
  }
  .sched-opt-desc {
    margin-top:7px; font-size:12px; color:var(--text-muted);
    min-height:18px; transition:opacity 0.2s;
  }
  .chip-special { font-size:11px; flex-shrink:0; letter-spacing:1px; }

  .day-popover {
    position:fixed; z-index:200;
    background:var(--surface); border:1px solid var(--border);
    border-radius:12px; padding:0; min-width:220px; max-width:300px;
    box-shadow:0 8px 32px rgba(0,0,0,0.45);
    animation:popIn 0.15s ease;
  }
  @keyframes popIn { from{opacity:0;transform:scale(0.93) translateY(-6px)} to{opacity:1;transform:scale(1) translateY(0)} }
  .day-popover-header {
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 14px 8px; border-bottom:1px solid var(--border);
  }
  .day-popover-date {
    font-family:var(--font-mono); font-size:11px; letter-spacing:0.1em;
    color:var(--accent); text-transform:uppercase;
  }
  .day-popover-close {
    background:none; border:none; color:var(--text-muted); cursor:pointer;
    font-size:14px; padding:2px 6px; border-radius:4px; transition:all 0.15s;
    line-height:1;
  }
  .day-popover-close:hover { color:var(--red); background:rgba(200,122,122,0.1); }
  .day-popover-list { padding:8px 10px 12px; display:flex; flex-direction:column; gap:4px; max-height:320px; overflow-y:auto; }
  .day-popover-item {
    display:flex; align-items:center; gap:8px;
    padding:7px 10px; border-radius:7px; cursor:pointer;
    transition:background 0.12s; font-size:13px;
    border-left:3px solid transparent;
  }
  .day-popover-item:hover { background:var(--surface2); }
  .day-popover-item.color-gold  { border-left-color:var(--chip-gold-bg);  background:rgba(200,176,138,0.08); }
  .day-popover-item.color-blue  { border-left-color:var(--chip-blue-bg);  background:rgba(138,180,200,0.08); }
  .day-popover-item.color-red   { border-left-color:var(--chip-red-bg);   background:rgba(200,122,122,0.08); }
  .day-popover-item.color-green  { border-left-color:var(--chip-green-bg);  background:rgba(122,200,122,0.08); }
  .day-popover-item.color-purple { border-left-color:var(--chip-purple-bg); background:rgba(155,112,200,0.08); }
  .day-popover-item:hover.color-gold  { background:rgba(200,176,138,0.18); }
  .day-popover-item:hover.color-blue  { background:rgba(138,180,200,0.18); }
  .day-popover-item:hover.color-red   { background:rgba(200,122,122,0.18); }
  .day-popover-item:hover.color-green  { background:rgba(122,200,122,0.18); }
  .day-popover-item:hover.color-purple { background:rgba(155,112,200,0.18); }
  .day-popover-item-title { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .day-popover-item-time { font-family:var(--font-mono); font-size:11px; color:var(--text-muted); flex-shrink:0; }

  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.72); z-index:100; backdrop-filter:blur(4px); align-items:center; justify-content:center; padding:20px; }

  /* ‚îÄ‚îÄ ÎÇòÍ∞ÄÍ∏∞ ÌôïÏù∏ ÌåùÏóÖ ‚îÄ‚îÄ */
  .confirm-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:500; backdrop-filter:blur(2px); align-items:center; justify-content:center; padding:20px; }
  .confirm-overlay.open { display:flex; }
  .confirm-box { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:28px 28px 20px; max-width:360px; width:100%; box-shadow:0 8px 32px rgba(0,0,0,0.35); animation:popIn 0.18s ease; }
  .confirm-title { font-size:15px; font-weight:700; color:var(--text); margin-bottom:8px; }
  .confirm-desc  { font-size:13px; color:var(--text-muted); line-height:1.6; margin-bottom:20px; }
  .confirm-btns  { display:flex; gap:10px; justify-content:flex-end; }
  .confirm-btn-cancel { padding:9px 18px; border-radius:8px; border:1px solid var(--border); background:none; color:var(--text-muted); font-family:var(--font-main); font-size:13px; cursor:pointer; transition:all 0.15s; }
  .confirm-btn-cancel:hover { border-color:var(--accent); color:var(--accent); }
  .confirm-btn-leave  { padding:9px 18px; border-radius:8px; border:none; background:var(--red); color:#fff; font-family:var(--font-main); font-size:13px; font-weight:600; cursor:pointer; transition:all 0.15s; }
  .confirm-btn-leave:hover { filter:brightness(1.12); }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; width:100%; max-width:660px; max-height:92vh; overflow-y:auto; animation:modalIn 0.22s ease; transition:border-color 0.3s; }
  @keyframes modalIn { from{opacity:0;transform:translateY(18px) scale(0.97)} to{opacity:1;transform:translateY(0) scale(1)} }

  .modal-strip { height:4px; border-radius:16px 16px 0 0; background:var(--accent); transition:background 0.3s; }
  .modal-strip.color-blue  { background:var(--accent2); }
  .modal-strip.color-red   { background:var(--red); }
  .modal-strip.color-green { background:var(--green); }

  .type-badge {
    display:inline-flex; align-items:center; gap:5px;
    font-family:var(--font-mono); font-size:10px; letter-spacing:0.12em;
    padding:3px 8px; border-radius:4px; margin-bottom:6px;
    border:1px solid;
  }
  .type-badge.gold  { color:#c8b08a; border-color:rgba(200,176,138,0.35); background:rgba(200,176,138,0.08); }
  .type-badge.blue  { color:#8ab4c8; border-color:rgba(138,180,200,0.35); background:rgba(138,180,200,0.08); }
  .type-badge.red   { color:#c87a7a; border-color:rgba(200,122,122,0.35); background:rgba(200,122,122,0.08); }
  .type-badge.green  { color:#7ac87a; border-color:rgba(122,200,122,0.35); background:rgba(122,200,122,0.08); }
  .type-badge.purple { color:#9b70c8; border-color:rgba(155,112,200,0.35); background:rgba(155,112,200,0.08); }

  .modal-header { padding:20px 28px 0; display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
  .modal-date-badge { font-family:var(--font-mono); font-size:11px; color:var(--accent); letter-spacing:0.15em; }
  .modal-title-input { background:none; border:none; font-family:var(--font-main); font-size:22px; font-weight:500; color:var(--text); width:100%; outline:none; margin-top:4px; }
  .modal-title-input::placeholder { color:var(--text-muted); }

  .modal-header-btns { display:flex; gap:8px; flex-shrink:0; }
  .icon-btn { background:none; border:1px solid var(--border); color:var(--text-muted); width:32px; height:32px; border-radius:8px; cursor:pointer; font-size:15px; display:flex; align-items:center; justify-content:center; transition:all 0.2s; flex-shrink:0; }
  .icon-btn:hover { border-color:var(--accent); color:var(--accent); }
  .icon-btn.close-btn:hover { border-color:var(--red); color:var(--red); }
  .icon-btn.locked { border-color:var(--accent); background:rgba(200,176,138,0.12); color:var(--accent); }

  .locked-banner { display:none; align-items:center; gap:8px; background:rgba(200,176,138,0.08); border:1px solid rgba(200,176,138,0.25); border-radius:8px; padding:8px 14px; font-family:var(--font-mono); font-size:11px; letter-spacing:0.08em; color:var(--accent); margin:10px 28px 0; }
  .locked-banner.visible { display:flex; }

  .modal-body { padding:18px 28px 18px; display:flex; flex-direction:column; gap:14px; }

  /* ‚îÄ‚îÄ ÏïåÎ¶º ÏÑ§Ï†ï ‚îÄ‚îÄ */
  .notif-row { display:flex; align-items:center; gap:10px; }
  .notif-icon { font-size:14px; flex-shrink:0; opacity:0.7; }
  .notif-select {
    flex:1; background:var(--surface2); border:1px solid var(--border);
    border-radius:8px; padding:8px 10px; color:var(--text);
    font-family:var(--font-main); font-size:13px; outline:none;
    transition:border-color 0.2s; cursor:pointer;
  }
  .notif-select:focus { border-color:var(--accent); }
  .notif-select:disabled { opacity:0.45; cursor:not-allowed; }
  .notif-allday-label { font-size:12px; color:var(--text-muted); flex:1; padding:8px 10px;
    background:var(--surface2); border:1px solid var(--border); border-radius:8px; }
  .field-group { display:flex; flex-direction:column; gap:5px; }
  .field-row { display:flex; gap:12px; }
  .field-row .field-group { flex:1; }
  .field-label { font-family:var(--font-mono); font-size:10px; letter-spacing:0.2em; color:var(--text-muted); text-transform:uppercase; }

  .field-input, .field-textarea, .field-select {
    background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:9px 12px;
    color:var(--text); font-family:var(--font-main); font-size:14px; outline:none; transition:border-color 0.2s; width:100%;
  }
  .field-input:focus, .field-textarea:focus, .field-select:focus { border-color:var(--accent); }
  .field-input::placeholder, .field-textarea::placeholder { color:var(--text-muted); }
  .field-textarea { resize:none; min-height:80px; line-height:1.7; overflow:hidden; box-sizing:border-box; }
  .field-select { cursor:pointer; color-scheme:dark; } html.light .field-select { color-scheme:light; }
  .field-select option { background:var(--surface2); }

  .check-group { display:flex; gap:10px; flex-wrap:wrap; }
  .check-item { display:flex; align-items:center; gap:6px; cursor:pointer; user-select:none; }
  .check-item input[type=checkbox] { display:none; }
  .check-box { width:18px; height:18px; border:1px solid var(--border); border-radius:4px; display:flex; align-items:center; justify-content:center; transition:all 0.2s; flex-shrink:0; font-size:11px; }
  .check-item input:checked ~ .check-box { background:var(--accent); border-color:var(--accent); color:#1a1207; }
  .check-item span:last-child { font-size:13px; }

  .radio-group { display:flex; gap:8px; flex-wrap:wrap; }
  .radio-btn { padding:6px 14px; border:1px solid var(--border); border-radius:20px; font-size:12px; cursor:pointer; transition:all 0.2s; user-select:none; font-family:var(--font-mono); letter-spacing:0.05em; color:var(--text-muted); }
  .radio-btn:hover { border-color:var(--accent); color:var(--accent); }
  .radio-btn.active { background:var(--accent); border-color:var(--accent); color:#1a1207; font-weight:600; }
  .radio-btn.active-red   { background:var(--red);   border-color:var(--red);   color:#fff; }
  .radio-btn.active-green { background:var(--green); border-color:var(--green); color:#111; }

  .section-heading {
    font-family:var(--font-mono); font-size:10px; letter-spacing:0.25em;
    text-transform:uppercase; color:var(--text-muted);
    display:flex; align-items:center; gap:10px; margin-bottom:2px;
  }
  .section-heading::after { content:''; flex:1; height:1px; background:var(--border); }

  .allday-row { display:flex; align-items:center; gap:10px; }
  .toggle-wrap { display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none; }
  .toggle-track { width:36px; height:20px; background:var(--border); border-radius:999px; position:relative; transition:background 0.2s; flex-shrink:0; }
  .toggle-track.on { background:var(--accent); }
  .toggle-thumb { position:absolute; top:3px; left:3px; width:14px; height:14px; border-radius:50%; background:var(--text-muted); transition:all 0.2s; }
  .toggle-track.on .toggle-thumb { left:19px; background:#1a1207; }
  .toggle-label { font-family:var(--font-mono); font-size:11px; letter-spacing:0.1em; color:var(--text-muted); }

  .datetime-section { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:12px 14px; display:flex; flex-direction:column; gap:9px; }
  .dt-row { display:grid; grid-template-columns:36px 1fr 1fr; align-items:center; gap:8px; }
  .dt-row:hover { background:transparent; }
  .dt-label { font-family:var(--font-mono); font-size:10px; letter-spacing:0.12em; color:var(--text-muted); text-transform:uppercase; }
  .dt-input { background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:9px 12px; color:var(--text); font-family:var(--font-mono); font-size:14px; outline:none; transition:border-color 0.2s; width:100%; color-scheme:dark; cursor:pointer; } html.light .dt-input { color-scheme:light; }
  .dt-input:focus { border-color:var(--accent); }
  .dt-input:disabled { opacity:0.3; cursor:not-allowed; }

  .color-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .color-dot {
    padding:6px 14px; border-radius:20px; cursor:pointer;
    border:2px solid transparent; transition:all 0.18s;
    font-size:12px; font-weight:600; letter-spacing:0.03em;
    user-select:none; white-space:nowrap;
  }
  .color-dot[data-color="gold"]   { background:rgba(200,176,138,0.18); color:#c8b08a; }
  .color-dot[data-color="blue"]   { background:rgba(138,180,200,0.18); color:#8ab4c8; }
  .color-dot[data-color="red"]    { background:rgba(200,122,122,0.18); color:#c87a7a; }
  .color-dot[data-color="green"]  { background:rgba(122,200,122,0.18); color:#7ac87a; }
  .color-dot[data-color="purple"] { background:rgba(155,112,200,0.18); color:#9b70c8; }
  .color-dot.active[data-color="gold"]   { background:rgba(200,176,138,0.35); border-color:#c8b08a; }
  .color-dot.active[data-color="blue"]   { background:rgba(138,180,200,0.35); border-color:#8ab4c8; }
  .color-dot.active[data-color="red"]    { background:rgba(200,122,122,0.35); border-color:#c87a7a; }
  .color-dot.active[data-color="green"]  { background:rgba(122,200,122,0.35); border-color:#7ac87a; }
  .color-dot.active[data-color="purple"] { background:rgba(155,112,200,0.35); border-color:#9b70c8; }
  .color-dot:hover { filter:brightness(1.15); }
  .color-dot.locked-dot { pointer-events:none; opacity:0.5; }

  .img-upload-group { display:flex; flex-direction:column; gap:6px; }
  .img-upload-label { font-family:var(--font-mono); font-size:10px; letter-spacing:0.2em; color:var(--text-muted); text-transform:uppercase; }
  .img-upload-zone {
    border:1px dashed var(--border); border-radius:8px; padding:12px; text-align:center;
    cursor:pointer; transition:all 0.2s; position:relative; font-size:11px; color:var(--text-muted);
  }
  .img-upload-zone:hover, .img-upload-zone.drag-over { border-color:var(--accent); background:rgba(200,176,138,0.04); color:var(--accent); }
  .img-upload-zone input[type=file] { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
  .img-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:7px; margin-top:6px; }
  .img-item { position:relative; border-radius:7px; overflow:hidden; border:1px solid var(--border); background:var(--surface2); aspect-ratio:1; }
  .img-item img { width:100%; height:100%; object-fit:cover; cursor:zoom-in; }
  .img-remove { position:absolute; top:3px; right:3px; background:rgba(0,0,0,0.75); border:none; color:#fff; width:18px; height:18px; border-radius:50%; cursor:pointer; font-size:10px; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.2s; }
  .img-item:hover .img-remove { opacity:1; }
  .img-remove.hidden { display:none !important; }

  .upload-zone { border:1px dashed var(--border); border-radius:10px; padding:16px; text-align:center; cursor:pointer; transition:all 0.2s; position:relative; }
  .upload-zone:hover, .upload-zone.drag-over { border-color:var(--accent); background:rgba(200,176,138,0.04); }
  .upload-zone input[type=file] { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
  .upload-icon { font-size:22px; margin-bottom:5px; }
  .upload-text { font-size:12px; color:var(--text-muted); }
  .upload-text span { color:var(--accent); }
  .upload-zone.locked-zone { display:none; }
  .img-upload-zone.locked-zone { display:none; }

  .attachments-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(88px,1fr)); gap:8px; margin-top:8px; }
  .attachment-item { position:relative; border-radius:8px; overflow:hidden; border:1px solid var(--border); background:var(--surface2); aspect-ratio:1; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:5px; }
  .attachment-item img { width:100%; height:100%; object-fit:cover; position:absolute; inset:0; cursor:zoom-in; }
  .attachment-icon { font-size:22px; }
  .attachment-name { font-size:10px; color:var(--text-muted); text-align:center; padding:0 5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%; }
  .attachment-remove { position:absolute; top:3px; right:3px; background:rgba(0,0,0,0.75); border:none; color:#fff; width:18px; height:18px; border-radius:50%; cursor:pointer; font-size:11px; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.2s; }
  .attachment-item:hover .attachment-remove { opacity:1; }
  .attachment-remove.hidden { display:none !important; }

  .lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:200; align-items:center; justify-content:center; cursor:zoom-out; }
  .lightbox.open { display:flex; }
  .lightbox img { max-width:90vw; max-height:90vh; border-radius:8px; object-fit:contain; }

  .conditional-field { overflow:hidden; max-height:0; transition:max-height 0.3s ease; }
  .conditional-field.visible { max-height:80px; }

  .btn-save-top {
    background:var(--accent); color:#1a1207; border:none;
    padding:6px 16px; border-radius:7px;
    font-family:var(--font-main); font-size:13px; font-weight:700;
    cursor:pointer; transition:all 0.2s; white-space:nowrap;
  }
  .btn-save-top:hover { background:#d4c09a; }
  .btn-save-top:disabled { opacity:0.4; cursor:not-allowed; }

  .modal-footer { padding:0 28px 22px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .btn-delete { background:none; border:1px solid rgba(200,122,122,0.4); color:var(--red); padding:8px 16px; border-radius:8px; font-family:var(--font-main); font-size:13px; cursor:pointer; transition:all 0.2s; opacity:0.7; }
  .btn-delete:hover { opacity:1; background:rgba(200,122,122,0.1); }
  .btn-save { background:var(--accent); color:#1a1207; border:none; padding:10px 28px; border-radius:8px; font-family:var(--font-main); font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s; }
  .btn-save:hover { background:#d4c09a; }

  .field-input:disabled, .field-textarea:disabled, .dt-input:disabled, .field-select:disabled { opacity:0.55; cursor:not-allowed; background:var(--surface); border-color:transparent; }
  .modal-title-input:disabled { opacity:0.75; cursor:not-allowed; }

  .divider { height:1px; background:var(--border); margin:2px 0; }
  ::-webkit-scrollbar { width:5px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:999px; }

  .view-toggle-group {
    display:flex; gap:2px; background:var(--surface2);
    border:1px solid var(--border); border-radius:9px; padding:3px;
  }
  .view-toggle-btn {
    padding:5px 13px; border-radius:6px; border:none;
    background:transparent; color:var(--text-muted);
    font-family:var(--font-main); font-size:12px; font-weight:500;
    cursor:pointer; transition:all 0.15s; letter-spacing:0.02em;
    white-space:nowrap;
  }
  .view-toggle-btn:hover { color:var(--text); }
  .view-toggle-btn.active {
    background:rgba(200,176,138,0.2); color:var(--accent);
    font-weight:700;
  }

  .pc-week-row {
    display:grid; grid-template-columns:repeat(7,1fr);
    gap:1px; border-bottom:1px solid var(--border);
    position:relative;
    overflow: hidden; /* ‚Üê Ïù¥ Ï§Ñ Ï∂îÍ∞Ä */
  }
  .pc-week-overlay {
    position:absolute; top:0; left:0; right:0;
    pointer-events:none; z-index:2;
  }
  .pc-span-chip {
    position:absolute; height:22px;
    font-size:12px; font-weight:600;
    display:flex; align-items:center;
    overflow:hidden; white-space:nowrap;
    cursor:pointer; pointer-events:all;
    box-sizing:border-box; padding:0 8px;
    transition:filter 0.15s; min-width:0;
  }
  .pc-span-chip:hover { filter:brightness(1.12); }
  .pc-span-chip.color-gold  { background:var(--chip-gold-bg);  color:var(--chip-gold-text); }
  .pc-span-chip.color-blue  { background:var(--chip-blue-bg);  color:var(--chip-blue-text); }
  .pc-span-chip.color-red   { background:var(--chip-red-bg);   color:var(--chip-red-text); }
  .pc-span-chip.color-green  { background:var(--chip-green-bg);  color:var(--chip-green-text); }
  .pc-span-chip.color-purple { background:var(--chip-purple-bg); color:var(--chip-purple-text); }
  .pc-span-chip.is-start { border-radius:4px 0 0 4px; }
  .pc-span-chip.is-end   { border-radius:0 4px 4px 0; }
  .pc-span-chip.is-solo  { border-radius:4px; }
  .pc-week-cell {
    min-height:140px; padding:8px 6px 6px;
    background:var(--surface); position:relative;
    border-right:1px solid var(--border); cursor:pointer;
    transition:background 0.12s;
    overflow:hidden; min-width:0;
  }
  .pc-week-cell:last-child { border-right:none; }
  .pc-week-cell:hover { background:var(--surface2); }
  .pc-week-cell.today { background:rgba(200,176,138,0.06); }
  .pc-week-cell.other-month { opacity:0.38; }
  .pc-week-num {
    font-size:13px; font-weight:600; width:26px; height:26px;
    border-radius:50%; display:flex; align-items:center;
    justify-content:center; margin-bottom:4px; transition:all 0.12s;
  }
  .pc-week-num.today-num { background:var(--accent); color:#1a1207; }
  .pc-week-num.sun { color:var(--red); }
  .pc-week-num.sat { color:#8ab4c8; }
  .pc-week-num.holiday { color:var(--red); }
  .pc-week-holiday { font-size:10px; color:var(--red); margin-bottom:3px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .pc-day-wrap { padding:0 32px 40px; max-width:900px; margin:0 auto; }
  .pc-day-header {
    display:flex; align-items:baseline; gap:12px;
    padding:20px 0 16px; border-bottom:1px solid var(--border);
    margin-bottom:16px;
  }
  .pc-day-title { font-size:26px; font-weight:700; color:var(--text); }
  .pc-day-sub { font-size:13px; color:var(--text-muted); }
  .pc-day-holiday { font-size:13px; color:var(--red); }
  .pc-day-list { display:flex; flex-direction:column; gap:8px; }
  .pc-day-card {
    display:flex; gap:14px; align-items:flex-start;
    padding:14px 18px; border-radius:12px;
    background:var(--surface2); border:1px solid var(--border);
    border-left:4px solid transparent; cursor:pointer;
    transition:all 0.15s;
  }
  .pc-day-card:hover { border-color:var(--accent); background:rgba(200,176,138,0.07); }
  .pc-day-card.color-gold  { border-left-color:var(--chip-gold-bg); }
  .pc-day-card.color-blue  { border-left-color:var(--chip-blue-bg); }
  .pc-day-card.color-red   { border-left-color:var(--chip-red-bg); }
  .pc-day-card.color-green  { border-left-color:var(--chip-green-bg); }
  .pc-day-card.color-purple { border-left-color:var(--chip-purple-bg); }
  .pc-day-time {
    min-width:72px; font-family:var(--font-mono); font-size:12px;
    color:var(--text-muted); padding-top:2px; flex-shrink:0;
  }
  .pc-day-body { flex:1; min-width:0; }
  .pc-day-card-title { font-size:15px; font-weight:600; color:var(--text); margin-bottom:4px; }
  .pc-day-card-meta { font-size:12px; color:var(--text-muted); display:flex; gap:10px; flex-wrap:wrap; }
  .pc-day-empty { text-align:center; padding:60px 0; color:var(--text-muted); font-size:14px; }

  #mobileView { display:none; }

  @media (max-width:600px) {
    .calendar-wrap { display:none !important; }
    .legend { padding:8px 10px; gap:6px; overflow-x:auto; flex-wrap:nowrap; -webkit-overflow-scrolling:touch; }
    .filter-btn { font-size:11px; padding:4px 10px; white-space:nowrap; }
    #mobileView { display:block; }
    header { padding:10px 14px; flex-wrap:wrap; gap:8px; }
    .month-label { font-size:14px; min-width:120px; }
    .app-title { font-size:11px; }
    .add-btn { font-size:12px; padding:7px 14px; }
    .view-toggle-group { display:none; }
    .mv-wrap { padding:0 0 80px; }
    .mv-nav { display:flex; align-items:center; justify-content:space-between; padding:8px 14px 6px; gap:8px; }
    .mv-nav-label { font-size:13px; font-weight:600; color:var(--text); text-align:center; flex:1; }
    .mv-nav-btn { background:var(--surface2); border:1px solid var(--border); color:var(--text); width:34px; height:34px; border-radius:8px; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
    .mv-nav-btn:hover { border-color:var(--accent); color:var(--accent); }
    .mv-view-toggle { display:flex; gap:6px; padding:0 14px 8px; }
    .mv-view-btn { flex:1; padding:6px; border-radius:8px; font-size:12px; border:1px solid var(--border); background:var(--surface2); color:var(--text-muted); cursor:pointer; transition:all 0.15s; font-family:var(--font-main); }
    .mv-view-btn.active { background:rgba(200,176,138,0.2); border-color:var(--accent); color:var(--accent); font-weight:600; }
    .mv-week-header { display:grid; grid-template-columns:repeat(7,1fr); padding:0 8px; gap:3px; margin-bottom:4px; }
    .mv-week-day { text-align:center; font-size:11px; color:var(--text-muted); font-family:var(--font-mono); padding:4px 0 2px; letter-spacing:0.05em; }
    .mv-week-dates { display:grid; grid-template-columns:repeat(7,1fr); padding:0 8px; gap:3px; margin-bottom:10px; }
    .mv-date-cell { display:flex; flex-direction:column; align-items:center; gap:2px; padding:4px 2px 6px; border-radius:8px; cursor:pointer; transition:background 0.12s; min-height:52px; }
    .mv-date-cell:hover { background:var(--surface2); }
    .mv-date-cell.today .mv-date-num { background:var(--accent); color:#1a1207; }
    .mv-date-num { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:600; transition:all 0.12s; }
    .mv-date-num.sun { color:var(--red); }
    .mv-date-num.sat { color:#8ab4c8; }
    .mv-date-num.holiday { color:var(--red); }
    .mv-date-dot-row { display:flex; gap:2px; flex-wrap:wrap; justify-content:center; min-height:6px; }
    .mv-date-dot { width:5px; height:5px; border-radius:50%; flex-shrink:0; }
    .mv-date-dot.gold  { background:var(--chip-gold-bg); }
    .mv-date-dot.blue  { background:var(--chip-blue-bg); }
    .mv-date-dot.red   { background:var(--chip-red-bg); }
    .mv-date-dot.green  { background:var(--chip-green-bg); }
    .mv-date-dot.purple { background:var(--chip-purple-bg); }
    .mv-date-cell.selected .mv-date-num { background:rgba(200,176,138,0.25); box-shadow:0 0 0 2px var(--accent); }

    /* ‚îÄ‚îÄ Î™®Î∞îÏùº ÏõîÍ∞Ñ ‚îÄ‚îÄ */
    .mv-month-grid-header { display:grid; grid-template-columns:repeat(7,1fr); padding:4px 8px 2px; gap:2px; }
    .mv-month-grid { display:grid; grid-template-columns:repeat(7,1fr); padding:0 8px; gap:2px; margin-bottom:0; }
    .mv-month-cell {
      display:flex; flex-direction:column; align-items:center; gap:1px;
      padding:3px 1px 4px; border-radius:7px; cursor:pointer;
      transition:background 0.12s; min-height:50px;
    }
    .mv-month-cell > div[style*='flex-direction:column'] { /* dot+cnt wrap */ }
    .mv-month-cell .mv-month-dots-row { display:flex; gap:3px; flex-wrap:wrap; justify-content:center; }
    .mv-month-cell:hover { background:var(--surface2); }
    .mv-month-cell.other-month { opacity:0.3; }
    .mv-month-cell.today .mv-month-num { background:var(--accent); color:#1a1207; border-radius:50%; }
    .mv-month-cell.selected .mv-month-num { background:rgba(200,176,138,0.28); box-shadow:0 0 0 2px var(--accent); border-radius:50%; }
    .mv-month-num {
      width:26px; height:26px; border-radius:50%; display:flex; align-items:center;
      justify-content:center; font-size:12px; font-weight:600; transition:all 0.12s; flex-shrink:0;
    }
    .mv-month-num.sun { color:var(--red); }
    .mv-month-num.sat { color:#8ab4c8; }
    .mv-month-num.holiday { color:var(--red); }
    .mv-month-sel-bar {
      padding:10px 14px 4px; font-size:13px; font-weight:700; color:var(--text);
      border-top:1px solid var(--border); margin-top:6px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .mv-month-sel-date { font-size:13px; font-weight:700; color:var(--text); }
    .mv-month-sel-holiday { font-size:11px; color:var(--red); }
    .mv-day-section { padding:0 10px; }
    .mv-day-title { font-size:13px; font-weight:700; color:var(--text); padding:10px 4px 6px; border-bottom:1px solid var(--border); margin-bottom:6px; display:flex; align-items:center; gap:8px; }
    .mv-day-title-holiday { font-size:11px; color:var(--red); font-weight:400; flex:1; }
    .mv-empty { text-align:center; padding:24px 0 16px; color:var(--text-muted); font-size:13px; }
    .mv-event-card { display:flex; gap:10px; align-items:flex-start; padding:10px 12px; margin-bottom:6px; border-radius:10px; border-left:4px solid transparent; cursor:pointer; transition:all 0.12s; background:var(--surface2); border:1px solid var(--border); }
    .mv-event-card:hover { border-color:var(--accent); background:rgba(200,176,138,0.08); }
    .mv-event-card.color-gold  { border-left-color:var(--chip-gold-bg); }
    .mv-event-card.color-blue  { border-left-color:var(--chip-blue-bg); }
    .mv-event-card.color-red   { border-left-color:var(--chip-red-bg); }
    .mv-event-card.color-green  { border-left-color:var(--chip-green-bg); }
    .mv-event-card.color-purple { border-left-color:var(--chip-purple-bg); }
    .mv-event-card-body { flex:1; min-width:0; }
    .mv-event-title { font-size:14px; font-weight:600; color:var(--text); white-space:normal; overflow:hidden; word-break:break-word; margin-bottom:3px; }
    .mv-event-meta { font-size:11px; color:var(--text-muted); display:flex; gap:8px; flex-wrap:wrap; }
    .mv-event-badge { display:inline-flex; align-items:center; padding:1px 7px; border-radius:4px; font-size:10px; font-family:var(--font-mono); }
    .mv-event-badge.gold  { background:rgba(200,176,138,0.2); color:var(--accent); }
    .mv-event-badge.blue  { background:rgba(138,180,200,0.2); color:#8ab4c8; }
    .mv-event-badge.red   { background:rgba(200,122,122,0.2); color:var(--red); }
    .mv-event-badge.green { background:rgba(122,200,122,0.2); color:var(--green); }
    .mv-day-nav { display:flex; align-items:center; justify-content:space-between; padding:6px 14px 10px; }
    .mv-day-nav-label { font-size:15px; font-weight:700; color:var(--text); }
    .mv-day-nav-sub { font-size:11px; color:var(--text-muted); font-family:var(--font-mono); }
  }

  @media (max-width:900px) and (min-width:601px) {
    .calendar-wrap { padding:12px 12px; }
    header { padding:14px 16px; }
    .legend { padding:8px 16px; gap:8px; }
    .day-num { font-size:12px; width:22px; height:22px; }
    .holiday-label { font-size:10px; }
    .event-chip { font-size:11px; height:20px; padding:0 5px; gap:3px; }
    .span-chip { font-size:11px; height:20px; padding:0 5px; }
    .lane-spacer { height:22px; }
    .more-badge { font-size:11px; padding:0 5px; }
    .week-row { min-height:95px; }
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê AUTH OVERLAY ‚ïê‚ïê‚ïê -->
<div id="authOverlay">
  <div class="auth-box">
    <div class="auth-logo">üìÖ Calendar</div>
    <div class="auth-subtitle">DRGO Team</div>
    <div class="auth-label">ÎπÑÎ∞ÄÎ≤àÌò∏</div>
    <input class="auth-input" type="password" id="authInput"
           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
           maxlength="32" />
    <button class="auth-btn" id="authBtn">Ï†ëÏÜç</button>
    <div class="auth-error" id="authError"></div>
    <div class="auth-lock-msg" id="authLockMsg"></div>
  </div>
</div>

<header>
  <div class="header-left">
    <span class="app-title">Calendar</span>
    <button class="nav-btn" id="prevBtn">‚Äπ</button>
    <div class="month-label" id="monthLabel"></div>
    <button class="nav-btn" id="nextBtn">‚Ä∫</button>
    <button class="nav-btn" id="todayBtn" style="font-size:11px;letter-spacing:0.05em;width:auto;padding:0 10px;font-family:var(--font-mono);">TODAY</button>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="view-toggle-group">
      <button class="view-toggle-btn active" data-view="month">ÏõîÍ∞Ñ</button>
      <button class="view-toggle-btn" data-view="week">Ï£ºÍ∞Ñ</button>
      <button class="view-toggle-btn" data-view="day">ÏùºÍ∞Ñ</button>
    </div>
    <button class="settings-btn" id="settingsBtn" title="ÏÉâÏÉÅ ÏÑ§Ï†ï">‚öôÔ∏è</button>
    <button class="theme-btn" id="themeBtn" title="ÌÖåÎßà Ï†ÑÌôò">üåô</button>
    <button class="add-btn" id="addBtn">+ ÏùºÏ†ï Ï∂îÍ∞Ä</button>
  </div>
</header>

<div class="legend" id="filterBar">
  <button class="filter-btn active f-gold"   data-filter="gold">  <span class="filter-dot" id="fd-gold"></span>Í∞úÏù∏ÏùòÎ¢∞</button>
  <button class="filter-btn active f-blue"   data-filter="blue">  <span class="filter-dot" id="fd-blue"></span>ÏÇ¨ÎÇ¥ÏóÖÎ¨¥</button>
  <button class="filter-btn active f-red"    data-filter="red">   <span class="filter-dot" id="fd-red"></span>Ìú¥Í∞ÄÍ¥ÄÎ†®</button>
  <button class="filter-btn active f-green"  data-filter="green"> <span class="filter-dot" id="fd-green"></span>Ï¥¨ÏòÅÍ¥ÄÎ†®</button>
  <button class="filter-btn active f-purple" data-filter="purple"><span class="filter-dot" id="fd-purple"></span>ÎØ∏ÌåÖ/ÎÇ¥Î∞©</button>
</div>

<div class="calendar-wrap">
  <div class="weekdays">
    <div class="weekday">SUN</div><div class="weekday">MON</div><div class="weekday">TUE</div>
    <div class="weekday">WED</div><div class="weekday">THU</div><div class="weekday">FRI</div>
    <div class="weekday">SAT</div>
  </div>
  <div class="days-grid" id="daysGrid"></div>
</div>

<div id="pcWeekView" style="display:none;">
  <div class="calendar-wrap" style="padding-top:8px;">
    <div class="weekdays" id="pcWeekDays"></div>
    <div id="pcWeekGrid"></div>
  </div>
</div>

<div id="pcDayView" style="display:none;">
  <div class="pc-day-wrap">
    <div class="pc-day-header" id="pcDayHeader"></div>
    <div class="pc-day-list" id="pcDayList"></div>
  </div>
</div>

<div id="mobileView">
  <div class="mv-view-toggle">
    <button class="mv-view-btn" id="mvMonthBtn">ÏõîÍ∞Ñ</button>
    <button class="mv-view-btn active" id="mvWeekBtn">Ï£ºÍ∞Ñ</button>
    <button class="mv-view-btn" id="mvDayBtn">ÏùºÍ∞Ñ</button>
  </div>
  <!-- ÏõîÍ∞Ñ Ìå®ÎÑê -->
  <div id="mvMonthPanel" style="display:none;">
    <div class="mv-month-grid-header" id="mvMonthGridHeader"></div>
    <div class="mv-month-grid" id="mvMonthGrid"></div>
    <div class="mv-month-sel-bar" id="mvMonthSelBar"></div>
    <div class="mv-day-section" id="mvMonthDayList"></div>
  </div>
  <!-- Ï£ºÍ∞Ñ Ìå®ÎÑê -->
  <div id="mvWeekPanel">
    <div class="mv-week-header" id="mvWeekHeader"></div>
    <div class="mv-week-dates" id="mvWeekDates"></div>
    <div class="mv-day-section" id="mvDayList"></div>
  </div>
  <!-- ÏùºÍ∞Ñ Ìå®ÎÑê -->
  <div id="mvDayPanel" style="display:none;">
    <div class="mv-day-nav">
      <button class="mv-nav-btn" id="mvDayPrev">‚Äπ</button>
      <div style="text-align:center;">
        <div class="mv-day-nav-label" id="mvDayNavLabel"></div>
        <div class="mv-day-nav-sub" id="mvDayNavSub"></div>
      </div>
      <button class="mv-nav-btn" id="mvDayNext">‚Ä∫</button>
    </div>
    <div class="mv-day-section" id="mvDayPanelList"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ÏÉâÏÉÅ ÏÑ§Ï†ï Ìå®ÎÑê ‚ïê‚ïê‚ïê -->
<div class="settings-overlay" id="settingsOverlay"></div>
<div class="settings-panel" id="settingsPanel">
  <div class="settings-panel-header">
    <span class="settings-panel-title">‚öôÔ∏è ÏÉâÏÉÅ ÏÑ§Ï†ï</span>
    <button class="icon-btn close-btn" id="settingsCloseBtn">‚úï</button>
  </div>
  <div class="settings-panel-body">
    <div>
      <div class="settings-section-title">ÏùòÎ¢∞ Ïú†ÌòïÎ≥Ñ ÏÉâÏÉÅ</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div class="color-setting-row">
          <span class="color-setting-label">Í∞úÏù∏ÏùòÎ¢∞</span>
          <div class="color-setting-swatch" id="swatch-gold">
            <input type="color" id="colorPicker-gold" />
          </div>
        </div>
        <div class="color-setting-row">
          <span class="color-setting-label">ÏÇ¨ÎÇ¥ÏóÖÎ¨¥</span>
          <div class="color-setting-swatch" id="swatch-blue">
            <input type="color" id="colorPicker-blue" />
          </div>
        </div>
        <div class="color-setting-row">
          <span class="color-setting-label">Ìú¥Í∞ÄÍ¥ÄÎ†®</span>
          <div class="color-setting-swatch" id="swatch-red">
            <input type="color" id="colorPicker-red" />
          </div>
        </div>
        <div class="color-setting-row">
          <span class="color-setting-label">Ï¥¨ÏòÅÍ¥ÄÎ†®</span>
          <div class="color-setting-swatch" id="swatch-green">
            <input type="color" id="colorPicker-green" />
          </div>
        </div>
        <div class="color-setting-row">
          <span class="color-setting-label">ÎØ∏ÌåÖ/ÎÇ¥Î∞©</span>
          <div class="color-setting-swatch" id="swatch-purple">
            <input type="color" id="colorPicker-purple" />
          </div>
        </div>
      </div>
    </div>
    <button class="settings-reset-btn" id="settingsResetBtn">‚Ü∫ Í∏∞Î≥∏ ÏÉâÏÉÅÏúºÎ°ú Ï¥àÍ∏∞Ìôî</button>

    <div style="border-top:1px solid var(--border); padding-top:14px; margin-top:4px;">
      <div class="settings-section-title">Discord ÏïåÎ¶º</div>
      <button class="settings-reset-btn" id="discordTestBtn"
        style="border-color:rgba(88,101,242,0.4); color:#8891f2; margin-top:6px;">
        üîî ÌÖåÏä§Ìä∏ ÏïåÎ¶º Î≥¥ÎÇ¥Í∏∞
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê EVENT MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modal">
    <div class="modal-strip" id="modalStrip"></div>
    <div class="modal-header">
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span class="modal-date-badge" id="modalDateBadge"></span>
          <span class="type-badge gold" id="typeBadge">‚óè Í∞úÏù∏ÏùòÎ¢∞</span>
        </div>
        <input class="modal-title-input" id="modalTitle" placeholder="ÏùºÏ†ï Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
      </div>
      <div class="modal-header-btns">
        <button class="icon-btn" id="lockBtn" title="ÎÇ¥Ïö© Í≥†Ï†ï">üîì</button>
        <button class="btn-save-top" id="saveBtnTop">Ï†ÄÏû•</button>
        <button class="icon-btn close-btn" id="closeBtn">‚úï</button>
      </div>
    </div>
    <div class="locked-banner" id="lockedBanner">üîí&nbsp; Ïù¥ ÏùºÏ†ïÏùÄ Í≥†Ï†ïÎêòÏñ¥ ÏûàÏäµÎãàÎã§ ‚Äî ÏàòÏ†ïÌïòÎ†§Î©¥ ÏûêÎ¨ºÏá†Î•º Ìï¥Ï†úÌïòÏÑ∏Ïöî</div>

    <div class="modal-body">
      <div class="field-group">
        <label class="field-label" for="modalLocation">Ï£ºÏÜå</label>
        <input class="field-input" id="modalLocation" placeholder="Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" autocomplete="off" />
      </div>
      <div class="datetime-section">
        <div class="allday-row">
          <div class="toggle-wrap" id="alldayToggle">
            <div class="toggle-track" id="alldayTrack"><div class="toggle-thumb"></div></div>
            <span class="toggle-label">Ï¢ÖÏùº</span>
          </div>
        </div>
        <div class="dt-row">
          <span class="dt-label">ÏãúÏûë</span>
          <input class="dt-input" type="date" id="startDate" />
          <input class="dt-input" type="time" id="startTime" value="09:00" />
        </div>
        <div class="dt-row">
          <span class="dt-label">Ï¢ÖÎ£å</span>
          <input class="dt-input" type="date" id="endDate" />
          <input class="dt-input" type="time" id="endTime" value="10:00" />
        </div>
      </div>

      <!-- ÏïåÎ¶º ÏÑ§Ï†ï -->
      <div class="field-group" id="notifGroup">
        <label class="field-label">üîî ÏïåÎ¶º</label>
        <div class="notif-row">
          <select class="notif-select" id="notifSelect">
            <option value="">ÏïåÎ¶º ÏóÜÏùå</option>
            <option value="0">Ï†ïÏãú (ÏùºÏ†ï ÏãúÏûë ÏãúÍ∞Ñ)</option>
            <option value="5">5Î∂Ñ Ï†Ñ</option>
            <option value="10">10Î∂Ñ Ï†Ñ</option>
            <option value="15">15Î∂Ñ Ï†Ñ</option>
            <option value="30">30Î∂Ñ Ï†Ñ</option>
            <option value="60">1ÏãúÍ∞Ñ Ï†Ñ</option>
            <option value="120">2ÏãúÍ∞Ñ Ï†Ñ</option>
            <option value="1440">ÌïòÎ£® Ï†Ñ Ïò§Ï†Ñ 9Ïãú</option>
          </select>
          <span class="notif-allday-label" id="notifAlldayLabel" style="display:none;">ÎãπÏùº Ïò§Ï†Ñ 9Ïãú Î∞úÏÜ°</span>
        </div>
      </div>

      <div class="field-group" style="margin-top:10px;">
        <div class="field-label">ÏùºÏ†ï Í¥ÄÎ†® ÏòµÏÖò</div>
        <div class="special-opts" id="scheduleOpts">
          <div class="sched-opt-btn" data-sopt="suggest"><span class="opt-icon">üí¨</span>Ï†úÏïà</div>
          <div class="sched-opt-btn" data-sopt="hope">   <span class="opt-icon">üôè</span>Ìù¨Îßù</div>
          <div class="sched-opt-btn" data-sopt="target">  <span class="opt-icon">üéØ</span>Î™©Ìëú</div>
        </div>
        <div class="sched-opt-desc" id="schedOptDesc"></div>
      </div>

      <div class="field-group">
        <div class="field-label">ÏùòÎ¢∞ Ïú†Ìòï / ÏÉâÏÉÅ</div>
        <div class="color-row" id="colorRow">
          <div class="color-dot active" data-color="gold">Í∞úÏù∏ÏùòÎ¢∞</div>
          <div class="color-dot"        data-color="blue">ÏÇ¨ÎÇ¥ÏóÖÎ¨¥</div>
          <div class="color-dot"        data-color="red">Ìú¥Í∞ÄÍ¥ÄÎ†®</div>
          <div class="color-dot"        data-color="green">Ï¥¨ÏòÅÍ¥ÄÎ†®</div>
          <div class="color-dot"        data-color="purple">ÎØ∏ÌåÖ/ÎÇ¥Î∞©</div>
        </div>
      </div>

      <div class="field-group" style="margin-top:10px;">
        <div class="field-label">ÌäπÏàò ÏòµÏÖò</div>
        <div class="special-opts" id="specialOpts">
          <div class="special-opt-btn" data-opt="car">    <span class="opt-icon">üöó</span>Ï∞®Îüâ Ïù¥Ïö© ÌïÑÏöî</div>
          <div class="special-opt-btn" data-opt="brief">  <span class="opt-icon">üíº</span>Îì§Í≥† Í∞à Ï†úÌíà ÏûàÏùå</div>
          <div class="special-opt-btn" data-opt="return"> <span class="opt-icon">‚Üê</span>ÏùºÏ†ï ÎãπÍπÄ Ìù¨Îßù</div>
          <div class="special-opt-btn" data-opt="group">  <span class="opt-icon">üë•</span>2Ïù∏ÌïÑÏàò ÏûëÏóÖ</div>
          <div class="special-opt-btn" data-opt="urgent"> <span class="opt-icon">üö®</span>Í∏¥Í∏â ÏùºÏ†ï</div>
          <div class="special-opt-btn" data-opt="ladder"> <span class="opt-icon">‚ñ§</span>ÏÇ¨Îã§Î¶¨ ÌïÑÏöî</div>
        </div>
      </div>

      <div class="divider"></div>

      <div id="commonFields">
        <div class="field-group">
          <label class="field-label" id="labelName">Ïù¥Î¶Ñ / Îã¥ÎãπÏûê</label>
          <input class="field-input" id="modalName" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
        </div>
        <div style="margin-top:12px" class="field-group">
          <label class="field-label" for="modalAddress">Ï£ºÏÜå</label>
          <input class="field-input" id="modalAddress" placeholder="Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
        </div>
        <div style="margin-top:12px" class="field-group">
          <label class="field-label" for="modalDesc">ÏÉÅÏÑ∏ ÏÑ§Î™Ö</label>
          <textarea class="field-textarea" id="modalDesc" placeholder="ÏÉÅÏÑ∏ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
        </div>
      </div>

      <div id="goldTemplate" style="display:none; flex-direction:column; gap:14px;">
        <div class="section-heading">ÏùòÎ¢∞Ïûê Ï†ïÎ≥¥</div>
        <div class="field-row">
          <div class="field-group">
            <label class="field-label" for="g_name">ÏùòÎ¢∞Ïûê Ïù¥Î¶Ñ</label>
            <input class="field-input" id="g_name" placeholder="Ïù¥Î¶Ñ" />
          </div>
          <div class="field-group">
            <label class="field-label" for="g_phone">Ï†ÑÌôîÎ≤àÌò∏</label>
            <input class="field-input" id="g_phone" placeholder="010-0000-0000" />
          </div>
        </div>
        <div class="field-row">
          <div class="field-group">
            <label class="field-label" for="g_platform">ÌîåÎû´Ìèº</label>
            <input class="field-input" id="g_platform" placeholder="Ïú†ÌäúÎ∏å, Ïù∏Ïä§ÌÉÄÍ∑∏Îû® Îì±" />
          </div>
          <div class="field-group">
            <label class="field-label">Í≤ΩÎ†• Ïó¨Î∂Ä</label>
            <div class="radio-group" id="g_career_group">
              <div class="radio-btn active" data-val="Ï≤òÏùå">Ï≤òÏùå</div>
              <div class="radio-btn" data-val="Í≤ΩÎ†•">Í≤ΩÎ†•</div>
            </div>
          </div>
        </div>
        <div class="field-group">
          <label class="field-label">Î∞©ÏÜ° Ï£ºÏ†ú</label>
          <div class="radio-group" id="g_topic_group">
            <div class="radio-btn" data-val="ÏÜåÌÜµ">ÏÜåÌÜµ</div>
            <div class="radio-btn" data-val="Î®πÎ∞©">Î®πÎ∞©</div>
            <div class="radio-btn" data-val="Í≤åÏûÑ">Í≤åÏûÑ</div>
            <div class="radio-btn" data-val="ÏïºÏô∏">ÏïºÏô∏</div>
            <div class="radio-btn" data-val="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</div>
          </div>
          <div class="conditional-field" id="g_topic_etc_wrap" style="margin-top:8px;">
            <input class="field-input" id="g_topic_etc" placeholder="Î∞©ÏÜ° Ï£ºÏ†úÎ•º ÏßÅÏ†ë ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
          </div>
        </div>
        <div class="divider"></div>
        <div class="section-heading">Ïû•ÎπÑ Î™©Î°ù</div>
        <div class="field-group">
          <label class="field-label" for="g_equipment">Ïû•ÎπÑ Î™©Î°ù</label>
          <textarea class="field-textarea" id="g_equipment" placeholder="ÏÇ¨Ïö© Ïû•ÎπÑÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="min-height:195px;"></textarea>
        </div>
        <div class="divider"></div>
        <div class="section-heading">ÏùòÎ¢∞ ÎÇ¥Ïö©</div>
        <div class="field-group">
          <label class="field-label" for="g_req_topic">ÏùòÎ¢∞ Ï£ºÏ†ú</label>
          <input class="field-input" id="g_req_topic" placeholder="ÏùòÎ¢∞ Ï£ºÏ†úÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
        </div>
        <div class="field-group">
          <label class="field-label" for="g_req_detail">ÏùòÎ¢∞ ÏÑ∏Î∂ÄÌï≠Î™©</label>
          <textarea class="field-textarea" id="g_req_detail" placeholder="ÏÑ∏Î∂Ä Ìï≠Î™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
        </div>
        <div class="field-group">
          <label class="field-label" for="g_special">ÌäπÏù¥ÏÇ¨Ìï≠</label>
          <textarea class="field-textarea" id="g_special" placeholder="ÌäπÏù¥ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="min-height:65px;"></textarea>
        </div>
        <div class="divider"></div>
        <div class="section-heading">Í≤∞Ï†ú Ï†ïÎ≥¥</div>
        <div class="field-row">
          <div class="field-group">
            <div class="field-label">Í≤∞Ï†ú Ïó¨Î∂Ä</div>
            <div class="radio-group" id="g_paid_group">
              <div class="radio-btn active" data-val="ÎØ∏Í≤∞Ï†ú">ÎØ∏Í≤∞Ï†ú</div>
              <div class="radio-btn" data-val="Í≤∞Ï†úÏôÑÎ£å">Í≤∞Ï†úÏôÑÎ£å</div>
            </div>
          </div>
          <div class="field-group">
            <div class="field-label">Ï£ºÎ¨∏ Ï†úÌíà</div>
            <div class="radio-group" id="g_order_group">
              <div class="radio-btn active" data-val="X">X</div>
              <div class="radio-btn" data-val="O">O</div>
            </div>
          </div>
        </div>
        <div class="field-row">
          <div class="field-group">
            <div class="field-label">ÏûîÍ∏à Ïó¨Î∂Ä</div>
            <div class="radio-group" id="g_balance_group">
              <div class="radio-btn active" data-val="X">X</div>
              <div class="radio-btn" data-val="O">O</div>
            </div>
          </div>
          <div class="field-group">
            <div class="conditional-field" id="g_balance_amount_wrap">
              <label class="field-label" for="g_balance_amount">ÏûîÍ∏à Í∏àÏï°</label>
              <input class="field-input" id="g_balance_amount" placeholder="ÏûîÍ∏à Í∏àÏï° (Ïõê)" type="text" />
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="section-heading">Ï≤®Î∂Ä Ïù¥ÎØ∏ÏßÄ</div>
        <div class="img-upload-group">
          <div class="img-upload-label">Í≤¨Ï†ÅÏÑú</div>
          <div class="img-upload-zone" id="quoteZone">
            <input type="file" id="quoteInput" multiple accept="image/*" />
            üìÑ Í≤¨Ï†ÅÏÑú Ïù¥ÎØ∏ÏßÄÎ•º ÌÅ¥Î¶≠ ÎòêÎäî ÎìúÎûòÍ∑∏ÌïòÏó¨ Ï∂îÍ∞Ä
          </div>
          <div class="img-grid" id="quoteGrid"></div>
        </div>
        <div class="img-upload-group">
          <div class="img-upload-label">Î†àÌçºÎü∞Ïä§</div>
          <div class="img-upload-zone" id="refZone">
            <input type="file" id="refInput" multiple accept="image/*" />
            üì∑ Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄÎ•º ÌÅ¥Î¶≠ ÎòêÎäî ÎìúÎûòÍ∑∏ÌïòÏó¨ Ï∂îÍ∞Ä
          </div>
          <div class="img-grid" id="refGrid"></div>
        </div>
        <div class="img-upload-group">
          <div class="img-upload-label">Î∞© ÏÇ¨ÏßÑ</div>
          <div class="img-upload-zone" id="roomZone">
            <input type="file" id="roomInput" multiple accept="image/*" />
            üè† Î∞© ÏÇ¨ÏßÑÏùÑ ÌÅ¥Î¶≠ ÎòêÎäî ÎìúÎûòÍ∑∏ÌïòÏó¨ Ï∂îÍ∞Ä
          </div>
          <div class="img-grid" id="roomGrid"></div>
        </div>
      </div>

      <div id="generalAttachSection">
        <div class="divider" style="margin-bottom:14px;"></div>
        <div class="field-group">
          <div class="field-label">Ï≤®Î∂Ä ÌååÏùº</div>
          <div class="upload-zone" id="uploadZone">
            <input type="file" id="fileInput" multiple accept="*/*" />
            <div class="upload-icon">üìé</div>
            <div class="upload-text">ÌååÏùºÏùÑ <span>ÌÅ¥Î¶≠</span>ÌïòÍ±∞ÎÇò ÎìúÎûòÍ∑∏ÌïòÏó¨ Ï≤®Î∂ÄÌïòÏÑ∏Ïöî<br><small style="opacity:0.55">Ïù¥ÎØ∏ÏßÄÎäî ÎØ∏Î¶¨Î≥¥Í∏∞Í∞Ä ÏßÄÏõêÎê©ÎãàÎã§</small></div>
          </div>
          <div class="attachments-grid" id="attachmentsGrid"></div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-delete" id="deleteBtn">ÏùºÏ†ï ÏÇ≠Ï†ú</button>
      <button class="btn-save"   id="saveBtn">Ï†ÄÏû•</button>
    </div>
  </div>
</div>

<div class="day-popover" id="dayPopover" style="display:none;">
  <div class="day-popover-header">
    <span class="day-popover-date" id="dayPopoverDate"></span>
    <button class="day-popover-close" id="dayPopoverClose">‚úï</button>
  </div>
  <div class="day-popover-list" id="dayPopoverList"></div>
</div>

<div id="loadingOverlay" style="display:flex;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:999;align-items:center;justify-content:center;flex-direction:column;gap:16px;backdrop-filter:blur(4px);">
  <div style="width:36px;height:36px;border:3px solid rgba(200,176,138,0.25);border-top-color:#c8b08a;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
  <div style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.15em;color:#c8b08a;opacity:0.8;">LOADING</div>
</div>
<style>@keyframes spin{to{transform:rotate(360deg)}}</style>

<div class="lightbox" id="lightbox">
  <img id="lightboxImg" src="" alt="preview" />
</div>

<!-- ‚ïê‚ïê‚ïê ÎÇòÍ∞ÄÍ∏∞ ÌôïÏù∏ ÌåùÏóÖ ‚ïê‚ïê‚ïê -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-title">‚ö†Ô∏è Ï†ÄÏû•ÌïòÏßÄ ÏïäÏùÄ Î≥ÄÍ≤ΩÏÇ¨Ìï≠</div>
    <div class="confirm-desc">ÏàòÏ†ïÎêú ÎÇ¥Ïö©Ïù¥ ÏûàÏäµÎãàÎã§.<br>Ï†ÄÏû•ÌïòÏßÄ ÏïäÍ≥† Ï†ïÎßê ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?</div>
    <div class="confirm-btns">
      <button class="confirm-btn-cancel" id="confirmCancel">Í≥ÑÏÜç Ìé∏Ïßë</button>
      <button class="confirm-btn-leave"  id="confirmLeave">ÎÇòÍ∞ÄÍ∏∞</button>
    </div>
  </div>
</div>

<script type="module">
/* AUTH */
const PASS_HASH = '25689706309b7389a2a9c7e5822c91399f60b3c5be15fe6aecdb17b2b0863be8';
const MAX_TRIES  = 5;
const LOCK_MS    = 60000;
const SESSION_KEY = 'cal_auth_ok';
const TRIES_KEY   = 'cal_auth_tries';
const LOCK_KEY    = 'cal_auth_lock';

async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}
function isAuthenticated() { return sessionStorage.getItem(SESSION_KEY) === '1'; }
function getLockRemaining() { return Math.max(0, parseInt(localStorage.getItem(LOCK_KEY)||'0') - Date.now()); }
function getTriesLeft() { return Math.max(0, MAX_TRIES - parseInt(localStorage.getItem(TRIES_KEY)||'0')); }
function showAuth() { document.getElementById('authOverlay').classList.remove('hidden'); }
function hideAuth() { document.getElementById('authOverlay').classList.add('hidden'); }

function updateLockUI() {
  const rem = getLockRemaining();
  const btn = document.getElementById('authBtn');
  const lockMsg = document.getElementById('authLockMsg');
  if (rem > 0) {
    btn.disabled = true;
    lockMsg.textContent = `${Math.ceil(rem/1000)}Ï¥à ÌõÑ Îã§Ïãú ÏãúÎèÑÌï† Ïàò ÏûàÏäµÎãàÎã§`;
    setTimeout(updateLockUI, 1000);
  } else {
    btn.disabled = false;
    lockMsg.textContent = getTriesLeft() < MAX_TRIES ? `ÎÇ®ÏùÄ ÏãúÎèÑ: ${getTriesLeft()}Ìöå` : '';
  }
}

async function tryAuth() {
  if (getLockRemaining() > 0) return;
  const input = document.getElementById('authInput');
  const errorEl = document.getElementById('authError');
  const val = input.value;
  if (!val) return;
  const hash = await sha256(val);
  if (hash === PASS_HASH) {
    sessionStorage.setItem(SESSION_KEY, '1');
    localStorage.removeItem(TRIES_KEY);
    localStorage.removeItem(LOCK_KEY);
    hideAuth();
  } else {
    const tries = parseInt(localStorage.getItem(TRIES_KEY)||'0') + 1;
    localStorage.setItem(TRIES_KEY, tries);
    input.value = '';
    input.classList.add('error');
    setTimeout(() => input.classList.remove('error'), 400);
    if (tries >= MAX_TRIES) {
      localStorage.setItem(LOCK_KEY, Date.now() + LOCK_MS);
      errorEl.textContent = 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§.';
      updateLockUI();
    } else {
      errorEl.textContent = `ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§. (${MAX_TRIES - tries}Ìöå ÎÇ®Ïùå)`;
      document.getElementById('authLockMsg').textContent = '';
    }
    input.focus();
  }
}

document.getElementById('authBtn').addEventListener('click', tryAuth);
document.getElementById('authInput').addEventListener('keydown', e => { if (e.key==='Enter') tryAuth(); });

if (isAuthenticated()) { hideAuth(); }
else { showAuth(); updateLockUI(); setTimeout(() => document.getElementById('authInput').focus(), 100); }

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "AIzaSyDnEOATYmwq0WJr6pCl-86-Q3ZEQjrrfeY",
  authDomain:        "drgo-calender.firebaseapp.com",
  projectId:         "drgo-calender",
  storageBucket:     "drgo-calender.firebasestorage.app",
  messagingSenderId: "163730741115",
  appId:             "1:163730741115:web:73a06d5b1cf1a477734fde"
};
const app       = initializeApp(firebaseConfig);
const db        = getFirestore(app);
const eventsCol = collection(db, 'events');


const MONTHS = ['1Ïõî','2Ïõî','3Ïõî','4Ïõî','5Ïõî','6Ïõî','7Ïõî','8Ïõî','9Ïõî','10Ïõî','11Ïõî','12Ïõî'];
const TYPE_LABELS = { gold:'Í∞úÏù∏ÏùòÎ¢∞', blue:'ÏÇ¨ÎÇ¥ÏóÖÎ¨¥', red:'Ìú¥Í∞ÄÍ¥ÄÎ†®', green:'Ï¥¨ÏòÅÍ¥ÄÎ†®', purple:'ÎØ∏ÌåÖ/ÎÇ¥Î∞©' };

const KR_HOLIDAYS = {
  '2024-01-01':'1Ïõî 1Ïùº','2024-02-09':'ÏÑ§ÎÇ† Ï†ÑÎÇ†','2024-02-10':'ÏÑ§ÎÇ†','2024-02-11':'ÏÑ§ÎÇ† Îã§Ïùå ÎÇ†','2024-02-12':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº(ÏÑ§ÎÇ†)',
  '2024-03-01':'3¬∑1Ï†à','2024-04-10':'Ï†ú22ÎåÄÍµ≠ÌöåÏùòÏõêÏÑ†Í±∞','2024-05-05':'Ïñ¥Î¶∞Ïù¥ÎÇ†','2024-05-06':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº(Ïñ¥Î¶∞Ïù¥ÎÇ†)',
  '2024-05-15':'Î∂ÄÏ≤òÎãò Ïò§Ïã† ÎÇ†','2024-06-06':'ÌòÑÏ∂©Ïùº','2024-08-15':'Í¥ëÎ≥µÏ†à','2024-09-16':'Ï∂îÏÑù Ï†ÑÎÇ†',
  '2024-09-17':'Ï∂îÏÑù','2024-09-18':'Ï∂îÏÑù Îã§Ïùå ÎÇ†','2024-10-01':'ÏûÑÏãúÍ≥µÌú¥Ïùº','2024-10-03':'Í∞úÏ≤úÏ†à',
  '2024-10-09':'ÌïúÍ∏ÄÎÇ†','2024-12-25':'Í∏∞ÎèÖÌÉÑÏã†Ïùº',
  '2025-01-01':'1Ïõî 1Ïùº','2025-01-27':'ÏûÑÏãúÍ≥µÌú¥Ïùº','2025-01-28':'ÏÑ§ÎÇ† Ï†ÑÎÇ†','2025-01-29':'ÏÑ§ÎÇ†',
  '2025-01-30':'ÏÑ§ÎÇ† Îã§Ïùå ÎÇ†','2025-03-01':'3¬∑1Ï†à','2025-03-03':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº(3¬∑1Ï†à)',
  '2025-05-05':'Ïñ¥Î¶∞Ïù¥ÎÇ†¬∑Î∂ÄÏ≤òÎãò Ïò§Ïã† ÎÇ†','2025-05-06':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº(Î∂ÄÏ≤òÎãò Ïò§Ïã† ÎÇ†)',
  '2025-06-03':'ÏûÑÏãúÍ≥µÌú¥Ïùº(ÎåÄÌÜµÎ†πÏÑ†Í±∞)','2025-06-06':'ÌòÑÏ∂©Ïùº','2025-08-15':'Í¥ëÎ≥µÏ†à',
  '2025-10-03':'Í∞úÏ≤úÏ†à','2025-10-05':'Ï∂îÏÑù Ï†ÑÎÇ†','2025-10-06':'Ï∂îÏÑù','2025-10-07':'Ï∂îÏÑù Îã§Ïùå ÎÇ†',
  '2025-10-08':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº(Ï∂îÏÑù)','2025-10-09':'ÌïúÍ∏ÄÎÇ†','2025-12-25':'Í∏∞ÎèÖÌÉÑÏã†Ïùº',
  '2026-01-01':'1Ïõî 1Ïùº','2026-02-16':'ÏÑ§ÎÇ† Ï†ÑÎÇ†','2026-02-17':'ÏÑ§ÎÇ†','2026-02-18':'ÏÑ§ÎÇ† Îã§Ïùå ÎÇ†',
  '2026-03-01':'3¬∑1Ï†à','2026-03-02':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº(3¬∑1Ï†à)','2026-05-05':'Ïñ¥Î¶∞Ïù¥ÎÇ†',
  '2026-05-24':'Î∂ÄÏ≤òÎãò Ïò§Ïã† ÎÇ†','2026-05-25':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº(Î∂ÄÏ≤òÎãò Ïò§Ïã† ÎÇ†)',
  '2026-06-03':'Ï†ÑÍµ≠ÎèôÏãúÏßÄÎ∞©ÏÑ†Í±∞','2026-06-06':'ÌòÑÏ∂©Ïùº','2026-07-17':'Ï†úÌóåÏ†à','2026-08-15':'Í¥ëÎ≥µÏ†à',
  '2026-08-17':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº(Í¥ëÎ≥µÏ†à)','2026-09-24':'Ï∂îÏÑù Ï†ÑÎÇ†','2026-09-25':'Ï∂îÏÑù',
  '2026-09-26':'Ï∂îÏÑù Îã§Ïùå ÎÇ†','2026-10-03':'Í∞úÏ≤úÏ†à','2026-10-05':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº(Í∞úÏ≤úÏ†à)',
  '2026-10-09':'ÌïúÍ∏ÄÎÇ†','2026-12-25':'Í∏∞ÎèÖÌÉÑÏã†Ïùº',
  '2027-01-01':'1Ïõî 1Ïùº','2027-03-01':'3¬∑1Ï†à','2027-05-05':'Ïñ¥Î¶∞Ïù¥ÎÇ†','2027-06-06':'ÌòÑÏ∂©Ïùº',
  '2027-08-15':'Í¥ëÎ≥µÏ†à','2027-10-03':'Í∞úÏ≤úÏ†à','2027-10-09':'ÌïúÍ∏ÄÎÇ†','2027-12-25':'Í∏∞ÎèÖÌÉÑÏã†Ïùº',
};
function getHoliday(dk) { return KR_HOLIDAYS[dk] || null; }

const IMG_MAX_PX = 800;
const IMG_QUALITY = 0.72;
function compressImage(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      let { width: w, height: h } = img;
      if (w > IMG_MAX_PX || h > IMG_MAX_PX) {
        if (w >= h) { h = Math.round(h * IMG_MAX_PX / w); w = IMG_MAX_PX; }
        else        { w = Math.round(w * IMG_MAX_PX / h); h = IMG_MAX_PX; }
      }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      URL.revokeObjectURL(url);
      resolve(canvas.toDataURL('image/jpeg', IMG_QUALITY));
    };
    img.onerror = reject;
    img.src = url;
  });
}

let currentYear, currentMonth;
let events = [];
let editingId = null;
const today    = new Date();
const todayStr = fmtDate(today);

function fmtDate(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function dateKey(y, m, d) {
  return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}
function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

function setLoading(on) { document.getElementById('loadingOverlay').style.display = on ? 'flex' : 'none'; }
function setSaving(on) {
  const btn = document.getElementById('saveBtn');
  const btnT = document.getElementById('saveBtnTop');
  btn.disabled = btnT.disabled = on;
  btn.textContent = btnT.textContent = on ? 'Ï†ÄÏû• Ï§ë‚Ä¶' : 'Ï†ÄÏû•';
}

/* ‚îÄ‚îÄ [ÏàòÏ†ï 1] Firebase Î°úÎî© ÌÉÄÏûÑÏïÑÏõÉ Ï∂îÍ∞Ä ‚îÄ‚îÄ */
setLoading(true);
const loadingTimeout = setTimeout(() => {
  setLoading(false);
  console.warn('Firebase ÏùëÎãµ ÏóÜÏùå ‚Äî Î°úÎî© Í∞ïÏ†ú Ìï¥Ï†ú');
}, 10000);

onSnapshot(eventsCol, snap => {
  clearTimeout(loadingTimeout);
  events = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
  setLoading(false);
  if (typeof renderAll === 'function') renderAll(); else render();
}, err => {
  clearTimeout(loadingTimeout);
  console.error('Firestore Ïò§Î•ò:', err);
  setLoading(false);
  alert('Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\nÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
});

function getSpecialIconStr(ev) {
  if (!ev.specialOpts || ev.specialOpts.length === 0) return '';
  return ev.specialOpts.map(k => SPECIAL_ICONS[k]||'').join('') + ' ';
}
function getSchedSuffix(ev) {
  if (!ev.schedOpt || !SCHED_OPTS[ev.schedOpt]) return '';
  return `<span class="sched-icon-badge" title="${SCHED_OPTS[ev.schedOpt].desc}">${SCHED_OPTS[ev.schedOpt].icon}</span>`;
}
function dateDiff(d1, d2) {
  return (new Date(d2+'T00:00:00') - new Date(d1+'T00:00:00')) / 86400000;
}

function render() {
  document.getElementById('monthLabel').textContent = `${currentYear}ÎÖÑ ${MONTHS[currentMonth]}`;
  const grid = document.getElementById('daysGrid');
  grid.innerHTML = '';

  const firstDay    = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
  const prevDays    = new Date(currentYear, currentMonth, 0).getDate();

  const cells = [];
  for (let i=firstDay-1;i>=0;i--) cells.push({day:prevDays-i,cur:false,y:currentYear,m:currentMonth-1});
  for (let d=1;d<=daysInMonth;d++) cells.push({day:d,cur:true,y:currentYear,m:currentMonth});
  let nx=1;
  while (cells.length%7!==0) cells.push({day:nx++,cur:false,y:currentYear,m:currentMonth+1});

  const gridDates = cells.map(cell => {
    const realY = cell.m<0 ? cell.y-1 : cell.m>11 ? cell.y+1 : cell.y;
    const realM = ((cell.m%12)+12)%12;
    return dateKey(realY, realM, cell.day);
  });
  const NUM_WEEKS = gridDates.length / 7;
  const isSpanEv  = ev => ev.allDay !== false || ev.startDate !== (ev.endDate||ev.startDate);

  const sorted = filteredEvents().map((ev,idx_)=>({ev,idx:events.indexOf(ev)})).sort((a,b) => {
    const aS=isSpanEv(a.ev), bS=isSpanEv(b.ev);
    if (aS&&!bS) return -1; if (!aS&&bS) return 1;
    if (a.ev.startDate<b.ev.startDate) return -1;
    if (a.ev.startDate>b.ev.startDate) return  1;
    return dateDiff(a.ev.startDate,a.ev.endDate||a.ev.startDate) <
           dateDiff(b.ev.startDate,b.ev.endDate||b.ev.startDate) ? 1 : -1;
  });

  const laneMap = {};
  for (let w=0;w<NUM_WEEKS;w++) {
    const wDates = gridDates.slice(w*7, w*7+7);
    const wStart = wDates[0], wEnd = wDates[6];
    const wSpans = sorted.filter(({ev}) =>
      isSpanEv(ev) && ev.startDate<=wEnd && (ev.endDate||ev.startDate)>=wStart);
    const laneEnd = [];
    wSpans.forEach(({ev,idx}) => {
      const cS = ev.startDate>wStart ? ev.startDate : wStart;
      const cE = (ev.endDate||ev.startDate)<wEnd ? (ev.endDate||ev.startDate) : wEnd;
      let lane=0;
      while (laneEnd[lane]!==undefined && laneEnd[lane]>=cS) lane++;
      laneEnd[lane]=cE;
      laneMap[idx] = laneMap[idx]===undefined ? lane : Math.max(laneMap[idx],lane);
    });
  }

  const cellMax = {};
  gridDates.forEach(dk => { cellMax[dk]=-1; });
  sorted.forEach(({ev,idx}) => {
    if (!isSpanEv(ev)) return;
    let cur=new Date(ev.startDate+'T00:00:00');
    const end=new Date((ev.endDate||ev.startDate)+'T00:00:00');
    while (cur<=end) {
      const dk=fmtDate(cur);
      if (cellMax[dk]!==undefined) cellMax[dk]=Math.max(cellMax[dk],laneMap[idx]||0);
      cur.setDate(cur.getDate()+1);
    }
  });

  const singleMap = {};
  sorted.forEach(({ev,idx}) => {
    if (isSpanEv(ev)) return;
    (singleMap[ev.startDate]=singleMap[ev.startDate]||[]).push({evIdx:idx,ev});
  });
  Object.keys(singleMap).forEach(dk => {
    singleMap[dk].sort((a,b) => {
      const aAll = a.ev.allDay !== false, bAll = b.ev.allDay !== false;
      if (aAll && !bAll) return -1; if (!aAll && bAll) return 1;
      return (a.ev.startTime||'').localeCompare(b.ev.startTime||'');
    });
  });

  const CELL_PAD=6, DAY_H=26, LANE_H=24;

  for (let w=0;w<NUM_WEEKS;w++) {
    const wDates = gridDates.slice(w*7, w*7+7);
    const wStart = wDates[0], wEnd = wDates[6];
    const weekEl = document.createElement('div');
    weekEl.className = 'week-row';

    for (let d=0;d<7;d++) {
      const cell = cells[w*7+d];
      const dk   = wDates[d];
      const realY= cell.m<0?cell.y-1:cell.m>11?cell.y+1:cell.y;
      const realM= ((cell.m%12)+12)%12;
      const lanes= cellMax[dk]+1;

      const div = document.createElement('div');
      div.className = 'day-cell'+(cell.cur?'':' other-month');
      if (dk===todayStr) div.classList.add('today');

      const numRow = document.createElement('div');
      numRow.className = 'day-num-row';
      const numSpan = document.createElement('span');
      numSpan.className = 'day-num';
      const dow = new Date(realY,realM,cell.day).getDay();
      if (dow===0) numSpan.classList.add('sun');
      if (dow===6) numSpan.classList.add('sat');
      const holiday = getHoliday(dk);
      if (holiday) numSpan.classList.add('holiday');
      numSpan.textContent = cell.day;
      numRow.appendChild(numSpan);
      if (holiday) {
        const hl=document.createElement('span');
        hl.className='holiday-label'; hl.textContent=holiday;
        numRow.appendChild(hl);
      }
      div.appendChild(numRow);

      for (let l=0;l<lanes;l++) {
        const sp=document.createElement('div'); sp.className='lane-spacer';
        div.appendChild(sp);
      }

      const evList = document.createElement('div');
      evList.className = 'events-list';
      const dayEvs = singleMap[dk]||[];
      const MAX=3;
      dayEvs.slice(0,MAX).forEach(({evIdx,ev})=>{
        const chip=document.createElement('div');
        chip.className=`event-chip single chip-month color-${ev.color||'gold'}`;
        const time=(!ev.allDay&&ev.startTime)?`<span class="chip-time">${ev.startTime}</span>`:'';
        const icons=getSpecialIconStr(ev);
        chip.innerHTML=`${time}<span style="overflow:hidden;text-overflow:ellipsis;flex:1">${icons}${ev.title||'(Ï†úÎ™© ÏóÜÏùå)'}</span>${getSchedSuffix(ev)}`;
        chip.addEventListener('click',e=>{e.stopPropagation();openModal(evIdx);});
        evList.appendChild(chip);
      });
      const spanEvs = sorted
        .filter(({ev}) => isSpanEv(ev) && ev.startDate<=dk && (ev.endDate||ev.startDate)>=dk)
        .map(({ev,idx}) => ({evIdx:idx, ev}));
      const allDayEvs = [...spanEvs, ...dayEvs];
      if (allDayEvs.length>MAX) {
        const more=document.createElement('div');
        more.className='more-badge';
        more.textContent='Ï†ÑÏ≤¥Î≥¥Í∏∞';
        more.addEventListener('click',e=>{e.stopPropagation();openDayPopover(dk,allDayEvs,e.currentTarget);});
        evList.appendChild(more);
      }
      div.appendChild(evList);
      div.addEventListener('click',()=>openNewModal(dk));
      weekEl.appendChild(div);
    }

    const overlay = document.createElement('div');
    overlay.className='span-chip-overlay';
    overlay.style.pointerEvents='none';

    sorted.filter(({ev})=>
      isSpanEv(ev) && ev.startDate<=wEnd && (ev.endDate||ev.startDate)>=wStart
    ).forEach(({ev,idx})=>{
      const lane   = laneMap[idx]||0;
      const sd=ev.startDate, ed=ev.endDate||ev.startDate;
      const chipStart = sd > wStart ? sd : wStart;
      const chipEnd   = ed < wEnd   ? ed : wEnd;
      const colStart  = wDates.findIndex(dk => dk === chipStart);
      const colEnd    = wDates.findIndex(dk => dk === chipEnd);
      if (colStart < 0) return;
      // colEndÍ∞Ä -1Ïù¥Î©¥ wEnd ÏûêÏ≤¥Í∞Ä wDates ÎßàÏßÄÎßâ(index 6)Ïù¥ÎØÄÎ°ú 6ÏúºÎ°ú
      const aCE = colEnd < 0 ? 6 : colEnd;

      // Ï∂îÍ∞Ä: aCEÍ∞Ä colStartÎ≥¥Îã§ ÏûëÏúºÎ©¥ skip
      if (aCE < colStart) return;
      const visS=sd>=wStart, visE=ed<=wEnd;

      const chip=document.createElement('div');
      chip.className=`span-chip color-${ev.color||'gold'}`;
      if (visS&&visE) chip.classList.add('is-solo');
      else if (visS)  chip.classList.add('is-start');
      else if (visE)  chip.classList.add('is-end');

      const topPx   = CELL_PAD+DAY_H+lane*LANE_H;
      const leftPct = (colStart/7*100).toFixed(4);
      const widthPct= ((aCE-colStart+1)/7*100).toFixed(4);
      chip.style.top    = topPx+'px';
      chip.style.height = '22px';
      chip.style.pointerEvents = 'all';

      /* ‚îÄ‚îÄ [ÏàòÏ†ï 2] ÏõîÍ∞ÑÎ∑∞ span chip ÏúÑÏπò Í≥ÑÏÇ∞ ÏàòÏ†ï ‚îÄ‚îÄ */
      const colSpan  = aCE - colStart + 1;
      const leftPx   = visS ? 1 : 0;
      const rightPx  = visE ? 1 : 0;
      chip.style.left  = `calc(${(colStart / 7 * 100).toFixed(4)}% + ${leftPx}px)`;
      chip.style.width = `calc(${(colSpan  / 7 * 100).toFixed(4)}% - ${leftPx + rightPx}px)`;

      if (visS||colStart===0) {
        const icons=getSpecialIconStr(ev);
        chip.innerHTML=`<span style="overflow:hidden;text-overflow:ellipsis;min-width:0;flex:1">${icons}${ev.title||'(Ï†úÎ™© ÏóÜÏùå)'}</span>${getSchedSuffix(ev)}`;
      } else { chip.innerHTML='&nbsp;'; }

      chip.addEventListener('click',e=>{e.stopPropagation();openModal(idx);});
      overlay.appendChild(chip);
    });

    weekEl.appendChild(overlay);
    grid.appendChild(weekEl);
  }
}

let currentAttachments=[];
let currentColor='gold';
let isLocked=false;
let isAllDay=true;
let specialOpts=new Set();

const SPECIAL_ICONS = { car:'üöó', brief:'üíº', return:'‚Üê', group:'üë•', urgent:'üö®', ladder:'‚ñ§' };
const SCHED_OPTS = {
  suggest: { icon:'üí¨', label:'Ï†úÏïà', desc:'ÏÉÅÎåÄÎ∞©ÏóêÍ≤å ÏùºÏ†ï Ï†úÏïàÏ§ë' },
  hope:    { icon:'üôè', label:'Ìù¨Îßù', desc:'ÏÉÅÎåÄÎ∞©Ïù¥ ÏùºÏ†ï Ìù¨Îßù' },
  target:  { icon:'üéØ', label:'Î™©Ìëú', desc:'ÏÉÅÎåÄÎ∞©Ïù¥ Ìï¥ÎãπÎÇ†ÏßúÍπåÏßÄ Î™©ÌëúÎ°ú ÏõêÌï®' },
};
let schedOpt = null;
let goldImgs={quote:[],ref:[],room:[]};

function setAllDay(val){
  isAllDay=val;
  /* ÏïåÎ¶º UI: Ï¢ÖÏùºÏù¥Î©¥ select Ïà®Í∏∞Í≥† Í≥†Ï†ï Î†àÏù¥Î∏î ÌëúÏãú */
  const sel=document.getElementById('notifSelect');
  const lbl=document.getElementById('notifAlldayLabel');
  if(val){ sel.style.display='none'; lbl.style.display=''; }
  else   { sel.style.display=''; lbl.style.display='none'; }
  document.getElementById('alldayTrack').classList.toggle('on',val);
  document.getElementById('startTime').disabled=val||isLocked;
  document.getElementById('endTime').disabled=val||isLocked;
}
document.getElementById('alldayToggle').addEventListener('click',()=>{ if(isLocked) return; setAllDay(!isAllDay); });

/* dt-input Ïπ∏ ÏïÑÎ¨¥Îç∞ÎÇò ÌÅ¥Î¶≠Ìï¥ÎèÑ picker Ïó¥Î¶¨ÎèÑÎ°ù */
document.querySelectorAll('.dt-input').forEach(input => {
  input.addEventListener('click', e => {
    if (isLocked || input.disabled) return;
    try { input.showPicker(); } catch(_) {}
  });
});

function setColor(c){
  currentColor=c;
  document.querySelectorAll('.color-dot').forEach(d=>d.classList.toggle('active',d.dataset.color===c));
  document.getElementById('modalStrip').className='modal-strip color-'+c;
  const badge=document.getElementById('typeBadge');
  badge.className='type-badge '+c;
  badge.textContent='‚óè '+TYPE_LABELS[c];
  const isGold=c==='gold';
  document.getElementById('commonFields').style.display=isGold?'none':'flex';
  document.getElementById('commonFields').style.flexDirection='column';
  document.getElementById('goldTemplate').style.display=isGold?'flex':'none';
  document.getElementById('generalAttachSection').style.display=isGold?'none':'block';
}
document.getElementById('colorRow').addEventListener('click',e=>{
  if (e.target.dataset.color&&!isLocked) setColor(e.target.dataset.color);
});

document.getElementById('specialOpts').addEventListener('click', e => {
  const btn = e.target.closest('.special-opt-btn');
  if (!btn || isLocked) return;
  const opt = btn.dataset.opt;
  if (specialOpts.has(opt)) { specialOpts.delete(opt); btn.classList.remove('active'); }
  else                       { specialOpts.add(opt);    btn.classList.add('active'); }
});

document.getElementById('scheduleOpts').addEventListener('click', e => {
  const btn = e.target.closest('.sched-opt-btn');
  if (!btn || isLocked) return;
  const sopt = btn.dataset.sopt;
  if (schedOpt === sopt) { schedOpt = null; btn.classList.remove('active'); }
  else {
    document.querySelectorAll('.sched-opt-btn').forEach(b => b.classList.remove('active'));
    schedOpt = sopt; btn.classList.add('active');
  }
  const desc = document.getElementById('schedOptDesc');
  desc.textContent = schedOpt ? SCHED_OPTS[schedOpt].desc : '';
});

function setSpecialOpts(opts, sopt) {
  specialOpts = new Set(opts||[]);
  document.querySelectorAll('.special-opt-btn').forEach(btn => {
    btn.classList.toggle('active', specialOpts.has(btn.dataset.opt));
  });
  schedOpt = sopt || null;
  document.querySelectorAll('.sched-opt-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.sopt === schedOpt);
  });
  const descEl = document.getElementById('schedOptDesc');
  if (descEl) descEl.textContent = schedOpt ? (SCHED_OPTS[schedOpt]?.desc||'') : '';
}

function initRadioGroup(groupId){
  const g=document.getElementById(groupId); if(!g) return;
  g.querySelectorAll('.radio-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      if (isLocked) return;
      g.querySelectorAll('.radio-btn').forEach(b=>b.classList.remove('active','active-red','active-green'));
      btn.classList.add('active');
      if (groupId==='g_balance_group')
        document.getElementById('g_balance_amount_wrap').classList.toggle('visible',btn.dataset.val==='O');
    });
  });
}
function getRadio(gid){ const g=document.getElementById(gid); if(!g) return ''; const a=g.querySelector('.radio-btn.active'); return a?a.dataset.val:''; }
function setRadio(gid,val){
  const g=document.getElementById(gid); if(!g) return;
  g.querySelectorAll('.radio-btn').forEach(b=>{
    b.classList.remove('active','active-red','active-green');
    if (b.dataset.val===val) b.classList.add('active');
  });
  if (gid==='g_balance_group')
    document.getElementById('g_balance_amount_wrap').classList.toggle('visible',val==='O');
}
['g_career_group','g_paid_group','g_order_group','g_balance_group','g_topic_group'].forEach(initRadioGroup);

/* Î∞©ÏÜ° Ï£ºÏ†ú "Í∏∞ÌÉÄ" ÏÑ†ÌÉù Ïãú Ï£ºÍ¥ÄÏãù ÏûÖÎ†•ÎûÄ ÌÜ†Í∏Ä */
(function(){
  const g = document.getElementById('g_topic_group');
  if (!g) return;
  const wrap = document.getElementById('g_topic_etc_wrap');
  function updateTopicEtc(){
    const active = g.querySelector('.radio-btn.active');
    const isEtc = active && active.dataset.val === 'Í∏∞ÌÉÄ';
    if (wrap) wrap.classList.toggle('visible', isEtc);
    if (!isEtc) { const e=document.getElementById('g_topic_etc'); if(e) e.value=''; }
  }
  g.querySelectorAll('.radio-btn').forEach(btn => btn.addEventListener('click', updateTopicEtc));
})();

function resetGoldFields(){
  ['g_name','g_phone','g_platform','g_equipment','g_req_topic','g_req_detail','g_special','g_balance_amount'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  const etcEl=document.getElementById('g_topic_etc'); if(etcEl) etcEl.value='';
  document.getElementById('g_topic_group').querySelectorAll('.radio-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('g_topic_etc_wrap').classList.remove('visible');
  setRadio('g_career_group','Ï≤òÏùå'); setRadio('g_paid_group','ÎØ∏Í≤∞Ï†ú');
  setRadio('g_order_group','X'); setRadio('g_balance_group','X');
  goldImgs={quote:[],ref:[],room:[]};
  renderImgGrid('quote'); renderImgGrid('ref'); renderImgGrid('room');
}

function loadGoldFields(ev){
  const g=ev.gold||{};
  const MAP={g_name:'name',g_phone:'phone',g_platform:'platform',
    g_equipment:'equipment',g_req_topic:'req_topic',g_req_detail:'req_detail',
    g_special:'special',g_balance_amount:'balance_amount'};
  Object.entries(MAP).forEach(([id,key])=>{ const el=document.getElementById(id); if(el) el.value=g[key]||''; });
  /* Î∞©ÏÜ° Ï£ºÏ†ú Î≥µÏõê: ÏÜåÌÜµ/Î®πÎ∞©/Í≤åÏûÑ/ÏïºÏô∏/Í∏∞ÌÉÄ Ï§ë ÌïòÎÇòÎ©¥ Î≤ÑÌäº ÏÑ†ÌÉù, ÏïÑÎãàÎ©¥ Í∏∞ÌÉÄ+ÏûÖÎ†•ÎûÄ */
  const TOPIC_VALS=['ÏÜåÌÜµ','Î®πÎ∞©','Í≤åÏûÑ','ÏïºÏô∏'];
  const savedTopic = g.topic||'';
  if (TOPIC_VALS.includes(savedTopic)) {
    setRadio('g_topic_group', savedTopic);
    document.getElementById('g_topic_etc_wrap').classList.remove('visible');
  } else if (savedTopic) {
    setRadio('g_topic_group','Í∏∞ÌÉÄ');
    document.getElementById('g_topic_etc').value = savedTopic;
    document.getElementById('g_topic_etc_wrap').classList.add('visible');
  } else {
    document.getElementById('g_topic_group').querySelectorAll('.radio-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('g_topic_etc_wrap').classList.remove('visible');
  }
  setRadio('g_career_group',g.career||'Ï≤òÏùå'); setRadio('g_paid_group',g.paid||'ÎØ∏Í≤∞Ï†ú');
  setRadio('g_order_group',g.order||'X'); setRadio('g_balance_group',g.balance||'X');
  document.getElementById('g_balance_amount').value=g.balance_amount||'';
  goldImgs={
    quote:(g.quoteImgs||[]).map(i=>({name:i.name,data:i.data})),
    ref:  (g.refImgs  ||[]).map(i=>({name:i.name,data:i.data})),
    room: (g.roomImgs ||[]).map(i=>({name:i.name,data:i.data})),
  };
  renderImgGrid('quote'); renderImgGrid('ref'); renderImgGrid('room');
}

function collectGoldTextFields(){
  const topicSel = getRadio('g_topic_group');
  const topic = topicSel === 'Í∏∞ÌÉÄ'
    ? (document.getElementById('g_topic_etc').value.trim() || 'Í∏∞ÌÉÄ')
    : topicSel;
  return {
    name:document.getElementById('g_name').value.trim(), phone:document.getElementById('g_phone').value.trim(),
    platform:document.getElementById('g_platform').value.trim(), topic,
    equipment:document.getElementById('g_equipment').value.trim(), req_topic:document.getElementById('g_req_topic').value.trim(),
    req_detail:document.getElementById('g_req_detail').value.trim(), special:document.getElementById('g_special').value.trim(),
    career:getRadio('g_career_group'), paid:getRadio('g_paid_group'), order:getRadio('g_order_group'),
    balance:getRadio('g_balance_group'), balance_amount:document.getElementById('g_balance_amount').value.trim(),
    quoteImgs:goldImgs.quote.map(i=>({name:i.name,data:i.data})),
    refImgs:goldImgs.ref.map(i=>({name:i.name,data:i.data})),
    roomImgs:goldImgs.room.map(i=>({name:i.name,data:i.data})),
  };
}

function openNewModal(dk){
  editingId=null;
  document.getElementById('modalDateBadge').textContent=formatDateBadge(dk);
  ['modalTitle','modalName','modalAddress','modalDesc'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('modalLocation').value='';
  document.getElementById('startDate').value=dk;
  document.getElementById('endDate').value=dk;
  document.getElementById('startTime').value='09:00';
  document.getElementById('endTime').value='10:00';
  currentAttachments=[]; currentColor='gold'; isLocked=false;
  document.getElementById('notifSelect').value='';
  setColor('gold'); setAllDay(false); setSpecialOpts([],null);
  resetGoldFields(); renderAttachments();
  document.getElementById('deleteBtn').style.display='none';
  document.getElementById('modalOverlay').classList.add('open');
  applyLockState();
  if (!isMobile() && pcView==='month') document.getElementById('modalTitle').focus();
  setTimeout(()=>{ refreshAutoResize(); _takeSnapshot(); }, 30);
}

function openModal(evIdx){
  const ev=events[evIdx];
  editingId=ev._id;
  document.getElementById('modalDateBadge').textContent=formatDateBadge(ev.startDate);
  document.getElementById('modalTitle').value=ev.title||'';
  document.getElementById('modalLocation').value=ev.location||'';
  const nm=ev.notifMinutes; document.getElementById('notifSelect').value=(nm&&nm!=='allday')?nm:'';
  document.getElementById('modalName').value=ev.name||'';
  document.getElementById('modalAddress').value=ev.address||'';
  document.getElementById('modalDesc').value=ev.desc||'';
  document.getElementById('startDate').value=ev.startDate||'';
  document.getElementById('endDate').value=ev.endDate||ev.startDate||'';
  document.getElementById('startTime').value=ev.startTime||'09:00';
  document.getElementById('endTime').value=ev.endTime||'10:00';
  currentAttachments=ev.attachments?JSON.parse(JSON.stringify(ev.attachments)):[];
  currentColor=ev.color||'gold'; isLocked=ev.locked||false;
  setColor(currentColor); setAllDay(ev.allDay!==false);
  if (currentColor==='gold') loadGoldFields(ev); else resetGoldFields();
  setSpecialOpts(ev.specialOpts||[], ev.schedOpt||null);
  renderAttachments();
  document.getElementById('deleteBtn').style.display='';
  document.getElementById('modalOverlay').classList.add('open');
  applyLockState();
  if (!isLocked && !isMobile() && pcView==='month') document.getElementById('modalTitle').focus();
  setTimeout(()=>{ refreshAutoResize(); _takeSnapshot(); }, 30);
}

function formatDateBadge(dk){
  if (!dk) return '';
  const [y,m,d]=dk.split('-').map(Number);
  const dow=['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'][new Date(y,m-1,d).getDay()];
  return `${y}ÎÖÑ ${m}Ïõî ${d}Ïùº (${dow})`;
}

function closeModal(){
  _modalSnapshot = null;
  document.getElementById('modalOverlay').classList.remove('open');
  document.getElementById('fileInput').value='';
  document.getElementById('modal').style.borderColor='';
  editingId=null; isLocked=false;
}

document.getElementById('startDate').addEventListener('change',()=>{
  const sd=document.getElementById('startDate').value;
  const ed=document.getElementById('endDate').value;
  if (!ed||ed<sd) document.getElementById('endDate').value=sd;
  document.getElementById('modalDateBadge').textContent=formatDateBadge(sd);
});

async function saveEvent(){
  /* ÎÇ†Ïßú+ÏãúÍ∞Ñ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ */
  if (!isAllDay) {
    const sd = document.getElementById('startDate').value;
    const ed = document.getElementById('endDate').value || sd;
    const st = document.getElementById('startTime').value || '00:00';
    const et = document.getElementById('endTime').value   || '00:00';
    const startDT = new Date(`${sd}T${st}:00`);
    const endDT   = new Date(`${ed}T${et}:00`);
    if (endDT <= startDT) {
      alert('ÏùºÏ†ï Ï¢ÖÎ£åÏãúÍ∞ÑÏù¥ ÏãúÏûëÏãúÍ∞ÑÎ≥¥Îã§ Îπ†Î¶ÖÎãàÎã§.');
      return;
    }
  }
  setSaving(true);
  try {
    const sd=document.getElementById('startDate').value;
    const ed=document.getElementById('endDate').value||sd;
    const docId = editingId||genId();
    const evData={
      title:document.getElementById('modalTitle').value.trim()||'(Ï†úÎ™© ÏóÜÏùå)',
      startDate:sd, endDate:ed<sd?sd:ed,
      startTime:document.getElementById('startTime').value,
      endTime:document.getElementById('endTime').value,
      allDay:isAllDay, color:currentColor,
      notifMinutes: isAllDay ? 'allday' : (document.getElementById('notifSelect').value || null),
      name:document.getElementById('modalName').value.trim(),
      address:document.getElementById('modalAddress').value.trim(),
      location:document.getElementById('modalLocation').value.trim(),
      desc:document.getElementById('modalDesc').value.trim(),
      attachments:currentAttachments, locked:isLocked,
      specialOpts:[...specialOpts], schedOpt:schedOpt,
      updatedAt:serverTimestamp(),
    };
    if (currentColor==='gold') evData.gold=collectGoldTextFields();
    await setDoc(doc(db,'events',docId), evData);
    _modalSnapshot = null;
    closeModal();
  } catch(e){
    console.error(e);
    if (e.message&&(e.message.includes('maximum')||e.message.includes('exceeds')||e.code==='invalid-argument')) {
      alert('‚ö†Ô∏è Ï†ÄÏû• Ïã§Ìå®: Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÌÅΩÎãàÎã§.\nÏù¥ÎØ∏ÏßÄÎ•º Ï§ÑÏù¥Í±∞ÎÇò Í∞úÏàòÎ•º Ï§ÑÏó¨Ï£ºÏÑ∏Ïöî.');
    } else { alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: '+e.message); }
  }
  setSaving(false);
}

async function deleteEvent(){
  if (!editingId) { closeModal(); return; }
  try { await deleteDoc(doc(db,'events',editingId)); }
  catch(e){ alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò: '+e.message); }
  closeModal();
}

function applyLockState(){
  const modal=document.getElementById('modal');
  const lockBtn=document.getElementById('lockBtn');
  const banner=document.getElementById('lockedBanner');
  const inputs=modal.querySelectorAll('.field-input,.field-textarea,.modal-title-input,.dt-input,.field-select,.notif-select');
  const saveBtn=document.getElementById('saveBtn');
  const deleteBtn=document.getElementById('deleteBtn');
  if (isLocked){
    lockBtn.textContent='üîí'; lockBtn.classList.add('locked'); lockBtn.title='Í≥†Ï†ï Ìï¥Ï†ú';
    banner.classList.add('visible'); modal.style.borderColor='rgba(200,176,138,0.35)';
    inputs.forEach(el=>el.disabled=true);
    document.getElementById('uploadZone').classList.add('locked-zone');
    document.querySelectorAll('.color-dot').forEach(d=>d.classList.add('locked-dot'));
    document.getElementById('alldayTrack').style.pointerEvents='none';
    saveBtn.style.display='none'; deleteBtn.style.display='none';
    document.querySelectorAll('.attachment-remove,.img-remove').forEach(b=>b.classList.add('hidden'));
    document.querySelectorAll('.img-upload-zone').forEach(z=>z.classList.add('locked-zone'));
    document.querySelectorAll('.radio-btn').forEach(b=>b.style.pointerEvents='none');
    document.getElementById('specialOpts').style.pointerEvents='none';
    document.getElementById('specialOpts').style.opacity='0.4';
  } else {
    lockBtn.textContent='üîì'; lockBtn.classList.remove('locked'); lockBtn.title='ÎÇ¥Ïö© Í≥†Ï†ï';
    banner.classList.remove('visible'); modal.style.borderColor='';
    inputs.forEach(el=>el.disabled=false); setAllDay(isAllDay);
    document.getElementById('uploadZone').classList.remove('locked-zone');
    document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('locked-dot'));
    document.getElementById('alldayTrack').style.pointerEvents='';
    saveBtn.style.display='';
    if (editingId) deleteBtn.style.display='';
    document.querySelectorAll('.attachment-remove,.img-remove').forEach(b=>b.classList.remove('hidden'));
    document.querySelectorAll('.img-upload-zone').forEach(z=>z.classList.remove('locked-zone'));
    document.querySelectorAll('.radio-btn').forEach(b=>b.style.pointerEvents='');
    document.getElementById('specialOpts').style.pointerEvents='';
    document.getElementById('specialOpts').style.opacity='';
  }
}

document.getElementById('lockBtn').addEventListener('click', async ()=>{
  isLocked=!isLocked;
  if (!editingId) {
    setSaving(true);
    try {
      const sd=document.getElementById('startDate').value;
      const ed=document.getElementById('endDate').value||sd;
      const docId=genId();
      const evData={
        title:document.getElementById('modalTitle').value.trim()||'(Ï†úÎ™© ÏóÜÏùå)',
        startDate:sd, endDate:ed<sd?sd:ed,
        startTime:document.getElementById('startTime').value,
        endTime:document.getElementById('endTime').value,
        allDay:isAllDay, color:currentColor,
        name:document.getElementById('modalName').value.trim(),
        address:document.getElementById('modalAddress').value.trim(),
        location:document.getElementById('modalLocation').value.trim(),
        desc:document.getElementById('modalDesc').value.trim(),
        attachments:currentAttachments, locked:true,
        specialOpts:[...specialOpts], updatedAt:serverTimestamp(),
      };
      if (currentColor==='gold') evData.gold=collectGoldTextFields();
      await setDoc(doc(db,'events',docId), evData);
      editingId=docId;
      document.getElementById('deleteBtn').style.display='';
    } catch(e){ console.error(e); isLocked=!isLocked; }
    setSaving(false);
  } else {
    try {
      const ev=events.find(e=>e._id===editingId);
      if (ev) {
        const {_id,...evData}=ev;
        await setDoc(doc(db,'events',editingId),{...evData,locked:isLocked,updatedAt:serverTimestamp()});
      }
    } catch(e){ console.error(e); }
  }
  applyLockState();
});

async function handleImgFiles(key, files){
  for (const file of Array.from(files)){
    try {
      const compressed = await compressImage(file);
      goldImgs[key].push({name:file.name, data:compressed});
      renderImgGrid(key);
    } catch(e){
      console.error('Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï Ïã§Ìå®:', e);
      const reader=new FileReader();
      reader.onload=ev=>{ goldImgs[key].push({name:file.name,data:ev.target.result}); renderImgGrid(key); };
      reader.readAsDataURL(file);
    }
  }
}

function renderImgGrid(key){
  const grid=document.getElementById(key+'Grid');
  grid.innerHTML='';
  goldImgs[key].forEach((img,i)=>{
    const item=document.createElement('div'); item.className='img-item';
    const el=document.createElement('img'); el.src=img.data;
    el.addEventListener('click',e=>{e.stopPropagation();openLightbox(img.data);});
    const rm=document.createElement('button');
    rm.className='img-remove'+(isLocked?' hidden':''); rm.innerHTML='‚úï';
    rm.addEventListener('click',e=>{e.stopPropagation();goldImgs[key].splice(i,1);renderImgGrid(key);});
    item.appendChild(el); item.appendChild(rm); grid.appendChild(item);
  });
}

function setupImgZone(zoneId,inputId,key){
  const zone=document.getElementById(zoneId), inp=document.getElementById(inputId);
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('drag-over');});
  zone.addEventListener('dragleave',()=>zone.classList.remove('drag-over'));
  zone.addEventListener('drop',e=>{e.preventDefault();zone.classList.remove('drag-over');handleImgFiles(key,e.dataTransfer.files);});
  inp.addEventListener('change',e=>handleImgFiles(key,e.target.files));
}
setupImgZone('quoteZone','quoteInput','quote');
setupImgZone('refZone','refInput','ref');
setupImgZone('roomZone','roomInput','room');

function handleFiles(files){
  Array.from(files).forEach(file=>{
    const reader=new FileReader();
    reader.onload=e=>{ currentAttachments.push({name:file.name,type:file.type,data:e.target.result}); renderAttachments(); };
    reader.readAsDataURL(file);
  });
}

function renderAttachments(){
  const grid=document.getElementById('attachmentsGrid');
  grid.innerHTML='';
  currentAttachments.forEach((att,i)=>{
    const item=document.createElement('div'); item.className='attachment-item';
    if (att.type.startsWith('image/')){
      const img=document.createElement('img'); img.src=att.data;
      img.addEventListener('click',e=>{e.stopPropagation();openLightbox(att.data);});
      item.appendChild(img);
    } else {
      const icon=document.createElement('div'); icon.className='attachment-icon'; icon.textContent=fileIcon(att.type);
      const name=document.createElement('div'); name.className='attachment-name'; name.textContent=att.name;
      item.appendChild(icon); item.appendChild(name);
    }
    const rm=document.createElement('button');
    rm.className='attachment-remove'+(isLocked?' hidden':''); rm.innerHTML='‚úï';
    rm.addEventListener('click',e=>{e.stopPropagation();currentAttachments.splice(i,1);renderAttachments();});
    item.appendChild(rm); grid.appendChild(item);
  });
}

function fileIcon(t){
  if (t.startsWith('video/')) return 'üìπ';
  if (t.startsWith('audio/')) return 'üéµ';
  if (t.includes('pdf')) return 'üìÑ';
  if (t.includes('zip')||t.includes('rar')) return 'üì¶';
  return 'üìÅ';
}

function openLightbox(src){
  document.getElementById('lightboxImg').src=src;
  document.getElementById('lightbox').classList.add('open');
}

const uploadZone=document.getElementById('uploadZone');
const fileInput=document.getElementById('fileInput');
uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.classList.add('drag-over');});
uploadZone.addEventListener('dragleave',()=>uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop',e=>{e.preventDefault();uploadZone.classList.remove('drag-over');handleFiles(e.dataTransfer.files);});
fileInput.addEventListener('change',e=>handleFiles(e.target.files));

document.getElementById('lightbox').addEventListener('click',()=>document.getElementById('lightbox').classList.remove('open'));
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Î≥ÄÍ≤Ω Í∞êÏßÄ (Dirty Check) + ÎÇòÍ∞ÄÍ∏∞ ÌôïÏù∏
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _modalSnapshot = null;  // Î™®Îã¨ Ïó¥Î¶¥ Îïå Ï∞çÏùÄ Ïä§ÎÉÖÏÉ∑
let _confirmCallback = null; // ÌôïÏù∏ ÌõÑ Ïã§ÌñâÌï† Ìï®Ïàò

function _takeSnapshot() {
  const ids = ['modalTitle','modalLocation','modalName','modalAddress','modalDesc',
    'startDate','endDate','startTime','endTime',
    'g_name','g_phone','g_platform','g_topic_etc','g_equipment',
    'g_req_topic','g_req_detail','g_special','g_balance_amount'];
  const snap = {};
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) snap[id] = el.value;
  });
  // ÎùºÎîîÏò§/ÌÜ†Í∏Ä ÏÉÅÌÉú
  snap._color = currentColor;
  snap._allDay = isAllDay;
  snap._schedOpt = schedOpt;
  snap._specialOpts = JSON.stringify([...specialOpts].sort());
  snap._topic = getRadio('g_topic_group');
  snap._career = getRadio('g_career_group');
  snap._paid = getRadio('g_paid_group');
  snap._order = getRadio('g_order_group');
  snap._balance = getRadio('g_balance_group');
  _modalSnapshot = JSON.stringify(snap);
}

function _isDirty() {
  if (!_modalSnapshot) return false;
  const ids = ['modalTitle','modalLocation','modalName','modalAddress','modalDesc',
    'startDate','endDate','startTime','endTime',
    'g_name','g_phone','g_platform','g_topic_etc','g_equipment',
    'g_req_topic','g_req_detail','g_special','g_balance_amount'];
  const snap = {};
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) snap[id] = el.value;
  });
  snap._color = currentColor;
  snap._allDay = isAllDay;
  snap._schedOpt = schedOpt;
  snap._specialOpts = JSON.stringify([...specialOpts].sort());
  snap._topic = getRadio('g_topic_group');
  snap._career = getRadio('g_career_group');
  snap._paid = getRadio('g_paid_group');
  snap._order = getRadio('g_order_group');
  snap._balance = getRadio('g_balance_group');
  return JSON.stringify(snap) !== _modalSnapshot;
}

function _showConfirm(onLeave) {
  _confirmCallback = onLeave;
  document.getElementById('confirmOverlay').classList.add('open');
}
function _closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('open');
  _confirmCallback = null;
}

function tryCloseModal() {
  if (isLocked) { closeModal(); return; }
  if (_isDirty()) {
    _showConfirm(() => { closeModal(); });
  } else {
    closeModal();
  }
}

document.getElementById('confirmCancel').addEventListener('click', _closeConfirm);
document.getElementById('confirmLeave').addEventListener('click', () => {
  const cb = _confirmCallback;  // Î®ºÏ†Ä Ï†ÄÏû•
  _closeConfirm();              // null Ï¥àÍ∏∞Ìôî
  if (cb) cb();                 // Ï†ÄÏû•Ìï¥Îëî cb Ïã§Ìñâ
});
document.getElementById('confirmOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('confirmOverlay')) _closeConfirm();
});

document.getElementById('closeBtn').addEventListener('click', tryCloseModal);
document.getElementById('saveBtn').addEventListener('click',saveEvent);
document.getElementById('saveBtnTop').addEventListener('click',saveEvent);
document.getElementById('deleteBtn').addEventListener('click',deleteEvent);
document.getElementById('addBtn').addEventListener('click',()=>openNewModal(todayStr));
document.getElementById('modalOverlay').addEventListener('click',e=>{
  if (e.target===document.getElementById('modalOverlay')) tryCloseModal();
});
document.addEventListener('keydown',e=>{
  if (e.key==='Escape'){
    if (document.getElementById('lightbox').classList.contains('open'))
      document.getElementById('lightbox').classList.remove('open');
    else tryCloseModal();
  }
  if (e.key==='Enter'&&(e.ctrlKey||e.metaKey)&&document.getElementById('modalOverlay').classList.contains('open')) saveEvent();
});

(function(){
  const saved=localStorage.getItem('cal_theme');
  if (saved==='light') document.documentElement.classList.add('light');
})();
function applyThemeBtn(){
  document.getElementById('themeBtn').textContent=document.documentElement.classList.contains('light')?'‚òÄÔ∏è':'üåô';
}
document.getElementById('themeBtn').addEventListener('click',()=>{
  const isLight=document.documentElement.classList.toggle('light');
  localStorage.setItem('cal_theme',isLight?'light':'dark');
  applyThemeBtn();
});


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ÏÉâÏÉÅ ÏÑ§Ï†ï Ìå®ÎÑê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const COLOR_STORAGE_KEY = 'cal_custom_colors';

const DEFAULT_COLORS = {
  gold:   '#c8a870',
  blue:   '#7aaec8',
  red:    '#c87070',
  green:  '#70c870',
  purple: '#9b70c8'
};

/* Î∞∞Í≤ΩÏÉâÏóêÏÑú ÏùΩÍ∏∞ Ìé∏Ìïú ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ ÏûêÎèô Í≥ÑÏÇ∞ */
function getContrastText(hex) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  const luminance = (0.299*r + 0.587*g + 0.114*b) / 255;
  return luminance > 0.55 ? '#1a1207' : '#f0ece6';
}

/* hexÎ•º rgba Î∞∞Í≤Ω(Ìà¨Î™ÖÎèÑ Ï†ÅÏö©)ÏúºÎ°ú Î≥ÄÌôò */
function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

/* CSS Î≥ÄÏàòÏóê ÏÉâÏÉÅ Ï¶âÏãú Ï†ÅÏö© */
function applyColorToCss(key, hex) {
  const root = document.documentElement;
  const text = getContrastText(hex);
  root.style.setProperty(`--chip-${key}-bg`,   hex);
  root.style.setProperty(`--chip-${key}-text`,  text);
  /* event-chip single Î∞∞Í≤Ω (Î∞òÌà¨Î™Ö) */
  root.style.setProperty(`--chip-${key}-bg-soft`, hexToRgba(hex, 0.22));
  /* legend, color-dot, swatch Î∞∞Í≤Ω */
  document.querySelectorAll(`.color-dot[data-color="${key}"]`).forEach(el => {
    el.style.color = hex;
    el.style.background = hexToRgba(hex, 0.18);
  });
  document.querySelectorAll(`.color-dot.active[data-color="${key}"]`).forEach(el => {
    el.style.borderColor = hex;
    el.style.background  = hexToRgba(hex, 0.35);
  });
  document.querySelectorAll(`.legend-dot.${key}`).forEach(el => {
    el.style.background = hex;
  });
  /* ÌïÑÌÑ∞ Î≤ÑÌäº dot ÏÉâÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏ */
  const fDot = document.getElementById(`fd-${key}`);
  if (fDot) fDot.style.background = hex;
  /* ÌïÑÌÑ∞ Î≤ÑÌäº ÌôúÏÑ± ÌÖåÎëêÎ¶¨/Î∞∞Í≤ΩÏÉâ Ïù∏ÎùºÏù∏ Î∞òÏòÅ */
  const fBtn = document.querySelector(`.filter-btn.f-${key}`);
  if (fBtn && fBtn.classList.contains('active')) {
    fBtn.style.borderColor = hex;
    fBtn.style.background  = hex.replace(/^#/, '') ? `${hex}26` : '';
  }
  const swatch = document.getElementById(`swatch-${key}`);
  if (swatch) swatch.style.background = hex;
  const picker = document.getElementById(`colorPicker-${key}`);
  if (picker) picker.value = hex;
}

/* Ï†ÄÏû•Îêú ÏÉâÏÉÅ Î∂àÎü¨ÏôÄÏÑú Ï†ÑÏ≤¥ Ï†ÅÏö© */
function loadAndApplyColors() {
  const saved = JSON.parse(localStorage.getItem(COLOR_STORAGE_KEY) || '{}');
  Object.keys(DEFAULT_COLORS).forEach(key => {
    const hex = saved[key] || DEFAULT_COLORS[key];
    applyColorToCss(key, hex);
  });
}

/* ÏÉâÏÉÅ Ï†ÄÏû• */
function saveColor(key, hex) {
  const saved = JSON.parse(localStorage.getItem(COLOR_STORAGE_KEY) || '{}');
  saved[key] = hex;
  localStorage.setItem(COLOR_STORAGE_KEY, JSON.stringify(saved));
  applyColorToCss(key, hex);
}

/* Ï¥àÍ∏∞Ìôî */
function resetAllColors() {
  localStorage.removeItem(COLOR_STORAGE_KEY);
  Object.keys(DEFAULT_COLORS).forEach(key => applyColorToCss(key, DEFAULT_COLORS[key]));
}

/* Ìå®ÎÑê Ïó¥Í∏∞/Îã´Í∏∞ */
const settingsOverlay = document.getElementById('settingsOverlay');
const settingsPanel   = document.getElementById('settingsPanel');

function openSettings() {
  settingsOverlay.classList.add('open');
  settingsPanel.classList.add('open');
  /* Ìå®ÎÑê Ïó¥ Îïå ÌòÑÏû¨ ÏÉâÏÉÅÏùÑ pickerÏóê Î∞òÏòÅ */
  const saved = JSON.parse(localStorage.getItem(COLOR_STORAGE_KEY) || '{}');
  Object.keys(DEFAULT_COLORS).forEach(key => {
    const hex = saved[key] || DEFAULT_COLORS[key];
    const picker = document.getElementById(`colorPicker-${key}`);
    const swatch = document.getElementById(`swatch-${key}`);
    if (picker) picker.value = hex;
    if (swatch) swatch.style.background = hex;
  });
}
function closeSettings() {
  settingsOverlay.classList.remove('open');
  settingsPanel.classList.remove('open');
}

document.getElementById('settingsBtn').addEventListener('click', openSettings);
document.getElementById('settingsCloseBtn').addEventListener('click', closeSettings);
settingsOverlay.addEventListener('click', closeSettings);
document.getElementById('settingsResetBtn').addEventListener('click', () => {
  resetAllColors();
  /* picker Í∞íÎèÑ Ï¥àÍ∏∞Ìôî */
  Object.keys(DEFAULT_COLORS).forEach(key => {
    const picker = document.getElementById(`colorPicker-${key}`);
    const swatch = document.getElementById(`swatch-${key}`);
    if (picker) picker.value = DEFAULT_COLORS[key];
    if (swatch) swatch.style.background = DEFAULT_COLORS[key];
  });
});

/* ‚îÄ‚îÄ Discord ÌÖåÏä§Ìä∏ ÏïåÎ¶º ‚îÄ‚îÄ */
const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1476134717832302777/1JOwl81U3ZDFEzm98g2FSqYVMcVOZjOB1EiLcCdRXXL_GnpgPDC_fv-cuwSKpOFq7SZ1';

document.getElementById('discordTestBtn').addEventListener('click', async () => {
  const btn = document.getElementById('discordTestBtn');
  btn.textContent = 'Ï†ÑÏÜ° Ï§ë...';
  btn.disabled = true;
  try {
    const res = await fetch(DISCORD_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: 'üìÖ Ï∫òÎ¶∞Îçî ÏïåÎ¶º',
        embeds: [{
          title: 'üìÖ ÌÖåÏä§Ìä∏ ÏïåÎ¶º',
          description: '**ÎîîÏä§ÏΩîÎìú ÏïåÎ¶º Ïó∞Í≤∞Ïù¥ Ï†ïÏÉÅÏûÖÎãàÎã§!**',
          color: 0xC8B08A,
          fields: [
            { name: '‚è∞ ÏãúÍ∞Ñ', value: 'ÌÖåÏä§Ìä∏', inline: true },
            { name: 'üìå Ïú†Ìòï', value: 'Í∞úÏù∏ÏùòÎ¢∞', inline: true },
          ],
          timestamp: new Date().toISOString(),
          footer: { text: 'DRGO Calendar' }
        }]
      })
    });
    if (res.ok) {
      btn.textContent = '‚úÖ Ï†ÑÏÜ° ÏôÑÎ£å!';
      setTimeout(() => { btn.textContent = 'üîî ÌÖåÏä§Ìä∏ ÏïåÎ¶º Î≥¥ÎÇ¥Í∏∞'; btn.disabled = false; }, 2500);
    } else {
      btn.textContent = `‚ùå Ïã§Ìå® (${res.status})`;
      setTimeout(() => { btn.textContent = 'üîî ÌÖåÏä§Ìä∏ ÏïåÎ¶º Î≥¥ÎÇ¥Í∏∞'; btn.disabled = false; }, 2500);
    }
  } catch(e) {
    btn.textContent = '‚ùå Ïò§Î•ò: ' + e.message;
    setTimeout(() => { btn.textContent = 'üîî ÌÖåÏä§Ìä∏ ÏïåÎ¶º Î≥¥ÎÇ¥Í∏∞'; btn.disabled = false; }, 3000);
  }
});

/* color-dot active ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïãú border ÏÉâÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ */
const origSetColor = setColor;
window.setColor = function(c) {
  origSetColor(c);
  /* active dotÏóê Ïª§Ïä§ÌÖÄ ÏÉâÏÉÅ Îã§Ïãú Ï†ÅÏö© */
  const saved = JSON.parse(localStorage.getItem(COLOR_STORAGE_KEY) || '{}');
  Object.keys(DEFAULT_COLORS).forEach(key => {
    const hex = saved[key] || DEFAULT_COLORS[key];
    document.querySelectorAll(`.color-dot[data-color="${key}"]`).forEach(el => {
      el.style.color = hex;
      el.style.background = hexToRgba(hex, el.classList.contains('active') ? 0.35 : 0.18);
      if (el.classList.contains('active')) el.style.borderColor = hex;
      else el.style.borderColor = '';
    });
  });
};

/* picker Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ */
Object.keys(DEFAULT_COLORS).forEach(key => {
  const picker = document.getElementById(`colorPicker-${key}`);
  if (!picker) return;
  picker.addEventListener('input', e => saveColor(key, e.target.value));
  picker.addEventListener('change', e => saveColor(key, e.target.value));
});

/* ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï†ÄÏû•Îêú ÏÉâÏÉÅ Ï†ÅÏö© */
loadAndApplyColors();

const dayPopover=document.getElementById('dayPopover');
const dayPopoverDate=document.getElementById('dayPopoverDate');
const dayPopoverList=document.getElementById('dayPopoverList');

function openDayPopover(dk, dayEvs, anchorEl) {
  const [y,m,d]=dk.split('-').map(Number);
  const dow=['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'][new Date(y,m-1,d).getDay()];
  dayPopoverDate.textContent=`${y}ÎÖÑ ${m}Ïõî ${d}Ïùº (${dow})`;
  dayPopoverList.innerHTML='';
  dayEvs.forEach(({evIdx,ev})=>{
    const item=document.createElement('div');
    item.className=`day-popover-item color-${ev.color||'gold'}`;
    const time=(!ev.allDay&&ev.startTime)?`<span class="day-popover-item-time">${ev.startTime}</span>`:'';
    const icons=getSpecialIconStr(ev);
    item.innerHTML=`${time}<span class="day-popover-item-title">${icons}${ev.title||'(Ï†úÎ™© ÏóÜÏùå)'}${getSchedSuffix(ev)}</span>`;
    item.addEventListener('click',()=>{closeDayPopover();openModal(evIdx);});
    dayPopoverList.appendChild(item);
  });
  dayPopover.style.display='block';
  const rect=anchorEl.getBoundingClientRect();
  const pw=dayPopover.offsetWidth||260, ph=dayPopover.offsetHeight||200, margin=8;
  let left=rect.left, top=rect.bottom+margin;
  if (left+pw>window.innerWidth-margin) left=window.innerWidth-pw-margin;
  if (left<margin) left=margin;
  if (top+ph>window.innerHeight-margin) top=rect.top-ph-margin;
  dayPopover.style.left=left+'px'; dayPopover.style.top=top+'px';
}
function closeDayPopover() { dayPopover.style.display='none'; }
document.getElementById('dayPopoverClose').addEventListener('click',closeDayPopover);
document.addEventListener('click',e=>{ if(dayPopover.style.display!=='none'&&!dayPopover.contains(e.target)) closeDayPopover(); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeDayPopover(); });

function autoResize(el) { el.style.height='auto'; el.style.height=el.scrollHeight+'px'; }
function initAutoResize() { document.querySelectorAll('.field-textarea').forEach(el=>{ el.addEventListener('input',()=>autoResize(el)); autoResize(el); }); }
function refreshAutoResize() { document.querySelectorAll('.field-textarea').forEach(el=>autoResize(el)); }

function init(){
  applyThemeBtn(); initAutoResize();
  currentYear=today.getFullYear(); currentMonth=today.getMonth();
}
init();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PC VIEW MODE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let pcView = 'month';
let pcWeekStart = null;
let pcDayDate   = null;

const DOW_LABELS = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
const DOW_KOR    = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
const MONTH_KOR  = ['1Ïõî','2Ïõî','3Ïõî','4Ïõî','5Ïõî','6Ïõî','7Ïõî','8Ïõî','9Ïõî','10Ïõî','11Ïõî','12Ïõî'];

function switchPcView(view) {
  pcView = view;
  document.getElementById('daysGrid').closest('.calendar-wrap').style.display = view==='month' ? '' : 'none';
  document.getElementById('pcWeekView').style.display = view==='week' ? '' : 'none';
  document.getElementById('pcDayView').style.display  = view==='day'  ? '' : 'none';
  document.querySelectorAll('.view-toggle-btn').forEach(btn=>btn.classList.toggle('active',btn.dataset.view===view));
  if (view==='week') { if(!pcWeekStart) pcWeekStart=getPcWeekStart(); renderPcWeek(); }
  else if (view==='day') { if(!pcDayDate) pcDayDate=todayStr; renderPcDay(); }
  else render();
}

function getPcWeekStart() {
  const base=pcDayDate||todayStr;
  const d=new Date(base+'T00:00:00');
  d.setDate(d.getDate()-d.getDay());
  return fmtDate(d);
}

function addDaysPc(dk, n) {
  const d=new Date(dk+'T00:00:00'); d.setDate(d.getDate()+n); return fmtDate(d);
}

function getEventsForDayPc(dk) {
  return filteredEvents().filter(ev=>{ const sd=ev.startDate, ed=ev.endDate||sd; return sd<=dk&&ed>=dk; })
    .sort((a,b)=>{ const aA=a.allDay!==false,bA=b.allDay!==false; if(aA&&!bA) return -1; if(!aA&&bA) return 1; return (a.startTime||'').localeCompare(b.startTime||''); });
}

function renderPcWeek() {
  const hdr=document.getElementById('pcWeekDays');
  hdr.innerHTML='';
  DOW_LABELS.forEach(d=>{ const el=document.createElement('div'); el.className='weekday'; el.textContent=d; hdr.appendChild(el); });

  const grid=document.getElementById('pcWeekGrid');
  grid.innerHTML='';

  const wStart=pcWeekStart, wEnd=addDaysPc(wStart,6);
  const wDates=Array.from({length:7},(_,i)=>addDaysPc(wStart,i));
  const isSpan=ev=>ev.allDay!==false||(ev.endDate&&ev.endDate!==ev.startDate);

  const spanEvs=filteredEvents().map((ev)=>({ev,idx:events.indexOf(ev)}))
    .filter(({ev})=>isSpan(ev)&&ev.startDate<=wEnd&&(ev.endDate||ev.startDate)>=wStart)
    .sort((a,b)=>{
      const lenA=dateDiff(a.ev.startDate,a.ev.endDate||a.ev.startDate);
      const lenB=dateDiff(b.ev.startDate,b.ev.endDate||b.ev.startDate);
      if (a.ev.startDate!==b.ev.startDate) return a.ev.startDate<b.ev.startDate?-1:1;
      return lenB-lenA;
    });

  const laneMap={}, laneEnd=[];
  spanEvs.forEach(({ev,idx})=>{
    const cS=ev.startDate>wStart?ev.startDate:wStart;
    const cE=(ev.endDate||ev.startDate)<wEnd?(ev.endDate||ev.startDate):wEnd;
    let lane=0;
    while (laneEnd[lane]!==undefined&&laneEnd[lane]>=cS) lane++;
    laneEnd[lane]=cE; laneMap[idx]=lane;
  });
  const maxLane=laneEnd.length>0?laneEnd.length:0;

  const singleMap={};
  filteredEvents().forEach((ev)=>{ const idx=events.indexOf(ev);
    if (isSpan(ev)) return;
    const dk=ev.startDate;
    if (dk<wStart||dk>wEnd) return;
    (singleMap[dk]=singleMap[dk]||[]).push({ev,idx});
  });
  Object.values(singleMap).forEach(arr=>arr.sort((a,b)=>(a.ev.startTime||'').localeCompare(b.ev.startTime||'')));

  const CELL_PAD=8, NUM_H=30, LANE_H=24;
  const SINGLE_OFFSET=CELL_PAD+NUM_H+maxLane*LANE_H+(maxLane>0?4:0);
  const MIN_CELL_H=SINGLE_OFFSET+80;

  const row=document.createElement('div');
  row.className='pc-week-row';
  row.style.minHeight=MIN_CELL_H+'px';

  wDates.forEach((dk,i)=>{
    const [y,m,d]=dk.split('-').map(Number);
    const dow=new Date(y,m-1,d).getDay();
    const isToday=dk===todayStr;
    const holiday=getHoliday(dk);

    const cell=document.createElement('div');
    cell.className='pc-week-cell'+(isToday?' today':'');
    cell.style.paddingTop=CELL_PAD+'px';
    cell.addEventListener('click',e=>{
      if (e.target.closest('.event-chip')||e.target.closest('.more-badge')||e.target.closest('.pc-span-chip')) return;
      if (e.target.closest('.pc-week-num')) { pcDayDate=dk; switchPcView('day'); return; }
      openNewModal(dk);
    });

    const numEl=document.createElement('div');
    numEl.className='pc-week-num'+(isToday?' today-num':'')+(holiday?' holiday':dow===0?' sun':dow===6?' sat':'');
    numEl.textContent=d;
    cell.appendChild(numEl);

    if (holiday) { const hl=document.createElement('div'); hl.className='pc-week-holiday'; hl.textContent=holiday; cell.appendChild(hl); }
    if (maxLane>0) { const spacer=document.createElement('div'); spacer.style.height=(maxLane*LANE_H)+'px'; spacer.style.flexShrink='0'; cell.appendChild(spacer); }

    const MAX_SHOW=4;
    const dayEvs=singleMap[dk]||[];
    dayEvs.slice(0,MAX_SHOW).forEach(({ev,idx})=>{
      const chip=document.createElement('div');
      chip.className=`event-chip single color-${ev.color||'gold'}`;
      const icons=getSpecialIconStr(ev);
      const timeStr=ev.startTime?ev.startTime+' ':'';
      chip.innerHTML=`<span class="chip-time">${timeStr}</span><span style="overflow:hidden;text-overflow:ellipsis;flex:1">${icons}${ev.title||''}</span>${getSchedSuffix(ev)}`;
      chip.addEventListener('click',e=>{e.stopPropagation();openModal(idx);});
      cell.appendChild(chip);
    });
    if (dayEvs.length>MAX_SHOW) {
      const more=document.createElement('div'); more.className='more-badge';
      more.textContent=`+${dayEvs.length-MAX_SHOW}`;
      more.addEventListener('click',e=>{e.stopPropagation();pcDayDate=dk;switchPcView('day');});
      cell.appendChild(more);
    }
    row.appendChild(cell);
  });

  const overlay=document.createElement('div');
  overlay.className='pc-week-overlay';

  spanEvs.forEach(({ev,idx})=>{
    const lane=laneMap[idx]||0;
    const sd=ev.startDate, ed=ev.endDate||ev.startDate;
    const colStart=wDates.findIndex(dk=>dk===(sd>wStart?sd:wStart));
    const colEnd=wDates.findIndex(dk=>dk===(ed<wEnd?ed:wEnd));
    if (colStart<0) return;
    const aCE=colEnd<0?6:colEnd;
    const visS=sd>=wStart, visE=ed<=wEnd;

    const chip=document.createElement('div');
    chip.className=`pc-span-chip color-${ev.color||'gold'}`;
    if (visS&&visE) chip.classList.add('is-solo');
    else if (visS)  chip.classList.add('is-start');
    else if (visE)  chip.classList.add('is-end');

    const topPx=CELL_PAD+NUM_H+lane*LANE_H;
    chip.style.top=topPx+'px';
    chip.style.height='22px';

    /* ‚îÄ‚îÄ [ÏàòÏ†ï 3] Ï£ºÍ∞ÑÎ∑∞ span chip ÏúÑÏπò Í≥ÑÏÇ∞ ÏàòÏ†ï ‚îÄ‚îÄ */
    /* grid gap:1px 6Í∞ú ‚Üí NÎ≤à ÏÖÄ left = N*(W+1px)/7, span ÎÑàÎπÑ = span*(W+1px)/7 - 1px */
    const colSpan  = aCE - colStart + 1;
    const insetL   = visS ? 1 : 0;
    const insetR   = visE ? 1 : 0;
    chip.style.left  = `calc(${colStart} * (100% + 1px) / 7 + ${insetL}px)`;
    chip.style.width = `calc(${colSpan}  * (100% + 1px) / 7 - 1px - ${insetL + insetR}px)`;

    if (visS||colStart===0) {
      const icons=getSpecialIconStr(ev);
      chip.innerHTML=`<span style="overflow:hidden;text-overflow:ellipsis;flex:1">${icons}${ev.title||'(Ï†úÎ™© ÏóÜÏùå)'}</span>${getSchedSuffix(ev)}`;
    } else { chip.innerHTML='&nbsp;'; }

    chip.addEventListener('click',e=>{e.stopPropagation();openModal(idx);});
    overlay.appendChild(chip);
  });

  row.appendChild(overlay);
  grid.appendChild(row);

  const [y1,m1,d1]=wStart.split('-').map(Number);
  const [y2,m2,d2]=wEnd.split('-').map(Number);
  document.getElementById('monthLabel').textContent=
    y1===y2?`${y1}ÎÖÑ ${MONTH_KOR[m1-1]} ${d1}Ïùº ‚Äî ${MONTH_KOR[m2-1]} ${d2}Ïùº`
           :`${y1}ÎÖÑ ${MONTH_KOR[m1-1]} ${d1}Ïùº ‚Äî ${y2}ÎÖÑ ${MONTH_KOR[m2-1]} ${d2}Ïùº`;
}

function renderPcDay() {
  const dk=pcDayDate||todayStr;
  const [y,m,d]=dk.split('-').map(Number);
  const dow=new Date(y,m-1,d).getDay();
  const holiday=getHoliday(dk);
  const evs=getEventsForDayPc(dk);

  const hdr=document.getElementById('pcDayHeader');
  hdr.innerHTML=`<span class="pc-day-title">${y}ÎÖÑ ${m}Ïõî ${d}Ïùº</span>
    <span class="pc-day-sub">${DOW_KOR[dow]}ÏöîÏùº</span>
    ${holiday?`<span class="pc-day-holiday">${holiday}</span>`:''}`;

  const list=document.getElementById('pcDayList');
  list.innerHTML='';
  if (evs.length===0) {
    list.innerHTML='<div class="pc-day-empty">Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
  } else {
    evs.forEach(ev=>{
      const idx=events.findIndex(e=>e._id===ev._id);
      const card=document.createElement('div');
      card.className=`pc-day-card color-${ev.color||'gold'}`;
      const timeStr=ev.allDay!==false?'Ï¢ÖÏùº':`${ev.startTime||''}${ev.endTime?' ~ '+ev.endTime:''}`;
      const spanStr=(ev.endDate&&ev.endDate!==ev.startDate)?`<span>${ev.startDate} ~ ${ev.endDate}</span>`:'';
      const icons=getSpecialIconStr(ev);
      card.innerHTML=`
        <div class="pc-day-time">${timeStr}</div>
        <div class="pc-day-body">
          <div class="pc-day-card-title">${icons}${ev.title||'(Ï†úÎ™© ÏóÜÏùå)'}${getSchedSuffix(ev)}</div>
          <div class="pc-day-card-meta">${ev.name?`<span>üë§ ${ev.name}</span>`:''} ${spanStr}</div>
        </div>`;
      card.addEventListener('click',()=>openModal(idx));
      list.appendChild(card);
    });
  }
  document.getElementById('monthLabel').textContent=`${y}ÎÖÑ ${m}Ïõî ${d}Ïùº (${DOW_KOR[dow]})`;
}

['prevBtn','nextBtn','todayBtn'].forEach(id=>{ const old=document.getElementById(id); const fresh=old.cloneNode(true); old.parentNode.replaceChild(fresh,old); });

document.getElementById('prevBtn').addEventListener('click',()=>{
  if (isMobile()) {
    if (mvMode==='month') {
      mvMonthMonth--; if(mvMonthMonth<0){mvMonthMonth=11;mvMonthYear--;}
      mvSelDate=`${mvMonthYear}-${String(mvMonthMonth+1).padStart(2,'0')}-01`;
      renderMvMonth();
    } else if (mvMode==='week') {
      mvWeekStart=addDays(mvWeekStart,-7); mvSelDate=mvWeekStart; renderMvWeek();
    } else {
      mvSelDate=addDays(mvSelDate,-1); renderMvDay(); updateMvNav();
    }
    return;
  }
  if (pcView==='month'){currentMonth--;if(currentMonth<0){currentMonth=11;currentYear--;}render();}
  else if (pcView==='week'){pcWeekStart=addDaysPc(pcWeekStart,-7);renderPcWeek();}
  else{pcDayDate=addDaysPc(pcDayDate,-1);renderPcDay();}
});
document.getElementById('nextBtn').addEventListener('click',()=>{
  if (isMobile()) {
    if (mvMode==='month') {
      mvMonthMonth++; if(mvMonthMonth>11){mvMonthMonth=0;mvMonthYear++;}
      mvSelDate=`${mvMonthYear}-${String(mvMonthMonth+1).padStart(2,'0')}-01`;
      renderMvMonth();
    } else if (mvMode==='week') {
      mvWeekStart=addDays(mvWeekStart,7); mvSelDate=mvWeekStart; renderMvWeek();
    } else {
      mvSelDate=addDays(mvSelDate,1); renderMvDay(); updateMvNav();
    }
    return;
  }
  if (pcView==='month'){currentMonth++;if(currentMonth>11){currentMonth=0;currentYear++;}render();}
  else if (pcView==='week'){pcWeekStart=addDaysPc(pcWeekStart,7);renderPcWeek();}
  else{pcDayDate=addDaysPc(pcDayDate,1);renderPcDay();}
});
document.getElementById('todayBtn').addEventListener('click',()=>{
  if (isMobile()) {
    mvSelDate=todayStr; mvWeekStart=getWeekStart(todayStr);
    const td=new Date(); mvMonthYear=td.getFullYear(); mvMonthMonth=td.getMonth();
    if(mvMode==='month') renderMvMonth();
    else if(mvMode==='week') renderMvWeek();
    else { renderMvDay(); updateMvNav(); }
    return;
  }
  pcDayDate=todayStr; pcWeekStart=getPcWeekStart();
  if (pcView==='month'){currentYear=today.getFullYear();currentMonth=today.getMonth();render();}
  else if (pcView==='week') renderPcWeek();
  else renderPcDay();
});

document.querySelectorAll('.view-toggle-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{ if(isMobile()) return; switchPcView(btn.dataset.view); });
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE VIEW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const isMobile = () => window.innerWidth <= 600;

let mvMode    = 'week';
let mvSelDate = todayStr;
let mvWeekStart = null;
let mvMonthYear  = new Date().getFullYear();
let mvMonthMonth = new Date().getMonth(); // 0-based

const DOW_KR = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
const TYPE_LABELS_MV = { gold:'Í∞úÏù∏ÏùòÎ¢∞', blue:'ÏÇ¨ÎÇ¥ÏóÖÎ¨¥', red:'Ìú¥Í∞ÄÍ¥ÄÎ†®', green:'Ï¥¨ÏòÅÍ¥ÄÎ†®' };

function addDays(dk, n) { const d=new Date(dk+'T00:00:00'); d.setDate(d.getDate()+n); return fmtDate(d); }
function getWeekStart(dk) { const d=new Date(dk+'T00:00:00'); d.setDate(d.getDate()-d.getDay()); return fmtDate(d); }

function getEventsForDate(dk) {
  return filteredEvents().filter(ev=>{ const sd=ev.startDate, ed=ev.endDate||sd; return sd<=dk&&ed>=dk; })
    .sort((a,b)=>{ if(a.allDay!==false&&b.allDay===false)return -1; if(a.allDay===false&&b.allDay!==false)return 1; return (a.startTime||'').localeCompare(b.startTime||''); });
}

function renderMvEventCard(ev, evIdx, container) {
  const card=document.createElement('div');
  card.className=`mv-event-card color-${ev.color||'gold'}`;
  const icons=getSpecialIconStr(ev);
  const timeStr=ev.allDay!==false?'Ï¢ÖÏùº':`${ev.startTime||''}${ev.endTime?'~'+ev.endTime:''}`;
  const spanStr=(ev.endDate&&ev.endDate!==ev.startDate)?`<span>${ev.startDate} ~ ${ev.endDate}</span>`:'';
  card.innerHTML=`
    <div class="mv-event-badge ${ev.color||'gold'}">${TYPE_LABELS_MV[ev.color||'gold']}</div>
    <div class="mv-event-card-body">
      <div class="mv-event-title">${icons}${ev.title||'(Ï†úÎ™© ÏóÜÏùå)'}${getSchedSuffix(ev)}</div>
      <div class="mv-event-meta"><span>${timeStr}</span>${spanStr}${ev.name?`<span>üë§ ${ev.name}</span>`:''}</div>
    </div>`;
  card.addEventListener('click',()=>{ const idx=events.findIndex(e=>e._id===ev._id); if(idx>=0) openModal(idx); });
  container.appendChild(card);
}

function renderMvDayList(dk, container, hideTitle=false) {
  container.innerHTML='';
  const evs=getEventsForDate(dk);
  const [y,m,d]=dk.split('-').map(Number);
  const dow=DOW_KR[new Date(y,m-1,d).getDay()];
  const holiday=getHoliday(dk);
  if (!hideTitle) {
    const title=document.createElement('div'); title.className='mv-day-title';
    title.innerHTML=`<span>${m}Ïõî ${d}Ïùº (${dow})</span>${holiday?`<span class="mv-day-title-holiday">${holiday}</span>`:''}`;
    const addBtn=document.createElement('button');
    addBtn.textContent='+ Ï∂îÍ∞Ä';
    addBtn.style.cssText='margin-left:auto;background:rgba(200,176,138,0.15);border:1px solid var(--accent);color:var(--accent);border-radius:6px;padding:3px 10px;font-size:11px;cursor:pointer;font-family:var(--font-main);';
    addBtn.addEventListener('click', () => openNewModal(dk));
    title.appendChild(addBtn);
    container.appendChild(title);
  }
  if (evs.length===0) {
    const empty=document.createElement('div'); empty.className='mv-empty'; empty.textContent='Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§'; container.appendChild(empty);
  } else {
    evs.forEach(ev=>{ const idx=events.findIndex(e=>e._id===ev._id); renderMvEventCard(ev,idx,container); });
  }
}

function renderMvMonth() {
  /* Ìó§Îçî ÏöîÏùº */
  const hdrEl = document.getElementById('mvMonthGridHeader');
  hdrEl.innerHTML = '';
  DOW_KR.forEach(d => {
    const el = document.createElement('div');
    el.className = 'mv-week-day';
    el.textContent = d;
    el.style.cssText = 'text-align:center;font-size:11px;color:var(--text-muted);font-family:var(--font-mono);padding:4px 0 2px;letter-spacing:0.05em;';
    hdrEl.appendChild(el);
  });

  const grid = document.getElementById('mvMonthGrid');
  grid.innerHTML = '';

  const y = mvMonthYear, m = mvMonthMonth;
  const firstDay   = new Date(y, m, 1).getDay();
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const prevDays   = new Date(y, m, 0).getDate();

  const cells = [];
  for (let i=firstDay-1; i>=0; i--)
    cells.push({ d:prevDays-i, cur:false, y:m===0?y-1:y, mo:m===0?11:m-1 });
  for (let d=1; d<=daysInMonth; d++)
    cells.push({ d, cur:true, y, mo:m });
  while (cells.length % 7 !== 0) {
    const extra = cells.length - daysInMonth - firstDay + 1;
    cells.push({ d:extra, cur:false, y:m===11?y+1:y, mo:m===11?0:m+1 });
  }

  cells.forEach(({d, cur, y:cy, mo:cmo}) => {
    const dk = `${cy}-${String(cmo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dow = new Date(cy,cmo,d).getDay();
    const holiday = getHoliday(dk);
    const evs = getEventsForDate(dk);

    const cell = document.createElement('div');
    cell.className = 'mv-month-cell' + (cur?'':' other-month') + (dk===todayStr?' today':'') + (dk===mvSelDate?' selected':'');

    const numEl = document.createElement('div');
    numEl.className = 'mv-month-num' + (holiday?' holiday':'') + (dow===0?' sun':dow===6?' sat':'');
    numEl.textContent = d;
    cell.appendChild(numEl);

    /* dot + Í±¥Ïàò */
    if (evs.length > 0) {
      const colorCount = {};
      evs.forEach(ev => {
        const c = ev.color||'gold';
        colorCount[c] = (colorCount[c]||0) + 1;
      });
      const dotsRow = document.createElement('div');
      dotsRow.style.cssText = 'display:flex;gap:3px;flex-wrap:wrap;justify-content:center;margin-top:1px;';
      /* ÏÉâÏÉÅ ÏàúÏÑú Í≥†Ï†ï */
      ['gold','blue','red','green','purple'].forEach(c => {
        if (!colorCount[c]) return;
        const wrap = document.createElement('div');
        wrap.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:1px;';
        const dot = document.createElement('div');
        dot.className = `mv-date-dot ${c}`;
        const cnt = document.createElement('div');
        cnt.style.cssText = `font-size:9px;font-family:var(--font-mono);line-height:1;color:var(--chip-${c}-bg);font-weight:700;`;
        cnt.textContent = colorCount[c];
        wrap.appendChild(dot);
        wrap.appendChild(cnt);
        dotsRow.appendChild(wrap);
      });
      cell.appendChild(dotsRow);
    }

    cell.addEventListener('click', () => {
      mvSelDate = dk;
      renderMvMonth();
    });
    grid.appendChild(cell);
  });

  /* ÏÑ†ÌÉù ÎÇ†Ïßú Î∞î */
  const [sy,sm,sd] = mvSelDate.split('-').map(Number);
  const sdow = DOW_KR[new Date(sy,sm-1,sd).getDay()];
  const holiday = getHoliday(mvSelDate);
  const selBar = document.getElementById('mvMonthSelBar');
  selBar.innerHTML = `<span class="mv-month-sel-date">${sm}Ïõî ${sd}Ïùº (${sdow})</span>${holiday?`<span class="mv-month-sel-holiday">${holiday}</span>`:''}`;
  const addBtnM = document.createElement('button');
  addBtnM.textContent = '+ Ï∂îÍ∞Ä';
  addBtnM.style.cssText = 'margin-left:auto;background:rgba(200,176,138,0.15);border:1px solid var(--accent);color:var(--accent);border-radius:6px;padding:3px 10px;font-size:11px;cursor:pointer;font-family:var(--font-main);flex-shrink:0;';
  addBtnM.addEventListener('click', () => openNewModal(mvSelDate));
  selBar.appendChild(addBtnM);

  renderMvDayList(mvSelDate, document.getElementById('mvMonthDayList'), true);

  /* Ìó§Îçî Î†àÏù¥Î∏î */
  document.getElementById('monthLabel').textContent = `${y}ÎÖÑ ${MONTHS[m]}`;
}

function renderMvWeek() {
  if (!mvWeekStart) mvWeekStart=getWeekStart(mvSelDate);
  const hdr=document.getElementById('mvWeekHeader');
  hdr.innerHTML='';
  DOW_KR.forEach(d=>{ const el=document.createElement('div'); el.className='mv-week-day'; el.textContent=d; hdr.appendChild(el); });

  const datesEl=document.getElementById('mvWeekDates');
  datesEl.innerHTML='';
  for (let i=0;i<7;i++){
    const dk=addDays(mvWeekStart,i);
    const [y,m,d]=dk.split('-').map(Number);
    const dow=new Date(y,m-1,d).getDay();
    const evs=getEventsForDate(dk);
    const holiday=getHoliday(dk);
    const cell=document.createElement('div');
    cell.className='mv-date-cell'+(dk===todayStr?' today':'')+(dk===mvSelDate?' selected':'');
    const numEl=document.createElement('div');
    numEl.className='mv-date-num'+(holiday?' holiday':'')+(dow===0?' sun':dow===6?' sat':'');
    numEl.textContent=d;
    const dotsRow=document.createElement('div');
    dotsRow.style.cssText='display:flex;gap:3px;flex-wrap:wrap;justify-content:center;margin-top:1px;';
    if (evs.length > 0) {
      const colorCount={};
      evs.forEach(ev=>{ const c=ev.color||'gold'; colorCount[c]=(colorCount[c]||0)+1; });
      ['gold','blue','red','green','purple'].forEach(c=>{
        if (!colorCount[c]) return;
        const wrap=document.createElement('div');
        wrap.style.cssText='display:flex;flex-direction:column;align-items:center;gap:1px;';
        const dot=document.createElement('div'); dot.className=`mv-date-dot ${c}`;
        const cnt=document.createElement('div');
        cnt.style.cssText=`font-size:9px;font-family:var(--font-mono);line-height:1;color:var(--chip-${c}-bg);font-weight:700;`;
        cnt.textContent=colorCount[c];
        wrap.appendChild(dot); wrap.appendChild(cnt);
        dotsRow.appendChild(wrap);
      });
    }
    cell.appendChild(numEl); cell.appendChild(dotsRow);
    cell.addEventListener('click',()=>{ mvSelDate=dk; renderMvWeek(); });
    datesEl.appendChild(cell);
  }
  renderMvDayList(mvSelDate, document.getElementById('mvDayList'));
  updateMvNav();
}

function renderMvDay() {
  const [y,m,d]=mvSelDate.split('-').map(Number);
  const dow=DOW_KR[new Date(y,m-1,d).getDay()];
  document.getElementById('mvDayNavLabel').textContent=`${y}ÎÖÑ ${m}Ïõî ${d}Ïùº (${dow})`;
  document.getElementById('mvDayNavSub').textContent=getHoliday(mvSelDate)||'';
  renderMvDayList(mvSelDate, document.getElementById('mvDayPanelList'));
}

function updateMvNav() {
  if (mvMode==='month') {
    document.getElementById('monthLabel').textContent=`${mvMonthYear}ÎÖÑ ${MONTHS[mvMonthMonth]}`;
  } else if (mvMode==='week') {
    const ws=mvWeekStart, we=addDays(ws,6);
    const [y1,m1,d1]=ws.split('-').map(Number), [y2,m2,d2]=we.split('-').map(Number);
    document.getElementById('monthLabel').textContent=y1===y2?`${y1}ÎÖÑ ${m1}Ïõî ${d1}Ïùº ‚Äî ${m2}Ïõî ${d2}Ïùº`:`${y1}ÎÖÑ ${m1}Ïõî ${d1}Ïùº ‚Äî ${y2}ÎÖÑ ${m2}Ïõî ${d2}Ïùº`;
  } else {
    const [y,m]=mvSelDate.split('-').map(Number);
    document.getElementById('monthLabel').textContent=`${y}ÎÖÑ ${m}Ïõî`;
  }
}

function switchMvMode(mode) {
  mvMode = mode;
  ['mvMonthBtn','mvWeekBtn','mvDayBtn'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove('active');
  });
  document.getElementById('mvMonthPanel').style.display = 'none';
  document.getElementById('mvWeekPanel').style.display  = 'none';
  document.getElementById('mvDayPanel').style.display   = 'none';
  if (mode==='month') {
    document.getElementById('mvMonthBtn').classList.add('active');
    document.getElementById('mvMonthPanel').style.display = '';
    /* mvSelDate Í∏∞Ï§ÄÏúºÎ°ú Ïó∞/Ïõî ÎèôÍ∏∞Ìôî */
    const [y,m] = mvSelDate.split('-').map(Number);
    mvMonthYear = y; mvMonthMonth = m-1;
    renderMvMonth();
  } else if (mode==='week') {
    document.getElementById('mvWeekBtn').classList.add('active');
    document.getElementById('mvWeekPanel').style.display = '';
    renderMvWeek();
  } else {
    document.getElementById('mvDayBtn').classList.add('active');
    document.getElementById('mvDayPanel').style.display = '';
    renderMvDay(); updateMvNav();
  }
}
document.getElementById('mvMonthBtn').addEventListener('click', () => switchMvMode('month'));
document.getElementById('mvWeekBtn').addEventListener('click',  () => switchMvMode('week'));
document.getElementById('mvDayBtn').addEventListener('click',   () => switchMvMode('day'));

document.getElementById('mvDayPrev').addEventListener('click',()=>{ mvSelDate=addDays(mvSelDate,-1); renderMvDay(); updateMvNav(); });
document.getElementById('mvDayNext').addEventListener('click',()=>{ mvSelDate=addDays(mvSelDate,1);  renderMvDay(); updateMvNav(); });

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ÌïÑÌÑ∞ÎßÅ
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const FILTER_KEY = 'cal_filter_state';
let activeFilters = new Set(['gold','blue','red','green','purple']);

function filteredEvents() {
  return events.filter(ev => activeFilters.has(ev.color || 'gold'));
}

function saveFilterState() {
  localStorage.setItem(FILTER_KEY, JSON.stringify([...activeFilters]));
}

function loadFilterState() {
  try {
    const saved = JSON.parse(localStorage.getItem(FILTER_KEY));
    if (Array.isArray(saved)) activeFilters = new Set(saved);
  } catch(e) {}
}

function applyFilterUI() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    const key = btn.dataset.filter;
    btn.classList.toggle('active', activeFilters.has(key));
  });
  /* filter-dot ÏÉâÏÉÅÏùÄ CSS Î≥ÄÏàò Í∏∞Î∞òÏúºÎ°ú ÎèôÏ†Å Î∞òÏòÅ */
  updateFilterDots();
}

function updateFilterDots() {
  ['gold','blue','red','green','purple'].forEach(key => {
    const dot = document.getElementById(`fd-${key}`);
    if (!dot) return;
    const color = getComputedStyle(document.documentElement).getPropertyValue(`--chip-${key}-bg`).trim()
                  || { gold:'#c8a870', blue:'#7aaec8', red:'#c87070', green:'#70c870', purple:'#9b70c8' }[key];
    dot.style.background = color;
  });
}

function toggleFilter(key) {
  if (activeFilters.has(key)) {
    /* ÎßàÏßÄÎßâ ÌïòÎÇòÎäî ÎÅÑÏßÄ Î™ªÌïòÍ≤å */
    if (activeFilters.size === 1) return;
    activeFilters.delete(key);
  } else {
    activeFilters.add(key);
  }
  saveFilterState();
  applyFilterUI();
  if (typeof renderAll === 'function') renderAll(); else render();
}

/* Î≤ÑÌäº Ïù¥Î≤§Ìä∏ */
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => toggleFilter(btn.dataset.filter));
});

/* Ï¥àÍ∏∞ Î°úÎìú */
loadFilterState();
applyFilterUI();

function renderAll() {
  if (isMobile()) {
    if (!mvWeekStart) mvWeekStart=getWeekStart(mvSelDate);
    if (mvMode==='month') renderMvMonth(); else if (mvMode==='week') renderMvWeek(); else { renderMvDay(); updateMvNav(); }
  } else {
    if (pcView==='month') render();
    else if (pcView==='week') { if(!pcWeekStart) pcWeekStart=getPcWeekStart(); renderPcWeek(); }
    else { if(!pcDayDate) pcDayDate=todayStr; renderPcDay(); }
  }
}

window.addEventListener('resize',()=>{ renderAll(); });

(function() {
  const SWIPE_MIN=50, SWIPE_MAX_Y=80;
  let tsX=0, tsY=0, swiping=false;
  document.body.addEventListener('touchstart',e=>{
    if (document.getElementById('modalOverlay').classList.contains('open')) return;
    tsX=e.touches[0].clientX; tsY=e.touches[0].clientY; swiping=true;
  },{passive:true});
  document.body.addEventListener('touchmove',e=>{
    if (!swiping) return;
    const dy=Math.abs(e.touches[0].clientY-tsY), dx=Math.abs(e.touches[0].clientX-tsX);
    if (dy>SWIPE_MAX_Y&&dy>dx) swiping=false;
  },{passive:true});
  document.body.addEventListener('touchend',e=>{
    if (!swiping){swiping=false;return;} swiping=false;
    const dx=e.changedTouches[0].clientX-tsX, dy=e.changedTouches[0].clientY-tsY;
    if (Math.abs(dx)<SWIPE_MIN||Math.abs(dy)>SWIPE_MAX_Y) return;
    if (!isMobile()) return;
    const goNext=dx<0;
    const animEl=document.getElementById('mobileView');
    slideAnimate(animEl,goNext,()=>{
      if (mvMode==='week'){mvWeekStart=addDays(mvWeekStart,goNext?7:-7);mvSelDate=mvWeekStart;renderMvWeek();}
      else{mvSelDate=addDays(mvSelDate,goNext?1:-1);renderMvDay();updateMvNav();}
    });
  },{passive:true});
})();

function slideAnimate(el,toLeft,callback){
  el.style.transition='opacity 0.13s ease, transform 0.13s ease';
  el.style.opacity='0'; el.style.transform='translateX('+(toLeft?'-24px':'24px')+')';
  setTimeout(()=>{
    callback();
    el.style.transition='none'; el.style.opacity='0';
    el.style.transform='translateX('+(toLeft?'24px':'-24px')+')';
    void el.offsetHeight;
    el.style.transition='opacity 0.13s ease, transform 0.13s ease';
    el.style.opacity='1'; el.style.transform='translateX(0)';
    setTimeout(()=>{el.style.transition='';el.style.transform='';},140);
  },130);
}
</script>

</body>
</html>