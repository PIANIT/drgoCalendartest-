<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>DRGO</title>
<meta name="theme-color" content="#111111" id="metaThemeColor">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --font-main: "Malgun Gothic","ë§‘ì€ ê³ ë”•",-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
  --font-mono: 'DM Mono',"Malgun Gothic","ë§‘ì€ ê³ ë”•",monospace;
  --bg:      #111111;
  --surface: #1c1c1c;
  --surface2:#272727;
  --border:  #3a3a3a;
  --accent:  #d4bc96;
  --accent2: #90bcd4;
  --text:    #f0ebe2;
  --text-muted: #a09890;
  --red:     #d48888;
  --green:   #88d488;
  --topbar-h: 48px;
  --tabbar-h: 38px;
}
html.light {
  --bg:#f7f4f0; --surface:#ffffff; --surface2:#efebe4;
  --border:#d8d0c4; --accent:#9c7d48; --accent2:#3a7a9a;
  --text:#1e1812; --text-muted:#7a6e60; --red:#a84444; --green:#3a8a3a;
}
*{ margin:0; padding:0; box-sizing:border-box; }
body {
  background:var(--bg); color:var(--text);
  font-family:var(--font-main);
  height:100vh; overflow:hidden;
  display:flex; flex-direction:column;
  transition:background .2s, color .2s;
}

/* â”€â”€ AUTH OVERLAY â”€â”€ */
#authOverlay {
  display:flex; position:fixed; inset:0; z-index:9999;
  background:var(--bg); align-items:center; justify-content:center;
}
#authOverlay.hidden { display:none; }
.auth-box {
  width:100%; max-width:380px; padding:44px 34px 38px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:20px; box-shadow:0 24px 64px rgba(0,0,0,.55);
  display:flex; flex-direction:column; align-items:center;
}
.auth-brand {
  font-family:var(--font-mono); font-size:22px; font-weight:500;
  letter-spacing:.25em; color:var(--accent); margin-bottom:4px;
}
.auth-subtitle {
  font-size:11px; letter-spacing:.18em; color:var(--text-muted);
  text-transform:uppercase; margin-bottom:32px;
}
.auth-label {
  width:100%; font-size:10px; font-family:var(--font-mono);
  letter-spacing:.14em; color:var(--text-muted); text-transform:uppercase;
  margin-bottom:6px;
}
.auth-input {
  width:100%; padding:11px 14px; font-size:14px;
  background:var(--surface2); border:1.5px solid var(--border);
  border-radius:9px; color:var(--text); font-family:var(--font-main);
  outline:none; transition:border-color .2s; margin-bottom:13px;
}
.auth-input:focus { border-color:var(--accent); }
.auth-input.error { border-color:var(--red); animation:shake .35s ease; }
@keyframes shake {
  0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)}
  40%{transform:translateX(8px)}   60%{transform:translateX(-5px)} 80%{transform:translateX(5px)}
}
.auth-btn {
  width:100%; margin-top:4px; padding:12px;
  background:var(--accent); color:#1a1207; border:none;
  border-radius:9px; font-size:14px; font-weight:700;
  font-family:var(--font-main); cursor:pointer;
  transition:all .2s; letter-spacing:.06em;
}
.auth-btn:hover:not(:disabled) { background:#dcc8a4; transform:translateY(-1px); }
.auth-btn:disabled { opacity:.45; cursor:not-allowed; transform:none; }
.auth-error { margin-top:10px; font-size:12px; color:var(--red); text-align:center; min-height:18px; }

/* â”€â”€ TOPBAR â”€â”€ */
#topbar {
  height:var(--topbar-h); flex-shrink:0;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 18px; border-bottom:1px solid var(--border);
  background:var(--bg); position:relative; z-index:100;
}
.topbar-left { display:flex; align-items:center; gap:16px; }
.brand {
  font-family:var(--font-mono); font-size:13px; letter-spacing:.22em;
  color:var(--accent); text-transform:uppercase; user-select:none;
}
.topbar-right { display:flex; align-items:center; gap:6px; }
.tb-btn {
  background:none; border:1px solid var(--border); color:var(--text-muted);
  cursor:pointer; height:28px; padding:0 10px; border-radius:5px;
  font-size:12px; font-family:var(--font-main); display:flex;
  align-items:center; gap:5px; transition:all .18s; white-space:nowrap;
}
.tb-btn:hover { border-color:var(--accent); color:var(--accent); }
.tb-btn.icon { width:28px; padding:0; justify-content:center; font-size:14px; }
.user-badge {
  font-family:var(--font-mono); font-size:11px; color:var(--text-muted);
  padding:4px 10px; border:1px solid var(--border); border-radius:5px;
  letter-spacing:.06em;
}

/* â”€â”€ TABBAR â”€â”€ */
#tabbar {
  height:var(--tabbar-h); flex-shrink:0;
  display:flex; align-items:flex-end;
  padding:0 14px; background:var(--bg);
  border-bottom:1px solid var(--border);
  gap:2px; overflow-x:auto; overflow-y:hidden;
}
#tabbar::-webkit-scrollbar { display:none; }

.tab-item {
  display:flex; align-items:center; gap:7px;
  padding:0 14px; height:32px; border-radius:7px 7px 0 0;
  cursor:pointer; font-size:12px; font-weight:500;
  color:var(--text-muted); background:none;
  border:1px solid transparent; border-bottom:none;
  transition:all .15s; user-select:none; white-space:nowrap;
  position:relative; flex-shrink:0;
}
.tab-item:hover { color:var(--text); background:var(--surface2); }
.tab-item.active {
  color:var(--accent); background:var(--surface);
  border-color:var(--border); border-bottom-color:var(--surface);
  margin-bottom:-1px;
}
.tab-icon { font-size:13px; }
.tab-close {
  background:none; border:none; color:var(--text-muted);
  cursor:pointer; font-size:13px; width:16px; height:16px;
  display:flex; align-items:center; justify-content:center;
  border-radius:3px; transition:all .13s; line-height:1;
  flex-shrink:0;
}
.tab-close:hover { background:rgba(212,136,136,.2); color:var(--red); }
.tab-add {
  display:flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:6px; cursor:pointer;
  color:var(--text-muted); font-size:17px; transition:all .15s;
  flex-shrink:0; border:none; background:none; margin-bottom:2px;
}
.tab-add:hover { background:var(--surface2); color:var(--accent); }

/* â”€â”€ ADD MENU POPUP â”€â”€ */
#addMenu {
  display:none; position:fixed; z-index:200;
  background:var(--surface); border:1px solid var(--border);
  border-radius:10px; box-shadow:0 12px 36px rgba(0,0,0,.45);
  min-width:180px; overflow:hidden;
}
#addMenu.open { display:block; }
.add-menu-item {
  display:flex; align-items:center; gap:10px;
  padding:11px 16px; cursor:pointer; font-size:13px;
  color:var(--text); transition:background .13s;
}
.add-menu-item:hover { background:var(--surface2); }
.add-menu-item .mi-icon { font-size:16px; }
.add-menu-item .mi-label { font-weight:500; }
.add-menu-item .mi-desc { font-size:11px; color:var(--text-muted); margin-top:1px; }
.add-menu-divider { height:1px; background:var(--border); margin:3px 0; }

/* â”€â”€ FRAME CONTAINER â”€â”€ */
#frameWrap {
  flex:1; position:relative; overflow:hidden;
}
.frame-pane {
  position:absolute; inset:0;
  display:none;
}
.frame-pane.active { display:block; }
.frame-pane iframe {
  width:100%; height:100%; border:none; display:block;
}

/* â”€â”€ WELCOME â”€â”€ */
#welcomePane {
  position:absolute; inset:0;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:16px; color:var(--text-muted);
}
.welcome-logo { font-family:var(--font-mono); font-size:36px; letter-spacing:.2em; color:var(--accent); opacity:.6; }
.welcome-sub  { font-size:13px; letter-spacing:.08em; }
.welcome-hint { display:flex; gap:10px; margin-top:8px; }
.welcome-chip {
  padding:7px 16px; border:1px solid var(--border); border-radius:8px;
  font-size:12px; color:var(--text-muted); cursor:pointer;
  transition:all .18s; display:flex; align-items:center; gap:6px;
}
.welcome-chip:hover { border-color:var(--accent); color:var(--accent); background:rgba(212,188,150,.06); }

/* â”€â”€ LOADING SPINNER in tab â”€â”€ */
.tab-loading {
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  background:var(--bg); z-index:10;
}
.spinner {
  width:32px; height:32px; border:3px solid var(--border);
  border-top-color:var(--accent); border-radius:50%;
  animation:spin .7s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* â”€â”€ TOAST â”€â”€ */
#toast {
  position:fixed; bottom:22px; left:50%;
  transform:translateX(-50%) translateY(16px);
  z-index:9000; background:var(--surface); border:1px solid var(--border);
  border-radius:9px; padding:10px 18px; font-size:13px; color:var(--text);
  box-shadow:0 8px 28px rgba(0,0,0,.4); opacity:0;
  transition:all .25s; pointer-events:none; white-space:nowrap;
}
#toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* â”€â”€ ëª¨ë°”ì¼ â”€â”€ */
@media(max-width:600px) {
  .brand { font-size:11px; letter-spacing:.15em; }
  .user-badge { display:none; }
  .tab-item { padding:0 10px; font-size:11px; }
}
</style>
</head>
<body>

<!-- â”€â”€ AUTH â”€â”€ -->
<div id="authOverlay">
  <div class="auth-box">
    <div class="auth-brand">DRGO</div>
    <div class="auth-subtitle">Workspace</div>
    <div class="auth-label">ì•„ì´ë””</div>
    <input class="auth-input" type="text"     id="authId" placeholder="ì•„ì´ë”” ì…ë ¥" autocomplete="username">
    <div class="auth-label">ë¹„ë°€ë²ˆí˜¸</div>
    <input class="auth-input" type="password" id="authPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password">
    <button class="auth-btn" id="authBtn">ë¡œê·¸ì¸</button>
    <div class="auth-error" id="authError"></div>
  </div>
</div>

<!-- â”€â”€ TOPBAR â”€â”€ -->
<div id="topbar">
  <div class="topbar-left">
    <div class="brand">DRGO</div>
  </div>
  <div class="topbar-right">
    <div class="user-badge" id="userBadge">â€”</div>
    <button class="tb-btn icon" id="themeBtn" title="í…Œë§ˆ ì „í™˜">ğŸŒ™</button>
    <button class="tb-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<!-- â”€â”€ TABBAR â”€â”€ -->
<div id="tabbar">
  <!-- íƒ­ë“¤ì´ JSë¡œ ì¶”ê°€ë¨ -->
  <button class="tab-add" id="tabAddBtn" title="ìƒˆ íƒ­ ì—´ê¸°">ï¼‹</button>
</div>

<!-- â”€â”€ ADD MENU â”€â”€ -->
<div id="addMenu">
  <div class="add-menu-item" data-page="calendar">
    <span class="mi-icon">ğŸ“…</span>
    <div><div class="mi-label">ìº˜ë¦°ë”</div><div class="mi-desc">ì¼ì • ê´€ë¦¬</div></div>
  </div>
  <div class="add-menu-divider"></div>
  <div class="add-menu-item" data-page="crm">
    <span class="mi-icon">ğŸ‘¥</span>
    <div><div class="mi-label">CRM</div><div class="mi-desc">ê³ ê° ê´€ë¦¬</div></div>
  </div>
</div>

<!-- â”€â”€ FRAME WRAP â”€â”€ -->
<div id="frameWrap">
  <div id="welcomePane">
    <div class="welcome-logo">DRGO</div>
    <div class="welcome-sub">ìƒë‹¨ ï¼‹ ë²„íŠ¼ìœ¼ë¡œ í˜ì´ì§€ë¥¼ ì—´ì–´ì£¼ì„¸ìš”</div>
    <div class="welcome-hint">
      <div class="welcome-chip" data-page="calendar">ğŸ“… ìº˜ë¦°ë” ì—´ê¸°</div>
      <div class="welcome-chip" data-page="crm">ğŸ‘¥ CRM ì—´ê¸°</div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, getDoc }
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* â”€â”€ CONFIG â”€â”€ */
const firebaseConfig = {
  apiKey:            "AIzaSyDnEOATYmwq0WJr6pCl-86-Q3ZEQjrrfeY",
  authDomain:        "drgo-calender.firebaseapp.com",
  projectId:         "drgo-calender",
  storageBucket:     "drgo-calender.firebasestorage.app",
  messagingSenderId: "163730741115",
  appId:             "1:163730741115:web:73a06d5b1cf1a477734fde"
};

const SESSION_KEY  = 'cal_auth_ok';
const SESSION_UID  = 'cal_auth_uid';
const SESSION_NAME = 'cal_auth_name';
const SESSION_EXP  = 'cal_auth_exp';
const AUTH_TTL_MS  = 30 * 24 * 60 * 60 * 1000;
const TRIES_KEY    = 'cal_auth_tries';
const LOCK_KEY     = 'cal_auth_lock';
const MAX_TRIES    = 5;
const LOCK_MS      = 120000;

async function sha256(msg) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(msg));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function isAuth() {
  if (localStorage.getItem(SESSION_KEY) !== '1') return false;
  const exp = parseInt(localStorage.getItem(SESSION_EXP)||'0');
  if (exp && Date.now() > exp) {
    ['cal_auth_ok','cal_auth_uid','cal_auth_name','cal_auth_exp'].forEach(k=>localStorage.removeItem(k));
    return false;
  }
  return true;
}
function getLockRemaining() {
  const l = parseInt(localStorage.getItem(LOCK_KEY)||'0');
  return Math.max(0, l - Date.now());
}
function updateLockUI() {
  const rem = getLockRemaining();
  const errEl = document.getElementById('authError');
  const btn   = document.getElementById('authBtn');
  if (rem > 0) {
    btn.disabled = true;
    errEl.textContent = `ì ê¸ˆ ì¤‘â€¦ ${Math.ceil(rem/1000)}ì´ˆ í›„ ì¬ì‹œë„`;
    setTimeout(updateLockUI, 1000);
  } else {
    btn.disabled = false;
    if (errEl.textContent.startsWith('ì ê¸ˆ')) errEl.textContent = '';
  }
}

const _app = initializeApp(firebaseConfig);
const _db  = getFirestore(_app);

async function tryAuth() {
  if (getLockRemaining() > 0) return;
  const idEl  = document.getElementById('authId');
  const pwEl  = document.getElementById('authPw');
  const errEl = document.getElementById('authError');
  const userId = idEl.value.trim();
  const userPw = pwEl.value;
  idEl.classList.remove('error'); pwEl.classList.remove('error');
  if (!userId) { idEl.classList.add('error'); idEl.focus(); errEl.textContent='ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
  if (!userPw) { pwEl.classList.add('error'); pwEl.focus(); errEl.textContent='ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
  const btn = document.getElementById('authBtn');
  btn.disabled=true; btn.textContent='í™•ì¸ ì¤‘â€¦';
  try {
    const pwHash  = await sha256(userPw);
    const userDoc = await getDoc(doc(_db,'users',userId));
    if (userDoc.exists() && userDoc.data().passwordHash === pwHash) {
      const displayName = userDoc.data().displayName || userId;
      localStorage.setItem(SESSION_KEY,  '1');
      localStorage.setItem(SESSION_UID,  userId);
      localStorage.setItem(SESSION_NAME, displayName);
      localStorage.setItem(SESSION_EXP,  Date.now() + AUTH_TTL_MS);
      localStorage.removeItem(TRIES_KEY);
      localStorage.removeItem(LOCK_KEY);
      /* CRMìš© sessionStorageë„ ë™ì‹œ ì„¸íŒ… */
      sessionStorage.setItem('crm_auth_ok',       '1');
      sessionStorage.setItem('crm_uid',            userId);
      sessionStorage.setItem('crm_display_name',   displayName);
      document.getElementById('authOverlay').classList.add('hidden');
      initWorkspace(displayName);
    } else {
      const tries = parseInt(localStorage.getItem(TRIES_KEY)||'0') + 1;
      localStorage.setItem(TRIES_KEY, tries);
      pwEl.value=''; pwEl.classList.add('error');
      setTimeout(()=>pwEl.classList.remove('error'), 400);
      if (tries >= MAX_TRIES) {
        localStorage.setItem(LOCK_KEY, Date.now() + LOCK_MS);
        updateLockUI();
      } else {
        errEl.textContent=`ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. (${MAX_TRIES-tries}íšŒ ë‚¨ìŒ)`;
      }
      btn.disabled=false; btn.textContent='ë¡œê·¸ì¸';
    }
  } catch(e) {
    errEl.textContent='ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    btn.disabled=false; btn.textContent='ë¡œê·¸ì¸';
  }
}

document.getElementById('authBtn').addEventListener('click', tryAuth);
document.getElementById('authPw').addEventListener('keydown',  e=>{ if(e.key==='Enter') tryAuth(); });
document.getElementById('authId').addEventListener('keydown',  e=>{ if(e.key==='Enter') document.getElementById('authPw').focus(); });

if (isAuth()) {
  document.getElementById('authOverlay').classList.add('hidden');
  /* CRM sessionStorageë„ ë³µì› */
  const uid  = localStorage.getItem(SESSION_UID)  || '';
  const name = localStorage.getItem(SESSION_NAME) || uid;
  sessionStorage.setItem('crm_auth_ok',     '1');
  sessionStorage.setItem('crm_uid',          uid);
  sessionStorage.setItem('crm_display_name', name);
  initWorkspace(name);
} else {
  updateLockUI();
  setTimeout(()=>document.getElementById('authId').focus(), 100);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WORKSPACE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initWorkspace(displayName) {
  document.getElementById('userBadge').textContent = displayName;

  /* í…Œë§ˆ */
  const saved = localStorage.getItem('cal_theme');
  if (saved === 'light') document.documentElement.classList.add('light');
  syncThemeBtn();
  document.getElementById('themeBtn').addEventListener('click', ()=>{
    const isL = document.documentElement.classList.toggle('light');
    localStorage.setItem('cal_theme', isL ? 'light' : 'dark');
    syncThemeBtn();
    syncThemeToFrames();
    document.getElementById('metaThemeColor').setAttribute('content', isL ? '#f7f4f0' : '#111111');
  });
  function syncThemeBtn() {
    document.getElementById('themeBtn').textContent =
      document.documentElement.classList.contains('light') ? 'â˜€ï¸' : 'ğŸŒ™';
  }
  function syncThemeToFrames() {
    const theme = document.documentElement.classList.contains('light') ? 'light' : 'dark';
    document.querySelectorAll('.frame-pane iframe').forEach(f => {
      try {
        f.contentDocument?.documentElement?.classList?.toggle('light', theme==='light');
      } catch(e) {}
    });
  }

  /* ë¡œê·¸ì•„ì›ƒ */
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    ['cal_auth_ok','cal_auth_uid','cal_auth_name','cal_auth_exp'].forEach(k=>localStorage.removeItem(k));
    ['crm_auth_ok','crm_uid','crm_display_name'].forEach(k=>sessionStorage.removeItem(k));
    location.reload();
  });

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     TAB MANAGER
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const PAGE_META = {
    calendar: { label:'ìº˜ë¦°ë”', icon:'ğŸ“…', src:'index.html' },
    crm:      { label:'CRM',    icon:'ğŸ‘¥', src:'crm.html'   },
  };

  let tabs      = [];   /* [{ id, page, label, icon }] */
  let activeTab = null;
  let tabIdSeq  = 0;

  const tabbar   = document.getElementById('tabbar');
  const addBtn   = document.getElementById('tabAddBtn');
  const frameWrap= document.getElementById('frameWrap');
  const welcome  = document.getElementById('welcomePane');

  function genTabId() { return 'tab_' + (++tabIdSeq); }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2000);
  }

  /* ì´ë¯¸ ê°™ì€ pageì˜ íƒ­ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸ */
  function findTabByPage(page) {
    return tabs.find(t=>t.page===page) || null;
  }

  function openTab(page) {
    const meta = PAGE_META[page];
    if (!meta) return;

    /* ì´ë¯¸ ê°™ì€ í˜ì´ì§€ íƒ­ ìˆìœ¼ë©´ ê·¸ìª½ìœ¼ë¡œ í¬ì»¤ìŠ¤ */
    const existing = findTabByPage(page);
    if (existing) {
      activateTab(existing.id);
      showToast(`${meta.label} íƒ­ìœ¼ë¡œ ì´ë™í–ˆì–´ìš”`);
      return;
    }

    const id = genTabId();
    tabs.push({ id, page, label:meta.label, icon:meta.icon });

    /* iframe ìƒì„± */
    const pane = document.createElement('div');
    pane.className = 'frame-pane';
    pane.id = 'pane_' + id;

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    const loading = document.createElement('div');
    loading.className = 'tab-loading';
    loading.innerHTML = '<div class="spinner"></div>';
    pane.appendChild(loading);

    const iframe = document.createElement('iframe');
    iframe.src = meta.src;
    iframe.title = meta.label;
    /* iframeì´ ê°™ì€ originì´ë©´ ë¡œë“œ í›„ ìŠ¤í”¼ë„ˆ ì œê±° */
    iframe.addEventListener('load', ()=>{
      loading.remove();
      /* iframe ë‚´ë¶€ í˜ì´ì§€ì— ì´ë¯¸ ë¡œê·¸ì¸ ì„¸ì…˜ ì£¼ì… (ê°™ì€ localStorage ê³µìœ ) */
      try {
        const iwin = iframe.contentWindow;
        if (iwin) {
          /* í…Œë§ˆ ë™ê¸°í™” */
          const isLight = document.documentElement.classList.contains('light');
          iwin.document?.documentElement?.classList?.toggle('light', isLight);
        }
      } catch(e) {}
    });
    pane.appendChild(iframe);
    frameWrap.appendChild(pane);

    renderTabs();
    activateTab(id);
  }

  function closeTab(id) {
    const idx = tabs.findIndex(t=>t.id===id);
    if (idx === -1) return;
    tabs.splice(idx, 1);

    /* pane ì œê±° */
    const pane = document.getElementById('pane_'+id);
    if (pane) pane.remove();

    /* ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ í¬ì»¤ìŠ¤ */
    if (activeTab === id) {
      activeTab = null;
      if (tabs.length > 0) {
        const next = tabs[Math.min(idx, tabs.length-1)];
        activateTab(next.id);
      } else {
        renderTabs();
        showWelcome();
      }
    } else {
      renderTabs();
    }
  }

  function activateTab(id) {
    activeTab = id;
    /* ëª¨ë“  pane ìˆ¨ê¸°ê³  í•´ë‹¹ paneë§Œ í‘œì‹œ */
    document.querySelectorAll('.frame-pane').forEach(p=>p.classList.remove('active'));
    const pane = document.getElementById('pane_'+id);
    if (pane) {
      pane.classList.add('active');
      welcome.style.display = 'none';
    }
    renderTabs();
  }

  function showWelcome() {
    welcome.style.display = '';
    document.querySelectorAll('.frame-pane').forEach(p=>p.classList.remove('active'));
  }

  function renderTabs() {
    /* addBtn ì•ì˜ íƒ­ë“¤ë§Œ ì§€ìš°ê³  ì¬ë Œë” */
    tabbar.querySelectorAll('.tab-item').forEach(t=>t.remove());
    tabs.forEach(tab => {
      const el = document.createElement('div');
      el.className = 'tab-item' + (tab.id===activeTab?' active':'');
      el.dataset.id = tab.id;
      el.innerHTML =
        `<span class="tab-icon">${tab.icon}</span>` +
        `<span class="tab-label">${tab.label}</span>` +
        `<button class="tab-close" data-close="${tab.id}" title="íƒ­ ë‹«ê¸°">Ã—</button>`;

      el.addEventListener('click', e=>{
        if (e.target.closest('.tab-close')) return;
        activateTab(tab.id);
      });
      el.querySelector('.tab-close').addEventListener('click', e=>{
        e.stopPropagation();
        closeTab(tab.id);
      });
      tabbar.insertBefore(el, addBtn);
    });
  }

  /* â”€â”€ ADD MENU â”€â”€ */
  const addMenu = document.getElementById('addMenu');

  addBtn.addEventListener('click', e=>{
    e.stopPropagation();
    const rect = addBtn.getBoundingClientRect();
    addMenu.style.top  = (rect.bottom + 6) + 'px';
    addMenu.style.left = rect.left + 'px';
    addMenu.classList.toggle('open');
  });

  addMenu.querySelectorAll('.add-menu-item').forEach(item=>{
    item.addEventListener('click', ()=>{
      addMenu.classList.remove('open');
      openTab(item.dataset.page);
    });
  });

  document.addEventListener('click', e=>{
    if (!addMenu.contains(e.target) && e.target !== addBtn) {
      addMenu.classList.remove('open');
    }
  });

  /* â”€â”€ WELCOME CHIPS â”€â”€ */
  document.querySelectorAll('.welcome-chip').forEach(chip=>{
    chip.addEventListener('click', ()=>openTab(chip.dataset.page));
  });

  /* â”€â”€ ì´ˆê¸° ìƒíƒœ: ì›°ì»´ í‘œì‹œ â”€â”€ */
  showWelcome();
  renderTabs();
}
</script>
</body>
</html>
