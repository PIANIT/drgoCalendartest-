<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìº˜ë¦°ë” ê´€ë¦¬ì â€” DB Manager</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #111111;
  --surface: #1c1c1c;
  --surface2: #272727;
  --surface3: #303030;
  --border: #3a3a3a;
  --accent: #d4bc96;
  --accent2: #90bcd4;
  --text: #f0ebe2;
  --text-muted: #a09890;
  --red: #d48888;
  --green: #88d488;
  --chip-gold-bg: #c8a870;
  --chip-gold-text: #1a1207;
  --chip-blue-bg: #7aaec8;
  --chip-blue-text: #061825;
  --chip-red-bg: #c87070;
  --chip-red-text: #200808;
  --chip-green-bg: #70c870;
  --chip-green-text: #08200a;
  --chip-purple-bg: #9b70c8;
  --chip-purple-text: #f0eaff;
  --font-main: "Malgun Gothic","ë§‘ì€ ê³ ë”•",-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
  --font-mono: 'DM Mono',"Malgun Gothic","ë§‘ì€ ê³ ë”•",monospace;
}
html.light {
  --bg: #f7f4f0; --surface: #ffffff; --surface2: #efebe4; --surface3: #e8e2d8;
  --border: #d8d0c4; --accent: #9c7d48; --accent2: #3a7a9a;
  --text: #1e1812; --text-muted: #7a6e60; --red: #a84444; --green: #3a8a3a;
  --chip-gold-bg: #b89558; --chip-gold-text: #ffffff;
  --chip-blue-bg: #5898ba; --chip-blue-text: #ffffff;
  --chip-red-bg: #b85858; --chip-red-text: #ffffff;
  --chip-green-bg: #58b058; --chip-green-text: #ffffff;
  --chip-purple-bg: #7b50a8; --chip-purple-text: #ffffff;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:var(--font-main); min-height:100vh; }

/* â”€â”€ AUTH OVERLAY â”€â”€ */
#authOverlay {
  display:flex; position:fixed; inset:0; z-index:9999;
  background:var(--bg); align-items:center; justify-content:center;
}
#authOverlay.hidden { display:none; }
.auth-box {
  width:100%; max-width:380px; padding:48px 36px 40px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:20px; box-shadow:0 24px 64px rgba(0,0,0,0.55);
  display:flex; flex-direction:column; align-items:center;
}
.auth-logo { font-family:var(--font-mono); font-size:11px; letter-spacing:0.25em; color:var(--text-muted); text-transform:uppercase; margin-bottom:24px; }
.auth-icon { font-size:36px; margin-bottom:8px; }
.auth-title { font-size:20px; font-weight:700; color:var(--accent); margin-bottom:4px; }
.auth-sub { font-size:11px; color:var(--text-muted); letter-spacing:0.1em; margin-bottom:32px; }
.auth-input-wrap { width:100%; margin-bottom:14px; }
.auth-input {
  width:100%; padding:13px 16px; font-size:15px;
  background:var(--surface2); border:1.5px solid var(--border);
  border-radius:10px; color:var(--text); font-family:var(--font-main);
  outline:none; transition:border-color 0.2s; letter-spacing:0.1em;
}
.auth-input:focus { border-color:var(--accent); }
.auth-input.error { border-color:var(--red); animation:shake 0.35s ease; }
@keyframes shake {
  0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)}
  40%{transform:translateX(8px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)}
}
.auth-btn {
  width:100%; padding:14px; background:var(--accent); color:#1a1207;
  border:none; border-radius:10px; font-size:14px; font-weight:700;
  font-family:var(--font-main); cursor:pointer; transition:all 0.2s; letter-spacing:0.06em;
}
.auth-btn:hover { background:#e0cc9e; transform:translateY(-1px); }
.auth-btn:disabled { opacity:0.45; cursor:not-allowed; transform:none; }
.auth-error { margin-top:12px; font-size:12px; color:var(--red); text-align:center; min-height:18px; }
.auth-lock { margin-top:6px; font-size:11px; color:var(--text-muted); text-align:center; }

/* â”€â”€ HEADER â”€â”€ */
header {
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 32px; border-bottom:1px solid var(--border);
  position:sticky; top:0; z-index:10; background:var(--bg);
}
.header-left { display:flex; align-items:center; gap:16px; }
.app-title { font-family:var(--font-mono); font-size:12px; letter-spacing:0.22em; color:var(--accent); text-transform:uppercase; }
.admin-badge {
  font-family:var(--font-mono); font-size:10px; letter-spacing:0.15em;
  padding:3px 10px; border-radius:4px; text-transform:uppercase;
  background:rgba(212,188,150,0.12); color:var(--accent); border:1px solid rgba(212,188,150,0.3);
}
.header-right { display:flex; align-items:center; gap:10px; }
.icon-btn {
  background:none; border:1px solid var(--border); color:var(--text-muted);
  width:32px; height:32px; border-radius:7px; cursor:pointer; font-size:15px;
  display:flex; align-items:center; justify-content:center; transition:all 0.2s;
}
.icon-btn:hover { border-color:var(--accent); color:var(--accent); }

/* â”€â”€ STATS BAR â”€â”€ */
.stats-bar {
  display:grid; grid-template-columns:repeat(6,1fr); gap:1px;
  background:var(--border); border-bottom:1px solid var(--border);
}
.stat-card {
  background:var(--surface); padding:18px 24px; display:flex; flex-direction:column; gap:4px;
}
.stat-label { font-family:var(--font-mono); font-size:10px; letter-spacing:0.2em; color:var(--text-muted); text-transform:uppercase; }
.stat-value { font-size:24px; font-weight:700; color:var(--text); font-family:var(--font-mono); }
.stat-value.gold  { color:var(--chip-gold-bg); }
.stat-value.blue  { color:var(--chip-blue-bg); }
.stat-value.red   { color:var(--chip-red-bg); }
.stat-value.green { color:var(--chip-green-bg); }
.stat-value.purple{ color:var(--chip-purple-bg); }

/* â”€â”€ TOOLBAR â”€â”€ */
.toolbar {
  display:flex; align-items:center; gap:12px; padding:16px 32px;
  border-bottom:1px solid var(--border); flex-wrap:wrap;
}
.search-wrap { position:relative; flex:1; min-width:200px; max-width:360px; }
.search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:14px; color:var(--text-muted); pointer-events:none; }
.search-input {
  width:100%; padding:9px 12px 9px 36px; font-size:13px;
  background:var(--surface2); border:1px solid var(--border);
  border-radius:8px; color:var(--text); font-family:var(--font-main);
  outline:none; transition:border-color 0.2s;
}
.search-input:focus { border-color:var(--accent); }
.filter-group { display:flex; gap:6px; }
.filter-btn {
  padding:7px 14px; border-radius:7px; border:1px solid var(--border);
  background:var(--surface2); color:var(--text-muted); font-size:12px;
  cursor:pointer; transition:all 0.15s; font-family:var(--font-main); font-weight:500;
  display:flex; align-items:center; gap:5px; white-space:nowrap;
}
.filter-btn:hover { border-color:var(--accent); color:var(--accent); }
.filter-btn.active { border-color:var(--accent); background:rgba(212,188,150,0.15); color:var(--accent); font-weight:600; }
.filter-btn.f-gold.active  { border-color:var(--chip-gold-bg);  background:rgba(200,168,112,0.15); color:var(--chip-gold-bg); }
.filter-btn.f-blue.active  { border-color:var(--chip-blue-bg);  background:rgba(122,174,200,0.15); color:var(--chip-blue-bg); }
.filter-btn.f-red.active   { border-color:var(--chip-red-bg);   background:rgba(200,112,112,0.15); color:var(--chip-red-bg); }
.filter-btn.f-green.active { border-color:var(--chip-green-bg); background:rgba(112,200,112,0.15); color:var(--chip-green-bg); }
.filter-btn.f-purple.active{ border-color:var(--chip-purple-bg);background:rgba(155,112,200,0.15); color:var(--chip-purple-bg); }
.color-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.cd-gold  { background:var(--chip-gold-bg); }
.cd-blue  { background:var(--chip-blue-bg); }
.cd-red   { background:var(--chip-red-bg); }
.cd-green { background:var(--chip-green-bg); }
.cd-purple{ background:var(--chip-purple-bg); }

.toolbar-right { display:flex; gap:8px; margin-left:auto; }
.action-btn {
  padding:8px 16px; border-radius:8px; border:1px solid var(--border);
  background:var(--surface2); color:var(--text-muted); font-size:12px; font-weight:600;
  cursor:pointer; transition:all 0.2s; font-family:var(--font-main);
  display:flex; align-items:center; gap:6px; white-space:nowrap;
}
.action-btn:hover { border-color:var(--accent); color:var(--accent); }
.action-btn.danger { color:var(--red); }
.action-btn.danger:hover { border-color:var(--red); background:rgba(212,136,136,0.1); }
.action-btn.primary { background:var(--accent); color:#1a1207; border-color:var(--accent); }
.action-btn.primary:hover { background:#e0cc9e; }

/* â”€â”€ DATE RANGE FILTER â”€â”€ */
.date-range-wrap {
  display:flex; align-items:center; gap:8px;
}
.date-range-label {
  font-family:var(--font-mono); font-size:10px; letter-spacing:0.15em;
  text-transform:uppercase; color:var(--text-muted); white-space:nowrap;
}
/* index.html dt-input ìŠ¤íƒ€ì¼ì˜ ë‚ ì§œ ì„ íƒ */
.dr-date-box {
  position:relative; display:inline-flex; align-items:center;
  background:var(--surface); border:1px solid var(--border);
  border-radius:7px; transition:border-color 0.2s;
  cursor:pointer; user-select:none;
}
.dr-date-box:focus-within,
.dr-date-box:hover { border-color:var(--accent); }
.dr-date-box input[type="date"] {
  position:absolute; width:0; height:0; opacity:0; pointer-events:none; border:none; padding:0;
}
html.light .dr-date-box input[type="date"] { color-scheme:light; }
.dr-date-display {
  padding:7px 14px; font-size:13px; font-family:var(--font-mono);
  color:var(--text); white-space:nowrap;
  min-width:108px; display:flex; align-items:center; gap:6px;
}
.dr-date-display .dr-cal-icon { font-size:13px; opacity:0.55; }
.dr-date-display.empty { color:var(--text-muted); }
.date-range-sep { color:var(--text-muted); font-size:13px; }
.date-range-clear {
  background:none; border:1px solid var(--border); color:var(--text-muted);
  padding:6px 10px; border-radius:7px; font-size:11px; cursor:pointer;
  font-family:var(--font-mono); transition:all 0.15s; white-space:nowrap;
}
.date-range-clear:hover { border-color:var(--red); color:var(--red); }

/* â”€â”€ SORT BAR â”€â”€ */
.sort-bar {
  display:grid; align-items:center; padding:10px 32px;
  border-bottom:1px solid var(--border);
  font-family:var(--font-mono); font-size:11px; color:var(--text-muted);
  letter-spacing:0.1em; text-transform:uppercase;
  grid-template-columns: 36px 2fr 100px 1.4fr 70px 80px 80px 80px;
  gap:10px;
}
.sort-col { cursor:pointer; user-select:none; display:flex; align-items:center; gap:4px; transition:color 0.15s; }
.sort-col:hover { color:var(--accent); }
.sort-col.active { color:var(--accent); }
.sort-arrow { font-size:10px; opacity:0.6; }

/* â”€â”€ EVENT LIST â”€â”€ */
.events-container { padding:0 32px 100px; }
.event-row {
  display:grid; align-items:center; padding:13px 0;
  border-bottom:1px solid rgba(58,58,58,0.6);
  grid-template-columns: 36px 2fr 100px 1.4fr 70px 80px 80px 80px;
  gap:10px; cursor:pointer; transition:background 0.12s; border-radius:4px;
  padding-left:4px; padding-right:4px;
}
.event-row:hover { background:var(--surface); }
.event-row.selected { background:rgba(212,188,150,0.08); }

.row-check { display:flex; align-items:center; justify-content:center; }
.check-circle {
  width:18px; height:18px; border:1.5px solid var(--border); border-radius:4px;
  display:flex; align-items:center; justify-content:center; transition:all 0.15s; flex-shrink:0; font-size:11px;
}
.event-row.selected .check-circle { background:var(--accent); border-color:var(--accent); color:#1a1207; }

.row-title { display:flex; align-items:center; gap:8px; min-width:0; }
.color-bar { width:3px; height:28px; border-radius:2px; flex-shrink:0; }
.cb-gold  { background:var(--chip-gold-bg); }
.cb-blue  { background:var(--chip-blue-bg); }
.cb-red   { background:var(--chip-red-bg); }
.cb-green { background:var(--chip-green-bg); }
.cb-purple{ background:var(--chip-purple-bg); }
.title-text { font-size:14px; font-weight:500; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.title-sub { font-size:11px; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:1px; }

.row-date { font-family:var(--font-mono); font-size:12px; color:var(--text-muted); }
.row-person { font-size:13px; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.row-address { font-size:12px; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.85; }
.row-badge {
  display:inline-flex; align-items:center; padding:3px 9px; border-radius:5px;
  font-family:var(--font-mono); font-size:10px; font-weight:600; letter-spacing:0.06em;
  white-space:nowrap;
}
.rb-gold  { background:rgba(200,168,112,0.18); color:var(--chip-gold-bg); border:1px solid rgba(200,168,112,0.3); }
.rb-blue  { background:rgba(122,174,200,0.18); color:var(--chip-blue-bg); border:1px solid rgba(122,174,200,0.3); }
.rb-red   { background:rgba(200,112,112,0.18); color:var(--chip-red-bg);  border:1px solid rgba(200,112,112,0.3); }
.rb-green { background:rgba(112,200,112,0.18); color:var(--chip-green-bg);border:1px solid rgba(112,200,112,0.3); }
.rb-purple{ background:rgba(155,112,200,0.18); color:var(--chip-purple-bg);border:1px solid rgba(155,112,200,0.3); }

.row-flags { display:flex; gap:3px; flex-wrap:wrap; font-size:13px; }
.row-actions { display:flex; gap:6px; justify-content:flex-end; }
.row-action-btn {
  background:none; border:1px solid var(--border); color:var(--text-muted);
  width:28px; height:28px; border-radius:6px; cursor:pointer; font-size:13px;
  display:flex; align-items:center; justify-content:center; transition:all 0.15s;
}
.row-action-btn:hover.edit { border-color:var(--accent); color:var(--accent); }
.row-action-btn:hover.del  { border-color:var(--red); color:var(--red); }

.empty-state { text-align:center; padding:80px 0; color:var(--text-muted); }
.empty-icon { font-size:48px; margin-bottom:16px; opacity:0.4; }
.empty-text { font-size:14px; }

/* â”€â”€ DETAIL MODAL â”€â”€ */
.modal-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.75); z-index:100;
  backdrop-filter:blur(6px); align-items:center; justify-content:center; padding:24px;
}
.modal-overlay.open { display:flex; }
.modal {
  background:var(--surface); border:1px solid var(--border); border-radius:16px;
  width:100%; max-width:700px; max-height:88vh; overflow-y:auto;
  animation:modalIn 0.2s ease;
}
@keyframes modalIn { from{opacity:0;transform:translateY(16px) scale(0.97)} to{opacity:1;transform:none} }
.modal-strip { height:4px; border-radius:16px 16px 0 0; }
.ms-gold  { background:var(--chip-gold-bg); }
.ms-blue  { background:var(--chip-blue-bg); }
.ms-red   { background:var(--chip-red-bg); }
.ms-green { background:var(--chip-green-bg); }
.ms-purple{ background:var(--chip-purple-bg); }
.modal-header { padding:20px 24px 16px; display:flex; align-items:flex-start; justify-content:space-between; gap:12px; border-bottom:1px solid var(--border); }
.modal-header-info { flex:1; min-width:0; }
.modal-badge { font-family:var(--font-mono); font-size:10px; letter-spacing:0.15em; color:var(--text-muted); text-transform:uppercase; margin-bottom:6px; }
.modal-event-title { font-size:20px; font-weight:600; color:var(--text); }
.modal-close { background:none; border:1px solid var(--border); color:var(--text-muted); width:32px; height:32px; border-radius:8px; cursor:pointer; font-size:15px; display:flex; align-items:center; justify-content:center; transition:all 0.2s; flex-shrink:0; }
.modal-close:hover { border-color:var(--red); color:var(--red); }
.modal-body { padding:20px 24px 0; display:flex; flex-direction:column; gap:16px; }
.detail-section { display:flex; flex-direction:column; gap:8px; }
.detail-section-title { font-family:var(--font-mono); font-size:10px; letter-spacing:0.22em; text-transform:uppercase; color:var(--text-muted); display:flex; align-items:center; gap:10px; }
.detail-section-title::after { content:''; flex:1; height:1px; background:var(--border); }
.detail-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
.detail-item { background:var(--surface2); border-radius:8px; padding:10px 13px; }
.detail-key { font-family:var(--font-mono); font-size:10px; letter-spacing:0.15em; color:var(--text-muted); text-transform:uppercase; margin-bottom:4px; }
.detail-val { font-size:13px; color:var(--text); word-break:break-word; white-space:pre-wrap; }
.detail-val.mono { font-family:var(--font-mono); font-size:12px; }
.detail-val.empty { color:var(--text-muted); font-style:italic; }
.flags-row { display:flex; gap:6px; flex-wrap:wrap; }
.flag-chip { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:6px; font-size:12px; background:var(--surface2); border:1px solid var(--border); color:var(--text-muted); }
.modal-footer { padding:16px 24px 20px; display:flex; justify-content:space-between; align-items:center; gap:10px; border-top:1px solid var(--border); margin-top:20px; }
.modal-id { font-family:var(--font-mono); font-size:10px; color:var(--text-muted); letter-spacing:0.08em; }
.btn-modal-del { background:none; border:1px solid rgba(212,136,136,0.4); color:var(--red); padding:8px 16px; border-radius:8px; font-size:13px; cursor:pointer; transition:all 0.2s; font-family:var(--font-main); }
.btn-modal-del:hover { background:rgba(212,136,136,0.1); border-color:var(--red); }
.btn-modal-close { background:var(--accent); color:#1a1207; border:none; padding:9px 24px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.2s; font-family:var(--font-main); }
.btn-modal-close:hover { background:#e0cc9e; }

/* â”€â”€ IMPORT MODAL â”€â”€ */
.import-modal { max-width:520px; }
.import-zone {
  border:2px dashed var(--border); border-radius:12px; padding:40px 24px;
  text-align:center; cursor:pointer; transition:all 0.2s; position:relative; margin-bottom:16px;
}
.import-zone:hover, .import-zone.drag-over { border-color:var(--accent); background:rgba(212,188,150,0.04); }
.import-zone input { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
.import-zone-icon { font-size:32px; margin-bottom:10px; }
.import-zone-text { font-size:13px; color:var(--text-muted); }
.import-zone-text span { color:var(--accent); }
.import-preview { background:var(--surface2); border-radius:8px; padding:14px; font-family:var(--font-mono); font-size:12px; color:var(--text-muted); margin-bottom:16px; }
.import-btn-row { display:flex; gap:10px; justify-content:flex-end; }

/* â”€â”€ USER MANAGEMENT â”€â”€ */
.user-mgmt-wrap {
  padding:20px 32px; border-bottom:1px solid var(--border);
  background:var(--surface);
}
.user-mgmt-header {
  display:flex; align-items:center; justify-content:space-between; margin-bottom:0;
}
.user-mgmt-title {
  font-family:var(--font-mono); font-size:12px; letter-spacing:0.2em;
  text-transform:uppercase; color:var(--accent); display:flex; align-items:center; gap:8px;
}
.user-mgmt-toggle {
  background:none; border:1px solid var(--border); color:var(--text-muted);
  padding:5px 13px; border-radius:7px; font-size:12px; cursor:pointer;
  font-family:var(--font-main); transition:all 0.15s;
}
.user-mgmt-toggle:hover { border-color:var(--accent); color:var(--accent); }
.user-mgmt-body { display:none; padding-top:16px; }
.user-mgmt-body.open { display:block; }
.user-create-form {
  display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom:14px;
  padding:14px 16px; background:var(--surface2); border-radius:10px; border:1px solid var(--border);
}
.user-form-field { display:flex; flex-direction:column; gap:5px; }
.user-form-label { font-family:var(--font-mono); font-size:10px; letter-spacing:0.15em; text-transform:uppercase; color:var(--text-muted); }
.user-form-input {
  padding:8px 12px; font-size:13px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:8px; color:var(--text); font-family:var(--font-main);
  outline:none; transition:border-color 0.2s; min-width:150px;
}
.user-form-input:focus { border-color:var(--accent); }
.user-form-input.error { border-color:var(--red); }
.user-create-btn {
  padding:8px 16px; border-radius:8px; border:none;
  background:var(--accent); color:#1a1207; font-size:13px; font-weight:700;
  cursor:pointer; font-family:var(--font-main); transition:all 0.15s; white-space:nowrap;
}
.user-create-btn:hover { background:#e0cc9e; }
.user-list { display:flex; flex-direction:column; gap:6px; }
.user-list-empty { padding:16px 4px; color:var(--text-muted); font-size:13px; }
.user-row {
  display:flex; align-items:center; gap:12px;
  padding:9px 13px; background:var(--surface2); border-radius:8px; border:1px solid var(--border);
}
.user-row-id { font-family:var(--font-mono); font-size:13px; color:var(--text); font-weight:600; flex:1; }
.user-row-meta { font-size:11px; color:var(--text-muted); }
.user-row-del {
  background:none; border:1px solid rgba(212,136,136,0.3); color:var(--red);
  padding:4px 10px; border-radius:6px; font-size:11px; cursor:pointer;
  font-family:var(--font-main); transition:all 0.15s;
}
.user-row-del:hover { background:rgba(212,136,136,0.12); border-color:var(--red); }

/* â”€â”€ CONFIRM DIALOG â”€â”€ */
.confirm-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:200;
  align-items:center; justify-content:center; backdrop-filter:blur(4px);
}
.confirm-overlay.open { display:flex; }
.confirm-box { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:28px; max-width:360px; width:100%; text-align:center; }
.confirm-icon { font-size:32px; margin-bottom:12px; }
.confirm-title { font-size:17px; font-weight:600; margin-bottom:8px; }
.confirm-text { font-size:13px; color:var(--text-muted); line-height:1.6; margin-bottom:22px; }
.confirm-btns { display:flex; gap:10px; }
.confirm-cancel { flex:1; background:var(--surface2); border:1px solid var(--border); color:var(--text-muted); padding:10px; border-radius:8px; font-size:13px; cursor:pointer; transition:all 0.15s; font-family:var(--font-main); }
.confirm-cancel:hover { border-color:var(--border); color:var(--text); }
.confirm-ok { flex:1; background:var(--red); color:#fff; border:none; padding:10px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.15s; font-family:var(--font-main); }
.confirm-ok:hover { background:#df9898; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position:fixed; bottom:28px; left:50%; transform:translateX(-50%) translateY(20px);
  background:var(--surface); border:1px solid var(--border); border-radius:10px;
  padding:12px 20px; font-size:13px; box-shadow:0 8px 28px rgba(0,0,0,0.4);
  opacity:0; transition:all 0.25s; z-index:9999; white-space:nowrap;
  display:flex; align-items:center; gap:8px;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
.toast.success { border-color:var(--green); color:var(--green); }
.toast.error   { border-color:var(--red);   color:var(--red); }
.toast.info    { border-color:var(--accent); color:var(--accent); }

/* â”€â”€ PAGINATION â”€â”€ */
.pagination { display:flex; align-items:center; gap:8px; padding:20px 32px; border-top:1px solid var(--border); position:fixed; bottom:0; left:0; right:0; background:var(--bg); }
.page-btn { padding:6px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--text-muted); font-size:12px; cursor:pointer; transition:all 0.15s; font-family:var(--font-mono); }
.page-btn:hover { border-color:var(--accent); color:var(--accent); }
.page-btn.active { background:rgba(212,188,150,0.2); border-color:var(--accent); color:var(--accent); font-weight:700; }
.page-btn:disabled { opacity:0.35; cursor:not-allowed; }
.page-info { font-family:var(--font-mono); font-size:11px; color:var(--text-muted); margin-left:auto; letter-spacing:0.08em; }
.sel-count { font-family:var(--font-mono); font-size:11px; color:var(--accent); }

/* â”€â”€ JSON VIEW â”€â”€ */
.json-modal { max-width:760px; }
.json-view-box {
  background:var(--surface2); border:1px solid var(--border); border-radius:8px;
  padding:16px; font-family:var(--font-mono); font-size:11px; line-height:1.7;
  color:var(--text-muted); max-height:400px; overflow-y:auto; white-space:pre-wrap; word-break:break-all;
}

::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:999px; }

@media (max-width:900px) {
  .stats-bar { grid-template-columns:repeat(3,1fr); }
  .sort-bar, .event-row { grid-template-columns:36px 2fr 100px 80px; }
  .sort-bar .hide-m, .event-row .hide-m { display:none; }
  .toolbar { padding:12px 16px; }
  .events-container { padding:0 16px 100px; }
  header { padding:12px 16px; }
  .sort-bar { padding:10px 16px; }
}
</style>
</head>
<body>

<!-- â•â•â• AUTH â•â•â• -->
<div id="authOverlay">
  <div class="auth-box">
    <div class="auth-logo">Calendar</div>
    <div class="auth-icon">ğŸ”</div>
    <div class="auth-title">ê´€ë¦¬ì ë¡œê·¸ì¸</div>
    <div class="auth-sub">DB MANAGER Â· DRGO TEAM</div>
    <div class="auth-input-wrap">
      <input class="auth-input" type="password" id="authInput" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" maxlength="32" />
    </div>
    <button class="auth-btn" id="authBtn">ì ‘ì†</button>
    <div class="auth-error" id="authError"></div>
    <div class="auth-lock" id="authLock"></div>
  </div>
</div>

<!-- â•â•â• HEADER â•â•â• -->
<header>
  <div class="header-left">
    <span class="app-title">ğŸ—ƒï¸ DB Manager</span>
    <span class="admin-badge">Admin</span>
  </div>
  <div class="header-right">
    <button class="icon-btn" id="refreshBtn" title="ìƒˆë¡œê³ ì¹¨">â†»</button>
    <button class="icon-btn" id="themeBtn" title="í…Œë§ˆ">ğŸŒ™</button>
  </div>
</header>

<!-- â•â•â• STATS â•â•â• -->
<div class="stats-bar" id="statsBar">
  <div class="stat-card">
    <div class="stat-label">ì „ì²´ ì¼ì •</div>
    <div class="stat-value" id="st-total">â€”</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">ë°©ë¬¸ì˜ë¢°</div>
    <div class="stat-value gold" id="st-gold">â€”</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">ì‚¬ë‚´ì—…ë¬´</div>
    <div class="stat-value blue" id="st-blue">â€”</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">íœ´ê°€ê´€ë ¨</div>
    <div class="stat-value red" id="st-red">â€”</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">ì´¬ì˜ê´€ë ¨</div>
    <div class="stat-value green" id="st-green">â€”</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">ë¯¸íŒ…/ë‚´ë°©</div>
    <div class="stat-value purple" id="st-purple">â€”</div>
  </div>
</div>

<!-- â•â•â• USER MANAGEMENT â•â•â• -->
<div class="user-mgmt-wrap" id="userMgmtWrap" style="display:none;">
  <div class="user-mgmt-header">
    <div class="user-mgmt-title">ğŸ‘¤ ìº˜ë¦°ë” ì ‘ì† ê³„ì • ê´€ë¦¬</div>
    <button class="user-mgmt-toggle" id="userMgmtToggle">í¼ì¹˜ê¸° â–¾</button>
  </div>
  <div class="user-mgmt-body" id="userMgmtBody">
    <div class="user-create-form">
      <div class="user-form-field">
        <label class="user-form-label">ì•„ì´ë””</label>
        <input class="user-form-input" id="newUserId" placeholder="ì˜ˆ: hong" maxlength="30" autocomplete="off" />
      </div>
      <div class="user-form-field">
        <label class="user-form-label">ì´ë¦„ <span style="color:var(--red);">*</span></label>
        <input class="user-form-input" id="newUserName" placeholder="ì˜ˆ: í™ê¸¸ë™" maxlength="20" autocomplete="off" />
      </div>
      <div class="user-form-field">
        <label class="user-form-label">ë¹„ë°€ë²ˆí˜¸</label>
        <input class="user-form-input" id="newUserPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" maxlength="32" autocomplete="new-password" />
      </div>
      <button class="user-create-btn" id="userCreateBtn">â• ê³„ì • ì¶”ê°€</button>
    </div>
    <div class="user-list" id="userList">
      <div class="user-list-empty">ë¡œë”© ì¤‘â€¦</div>
    </div>
  </div>
</div>

<!-- â•â•â• TOOLBAR â•â•â• -->
<div class="toolbar">
  <div class="search-wrap">
    <span class="search-icon">ğŸ”</span>
    <input class="search-input" id="searchInput" placeholder="ì œëª©, ì´ë¦„, ì£¼ì†Œ ê²€ìƒ‰â€¦" />
  </div>
  <div class="filter-group" id="filterGroup">
    <button class="filter-btn active" data-filter="all">ì „ì²´</button>
    <button class="filter-btn f-gold" data-filter="gold"><span class="color-dot cd-gold"></span>ë°©ë¬¸ì˜ë¢°</button>
    <button class="filter-btn f-blue" data-filter="blue"><span class="color-dot cd-blue"></span>ì‚¬ë‚´ì—…ë¬´</button>
    <button class="filter-btn f-red"  data-filter="red" ><span class="color-dot cd-red"></span>íœ´ê°€ê´€ë ¨</button>
    <button class="filter-btn f-green" data-filter="green"><span class="color-dot cd-green"></span>ì´¬ì˜ê´€ë ¨</button>
    <button class="filter-btn f-purple" data-filter="purple"><span class="color-dot cd-purple"></span>ë¯¸íŒ…/ë‚´ë°©</button>
  </div>
  <div class="date-range-wrap" id="dateRangeWrap">
    <span class="date-range-label">ê¸°ê°„</span>
    <div class="dr-date-box" id="drFromBox">
      <input type="date" id="dateFrom" />
      <div class="dr-date-display empty" id="drFromDisplay"><span class="dr-cal-icon">ğŸ“…</span><span id="drFromText">ì‹œì‘ì¼</span></div>
    </div>
    <span class="date-range-sep">â€”</span>
    <div class="dr-date-box" id="drToBox">
      <input type="date" id="dateTo" />
      <div class="dr-date-display empty" id="drToDisplay"><span class="dr-cal-icon">ğŸ“…</span><span id="drToText">ì¢…ë£Œì¼</span></div>
    </div>
    <button class="date-range-clear" id="dateRangeClear" style="display:none;">âœ• ì´ˆê¸°í™”</button>
  </div>
  <div class="toolbar-right">
    <button class="action-btn" id="exportBtn">ğŸ“¤ ë°±ì—… (JSON)</button>
    <button class="action-btn" id="importBtn">ğŸ“¥ ë³µì› (JSON)</button>
    <button class="action-btn danger" id="bulkDeleteBtn" style="display:none;">ğŸ—‘ ì„ íƒ ì‚­ì œ</button>
  </div>
</div>

<!-- â•â•â• SORT BAR â•â•â• -->
<div class="sort-bar">
  <div></div>
  <div class="sort-col active" data-sort="title">ì œëª© <span class="sort-arrow" id="sa-title">â†‘</span></div>
  <div class="sort-col hide-m" data-sort="startDate">ë‚ ì§œ <span class="sort-arrow" id="sa-startDate"></span></div>
  <div class="sort-col hide-m" data-sort="address">ì£¼ì†Œ</div>
  <div class="sort-col hide-m" data-sort="name">ë‹´ë‹¹ì <span class="sort-arrow" id="sa-name"></span></div>
  <div class="sort-col" data-sort="color">ë¶„ë¥˜ <span class="sort-arrow" id="sa-color"></span></div>
  <div class="sort-col" data-sort="flags">ì˜µì…˜</div>
  <div>ì‘ì—…</div>
</div>

<!-- â•â•â• EVENT LIST â•â•â• -->
<div class="events-container" id="eventList"></div>

<!-- â•â•â• PAGINATION â•â•â• -->
<div class="pagination" id="pagination">
  <button class="page-btn" id="pagePrev" disabled>â€¹</button>
  <div id="pageNums" style="display:flex;gap:6px;"></div>
  <button class="page-btn" id="pageNext" disabled>â€º</button>
  <span class="sel-count" id="selCount" style="display:none;margin-left:8px;"></span>
  <span class="page-info" id="pageInfo"></span>
</div>

<!-- â•â•â• DETAIL MODAL â•â•â• -->
<div class="modal-overlay" id="detailOverlay">
  <div class="modal" id="detailModal">
    <div class="modal-strip" id="detailStrip"></div>
    <div class="modal-header">
      <div class="modal-header-info">
        <div class="modal-badge" id="detailBadge"></div>
        <div class="modal-event-title" id="detailTitle"></div>
      </div>
      <button class="modal-close" id="detailClose">âœ•</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer">
      <span class="modal-id" id="detailId"></span>
      <div style="display:flex;gap:10px;">
        <button class="btn-modal-del" id="detailDeleteBtn">ğŸ—‘ ì‚­ì œ</button>
        <button class="btn-modal-close" id="detailCloseBtn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• IMPORT MODAL â•â•â• -->
<div class="modal-overlay" id="importOverlay">
  <div class="modal import-modal">
    <div class="modal-strip" style="background:var(--accent2);"></div>
    <div class="modal-header">
      <div class="modal-header-info">
        <div class="modal-badge">ë°ì´í„° ë³µì›</div>
        <div class="modal-event-title">JSON íŒŒì¼ì—ì„œ ë³µì›</div>
      </div>
      <button class="modal-close" id="importClose">âœ•</button>
    </div>
    <div class="modal-body" style="padding:20px 24px;">
      <div class="import-zone" id="importZone">
        <input type="file" id="importFile" accept=".json" />
        <div class="import-zone-icon">ğŸ“‚</div>
        <div class="import-zone-text">JSON íŒŒì¼ì„ <span>í´ë¦­</span>í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
      </div>
      <div class="import-preview" id="importPreview" style="display:none;"></div>
      <div style="background:rgba(212,136,136,0.1);border:1px solid rgba(212,136,136,0.3);border-radius:8px;padding:12px 14px;font-size:12px;color:var(--red);line-height:1.6;">
        âš ï¸ <strong>ì£¼ì˜:</strong> ë³µì› ì‹œ ê¸°ì¡´ DBì˜ ë™ì¼í•œ IDë¥¼ ê°€ì§„ ì¼ì •ì€ ë®ì–´ì“°ê¸° ë©ë‹ˆë‹¤. ë³µì› ì „ í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—…í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
      </div>
    </div>
    <div class="modal-footer">
      <span class="modal-id" id="importInfo" style="color:var(--text-muted);"></span>
      <div style="display:flex;gap:10px;">
        <button class="action-btn" id="importCancelBtn">ì·¨ì†Œ</button>
        <button class="action-btn primary" id="importConfirmBtn" disabled>ğŸ“¥ ë³µì› ì‹¤í–‰</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• CONFIRM â•â•â• -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-icon" id="confirmIcon">âš ï¸</div>
    <div class="confirm-title" id="confirmTitle"></div>
    <div class="confirm-text" id="confirmText"></div>
    <div class="confirm-btns">
      <button class="confirm-cancel" id="confirmCancel">ì·¨ì†Œ</button>
      <button class="confirm-ok" id="confirmOk">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- â•â•â• TOAST â•â•â• -->
<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, doc, deleteDoc, setDoc, getDoc, getDocs, onSnapshot, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG & CONSTANTS  (ë°˜ë“œì‹œ ë§¨ ìœ„)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const firebaseConfig = {
  apiKey: "AIzaSyDnEOATYmwq0WJr6pCl-86-Q3ZEQjrrfeY",
  authDomain: "drgo-calender.firebaseapp.com",
  projectId: "drgo-calender",
  storageBucket: "drgo-calender.firebasestorage.app",
  messagingSenderId: "163730741115",
  appId: "1:163730741115:web:73a06d5b1cf1a477734fde"
};

const ADMIN_HASH  = 'b536e460b48ff9981aeee9b2cfb0bb01548a3b111fe16cdec6dbc5a4c6e7a4c2';
const SESSION_KEY = 'cal_admin_ok';
const TRIES_KEY   = 'cal_admin_tries';
const LOCK_KEY    = 'cal_admin_lock';
const MAX_TRIES   = 5;
const LOCK_MS     = 120000;

const TYPE_LABELS    = { gold:'ë°©ë¬¸ì˜ë¢°', blue:'ì‚¬ë‚´ì—…ë¬´', red:'íœ´ê°€ê´€ë ¨', green:'ì´¬ì˜ê´€ë ¨', purple:'ë¯¸íŒ…/ë‚´ë°©' };
const SPECIAL_LABELS = { car:'ğŸš—ì°¨ëŸ‰', brief:'ğŸ’¼ì œí’ˆ', return:'â†', group:'ğŸ‘¥2ì¸', urgent:'ğŸš¨ê¸´ê¸‰', ladder:'ğŸªœì‚¬ë‹¤ë¦¬' };
const SCHED_LABELS   = { suggest:'ğŸ’¬ì œì•ˆ', hope:'ğŸ™í¬ë§', target:'ğŸ¯ëª©í‘œ' };

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let allEvents      = [];
let filteredEvents = [];
let selectedIds    = new Set();
let currentFilter  = 'all';
let searchQuery    = '';
let sortKey        = 'startDate';
let sortDir        = 1;
let currentPage    = 1;
const PAGE_SIZE    = 25;
let confirmCallback = null;
let importData      = null;
let dateFrom        = '';
let dateTo          = '';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function isAuth()     { return sessionStorage.getItem(SESSION_KEY) === '1'; }
function getLockRem() { return Math.max(0, parseInt(localStorage.getItem(LOCK_KEY)||'0') - Date.now()); }

function updateLockUI() {
  const rem    = getLockRem();
  const tries  = parseInt(localStorage.getItem(TRIES_KEY)||'0');
  const btn    = document.getElementById('authBtn');
  const lockEl = document.getElementById('authLock');
  if (rem > 0) {
    btn.disabled = true;
    lockEl.textContent = `${Math.ceil(rem/1000)}ì´ˆ í›„ ì¬ì‹œë„ ê°€ëŠ¥`;
    setTimeout(updateLockUI, 1000);
  } else {
    btn.disabled = false;
    lockEl.textContent = tries > 0 ? `ë‚¨ì€ ì‹œë„: ${MAX_TRIES - tries}íšŒ` : '';
  }
}

async function tryAuth() {
  if (getLockRem() > 0) return;
  const inp   = document.getElementById('authInput');
  const errEl = document.getElementById('authError');
  if (!inp.value) return;
  const hash = await sha256(inp.value);
  if (hash === ADMIN_HASH) {
    sessionStorage.setItem(SESSION_KEY, '1');
    localStorage.removeItem(TRIES_KEY);
    localStorage.removeItem(LOCK_KEY);
    document.getElementById('authOverlay').classList.add('hidden');
    initApp();
  } else {
    const tries = parseInt(localStorage.getItem(TRIES_KEY)||'0') + 1;
    localStorage.setItem(TRIES_KEY, tries);
    inp.value = '';
    inp.classList.add('error');
    setTimeout(() => inp.classList.remove('error'), 400);
    if (tries >= MAX_TRIES) {
      localStorage.setItem(LOCK_KEY, Date.now() + LOCK_MS);
      errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
      updateLockUI();
    } else {
      errEl.textContent = `ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. (${MAX_TRIES - tries}íšŒ ë‚¨ìŒ)`;
    }
    inp.focus();
  }
}

document.getElementById('authBtn').addEventListener('click', tryAuth);
document.getElementById('authInput').addEventListener('keydown', e => { if (e.key==='Enter') tryAuth(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENTRY POINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if (isAuth()) {
  document.getElementById('authOverlay').classList.add('hidden');
  initApp();
} else {
  updateLockUI();
  setTimeout(() => document.getElementById('authInput').focus(), 100);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP INIT  (dbëŠ” ì—¬ê¸°ì„œ ìƒì„± í›„ í´ë¡œì €ë¡œ ê³µìœ )
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initApp() {
  /* -- Firebase -- */
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const col = collection(db, 'events');

  /* -- ê³„ì • ê´€ë¦¬ ì´ˆê¸°í™” -- */
  initUserMgmt(db);

  /* -- Theme -- */
  const saved = localStorage.getItem('cal_theme');
  if (saved === 'light') document.documentElement.classList.add('light');
  document.getElementById('themeBtn').textContent =
    document.documentElement.classList.contains('light') ? 'â˜€ï¸' : 'ğŸŒ™';
  document.getElementById('themeBtn').addEventListener('click', () => {
    const isL = document.documentElement.classList.toggle('light');
    localStorage.setItem('cal_theme', isL ? 'light' : 'dark');
    document.getElementById('themeBtn').textContent = isL ? 'â˜€ï¸' : 'ğŸŒ™';
  });

  /* -- Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ -- */
  onSnapshot(col, snap => {
    allEvents = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
    applyFilters();
    updateStats();
  }, err => {
    showToast('Firestore ì—°ê²° ì‹¤íŒ¨: ' + err.message, 'error');
  });

  /* -- ìƒˆë¡œê³ ì¹¨ -- */
  document.getElementById('refreshBtn').addEventListener('click', () => {
    applyFilters();
    showToast('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ', 'info');
  });

  /* -- ê²€ìƒ‰ -- */
  document.getElementById('searchInput').addEventListener('input', e => {
    searchQuery = e.target.value.toLowerCase();
    currentPage = 1;
    applyFilters();
  });

  /* -- ë‚ ì§œ ë²”ìœ„ -- */
  document.getElementById('dateFrom').addEventListener('change', e => {
    dateFrom = e.target.value;
    updateDateClearBtn();
    currentPage = 1;
    applyFilters();
  });
  document.getElementById('dateTo').addEventListener('change', e => {
    dateTo = e.target.value;
    updateDateClearBtn();
    currentPage = 1;
    applyFilters();
  });

  /* ë°•ìŠ¤ ì „ì²´ í´ë¦­ â†’ ë‹¬ë ¥ ì—´ê¸° */
  document.getElementById('drFromBox').addEventListener('click', () => {
    const inp = document.getElementById('dateFrom');
    try { inp.showPicker(); } catch(e) { inp.focus(); }
  });
  document.getElementById('drToBox').addEventListener('click', () => {
    const inp = document.getElementById('dateTo');
    try { inp.showPicker(); } catch(e) { inp.focus(); }
  });
  document.getElementById('dateRangeClear').addEventListener('click', () => {
    dateFrom = ''; dateTo = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value   = '';
    updateDateClearBtn();
    currentPage = 1;
    applyFilters();
  });

  /* -- í•„í„° -- */
  document.getElementById('filterGroup').addEventListener('click', e => {
    const btn = e.target.closest('.filter-btn');
    if (!btn) return;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    currentPage = 1;
    applyFilters();
  });

  /* -- ì •ë ¬ -- */
  document.querySelectorAll('.sort-col').forEach(colEl => {
    colEl.addEventListener('click', () => {
      const key = colEl.dataset.sort;
      if (sortKey === key) sortDir *= -1;
      else { sortKey = key; sortDir = 1; }
      document.querySelectorAll('.sort-col').forEach(c => c.classList.remove('active'));
      colEl.classList.add('active');
      document.querySelectorAll('.sort-arrow').forEach(a => a.textContent = '');
      const arrow = document.getElementById('sa-' + key);
      if (arrow) arrow.textContent = sortDir === 1 ? 'â†‘' : 'â†“';
      applyFilters();
    });
  });

  /* -- ë°±ì—… -- */
  document.getElementById('exportBtn').addEventListener('click', exportJSON);

  /* -- ë³µì› -- */
  document.getElementById('importBtn').addEventListener('click', () => {
    document.getElementById('importOverlay').classList.add('open');
  });
  document.getElementById('importClose').addEventListener('click', closeImport);
  document.getElementById('importCancelBtn').addEventListener('click', closeImport);

  const importZone = document.getElementById('importZone');
  const importFile = document.getElementById('importFile');
  importZone.addEventListener('dragover', e => { e.preventDefault(); importZone.classList.add('drag-over'); });
  importZone.addEventListener('dragleave', () => importZone.classList.remove('drag-over'));
  importZone.addEventListener('drop', e => {
    e.preventDefault(); importZone.classList.remove('drag-over');
    handleImportFile(e.dataTransfer.files[0]);
  });
  importFile.addEventListener('change', e => handleImportFile(e.target.files[0]));

  document.getElementById('importConfirmBtn').addEventListener('click', () => {
    if (!importData) return;
    showConfirm(
      'ğŸ“¥ ë°ì´í„° ë³µì›',
      `${importData.length}ê°œ ì¼ì •ì„ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në™ì¼ IDì˜ ì¼ì •ì€ ë®ì–´ì“°ê¸° ë©ë‹ˆë‹¤.`,
      async () => {
        const dataToRestore = importData; // í´ë¡œì €ë¡œ ìº¡ì²˜
        closeImport();
        await runImport(dataToRestore, db); // db ëª…ì‹œì  ì „ë‹¬
      },
      'ë³µì› ì‹¤í–‰', 'import'
    );
  });

  /* -- ì¼ê´„ ì‚­ì œ -- */
  document.getElementById('bulkDeleteBtn').addEventListener('click', () => {
    if (selectedIds.size === 0) return;
    showConfirm('ğŸ—‘ ì„ íƒ ì‚­ì œ', `ì„ íƒí•œ ${selectedIds.size}ê°œ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, async () => {
      let ok = 0;
      for (const id of selectedIds) {
        try { await deleteDoc(doc(db, 'events', id)); ok++; } catch {}
      }
      selectedIds.clear();
      updateBulkBtn();
      showToast(`${ok}ê°œ ì¼ì • ì‚­ì œë¨`, 'success');
    });
  });

  /* -- í˜ì´ì§€ë„¤ì´ì…˜ -- */
  document.getElementById('pagePrev').addEventListener('click', () => {
    if (currentPage > 1) { currentPage--; renderList(); }
  });
  document.getElementById('pageNext').addEventListener('click', () => {
    const total = Math.ceil(filteredEvents.length / PAGE_SIZE);
    if (currentPage < total) { currentPage++; renderList(); }
  });

  /* -- ìƒì„¸ ëª¨ë‹¬ -- */
  document.getElementById('detailClose').addEventListener('click',    () => document.getElementById('detailOverlay').classList.remove('open'));
  document.getElementById('detailCloseBtn').addEventListener('click', () => document.getElementById('detailOverlay').classList.remove('open'));
  document.getElementById('detailDeleteBtn').addEventListener('click', () => {
    const id = document.getElementById('detailId').dataset.id;
    if (id) deleteEventById(id, db);
  });

  /* -- í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ -- */
  document.getElementById('confirmCancel').addEventListener('click', () => document.getElementById('confirmOverlay').classList.remove('open'));
  document.getElementById('confirmOk').addEventListener('click', () => {
    document.getElementById('confirmOverlay').classList.remove('open');
    if (confirmCallback) confirmCallback();
  });

  /* -- ESC -- */
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      document.getElementById('detailOverlay').classList.remove('open');
      document.getElementById('importOverlay').classList.remove('open');
      document.getElementById('confirmOverlay').classList.remove('open');
    }
  });

  /* -- í–‰ ì‚­ì œ ë²„íŠ¼ (ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ renderList ì´í›„ë„ ë™ì‘) -- */
  document.getElementById('eventList').addEventListener('click', e => {
    const delBtn = e.target.closest('[data-delid]');
    if (delBtn) {
      e.stopPropagation();
      deleteEventById(delBtn.dataset.delid, db);
    }
  });

  function deleteEventById(id, db) {
    const ev = allEvents.find(e => e._id === id);
    if (!ev) return;
    showConfirm('ğŸ—‘ ì¼ì • ì‚­ì œ', `"${ev.title||'(ì œëª© ì—†ìŒ)'}" ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, async () => {
      try {
        await deleteDoc(doc(db, 'events', id));
        document.getElementById('detailOverlay').classList.remove('open');
        showToast('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      } catch(err) {
        showToast('ì‚­ì œ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTER / SORT / RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateDateClearBtn() {
  document.getElementById('dateRangeClear').style.display = (dateFrom || dateTo) ? '' : 'none';
  /* ë‚ ì§œ í‘œì‹œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ */
  const fromDisplay = document.getElementById('drFromDisplay');
  const toDisplay   = document.getElementById('drToDisplay');
  const fromText    = document.getElementById('drFromText');
  const toText      = document.getElementById('drToText');
  if (dateFrom) {
    fromText.textContent = dateFrom;
    fromDisplay.classList.remove('empty');
  } else {
    fromText.textContent = 'ì‹œì‘ì¼';
    fromDisplay.classList.add('empty');
  }
  if (dateTo) {
    toText.textContent = dateTo;
    toDisplay.classList.remove('empty');
  } else {
    toText.textContent = 'ì¢…ë£Œì¼';
    toDisplay.classList.add('empty');
  }
}

function applyFilters() {
  let evs = [...allEvents];
  if (currentFilter !== 'all') evs = evs.filter(e => (e.color||'gold') === currentFilter);
  if (searchQuery) evs = evs.filter(e =>
    (e.title||'').toLowerCase().includes(searchQuery) ||
    (e.name||'').toLowerCase().includes(searchQuery) ||
    (e.address||'').toLowerCase().includes(searchQuery) ||
    (e.gold?.name||'').toLowerCase().includes(searchQuery)
  );
  if (dateFrom) evs = evs.filter(e => e.startDate >= dateFrom);
  if (dateTo)   evs = evs.filter(e => e.startDate <= dateTo);
  evs.sort((a, b) => {
    let av = a[sortKey]||'', bv = b[sortKey]||'';
    if (sortKey === 'color') { av = TYPE_LABELS[av]||''; bv = TYPE_LABELS[bv]||''; }
    return av < bv ? -sortDir : av > bv ? sortDir : 0;
  });
  filteredEvents = evs;
  currentPage = Math.min(currentPage, Math.max(1, Math.ceil(evs.length / PAGE_SIZE)));
  renderList();
}

function updateStats() {
  document.getElementById('st-total').textContent = allEvents.length;
  document.getElementById('st-gold').textContent  = allEvents.filter(e=>(e.color||'gold')==='gold').length;
  document.getElementById('st-blue').textContent  = allEvents.filter(e=>e.color==='blue').length;
  document.getElementById('st-red').textContent   = allEvents.filter(e=>e.color==='red').length;
  document.getElementById('st-green').textContent = allEvents.filter(e=>e.color==='green').length;
  document.getElementById('st-purple').textContent= allEvents.filter(e=>e.color==='purple').length;
}

function renderList() {
  const list       = document.getElementById('eventList');
  const total      = filteredEvents.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  const start      = (currentPage - 1) * PAGE_SIZE;
  const pageEvs    = filteredEvents.slice(start, start + PAGE_SIZE);

  list.innerHTML = '';
  if (pageEvs.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div></div>`;
  } else {
    pageEvs.forEach(ev => {
      const c          = ev.color || 'gold';
      const isSelected = selectedIds.has(ev._id);
      const row        = document.createElement('div');
      row.className    = 'event-row' + (isSelected ? ' selected' : '');

      const dateStr    = ev.startDate || '';
      const endStr     = ev.endDate && ev.endDate !== ev.startDate ? ` ~ ${ev.endDate}` : '';
      const flags      = [
        ...(ev.specialOpts||[]).map(k => SPECIAL_LABELS[k]||''),
        ...(ev.schedOpt ? [SCHED_LABELS[ev.schedOpt]||''] : [])
      ];
      const personName = c === 'gold' ? (ev.gold?.name || ev.name || '') : (ev.name || '');
      const personAddr = ev.address || ev.location || '';
      const nameCell   = personName || 'â€”';
      const addrCell   = personAddr
        ? `<span title="${personAddr}">ğŸ“ ${personAddr}</span>`
        : '<span style="opacity:0.35">â€”</span>';

      row.innerHTML = `
        <div class="row-check"><div class="check-circle">${isSelected ? 'âœ“' : ''}</div></div>
        <div class="row-title">
          <div class="color-bar cb-${c}"></div>
          <div>
            <div class="title-text">${ev.title||'(ì œëª© ì—†ìŒ)'}</div>
            ${ev.desc ? `<div class="title-sub">${ev.desc.slice(0,40)}${ev.desc.length>40?'â€¦':''}</div>` : ''}
          </div>
        </div>
        <div class="row-date hide-m">${dateStr}${endStr}</div>
        <div class="row-address hide-m">${addrCell}</div>
        <div class="row-person hide-m">${nameCell}</div>
        <div><span class="row-badge rb-${c}">${TYPE_LABELS[c]||c}</span></div>
        <div class="row-flags">${flags.map(f=>`<span title="${f}">${f.slice(0,2)}</span>`).join('')}${ev.locked ? 'ğŸ”’' : ''}</div>
        <div class="row-actions">
          <button class="row-action-btn edit" data-id="${ev._id}" title="ìƒì„¸ë³´ê¸°">ğŸ”</button>
          <button class="row-action-btn del"  data-delid="${ev._id}" title="ì‚­ì œ">ğŸ—‘</button>
        </div>`;

      row.addEventListener('click', e => {
        if (e.target.closest('.row-action-btn')) return;
        if (selectedIds.has(ev._id)) selectedIds.delete(ev._id);
        else selectedIds.add(ev._id);
        updateBulkBtn();
        renderList();
      });

      row.querySelector('.row-action-btn.edit').addEventListener('click', e => {
        e.stopPropagation();
        openDetail(ev);
      });

      list.appendChild(row);
    });
  }

  /* í˜ì´ì§€ë„¤ì´ì…˜ */
  document.getElementById('pagePrev').disabled = currentPage <= 1;
  document.getElementById('pageNext').disabled = currentPage >= totalPages;
  const nums  = document.getElementById('pageNums');
  nums.innerHTML = '';
  const range = 3;
  for (let p = Math.max(1, currentPage-range); p <= Math.min(totalPages, currentPage+range); p++) {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (p === currentPage ? ' active' : '');
    btn.textContent = p;
    btn.addEventListener('click', () => { currentPage = p; renderList(); });
    nums.appendChild(btn);
  }
  document.getElementById('pageInfo').textContent = `${start+1}â€“${Math.min(start+PAGE_SIZE, total)} / ${total}ê±´`;

  const selEl = document.getElementById('selCount');
  if (selectedIds.size > 0) { selEl.style.display = ''; selEl.textContent = `${selectedIds.size}ê°œ ì„ íƒë¨`; }
  else selEl.style.display = 'none';
}

function updateBulkBtn() {
  document.getElementById('bulkDeleteBtn').style.display = selectedIds.size > 0 ? '' : 'none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openDetail(ev) {
  const c = ev.color || 'gold';
  document.getElementById('detailStrip').className      = 'modal-strip ms-' + c;
  document.getElementById('detailBadge').textContent    = `${ev.startDate||''} ${TYPE_LABELS[c]||''}`;
  document.getElementById('detailTitle').textContent    = ev.title || '(ì œëª© ì—†ìŒ)';
  document.getElementById('detailId').textContent       = `ID: ${ev._id}`;
  document.getElementById('detailId').dataset.id        = ev._id;

  const body = document.getElementById('detailBody');
  body.innerHTML = '';

  body.appendChild(makeSection('ê¸°ë³¸ ì •ë³´', [
    ['ì‹œì‘ì¼',    ev.startDate||'â€”'],
    ['ì¢…ë£Œì¼',    ev.endDate||ev.startDate||'â€”'],
    ['ì‹œê°„',      ev.allDay!==false ? 'ì¢…ì¼' : `${ev.startTime||'?'} ~ ${ev.endTime||'?'}`],
    ['ë¶„ë¥˜',      TYPE_LABELS[c]||c],
    ['ì´ë¦„/ë‹´ë‹¹ì', ev.name||(ev.gold?.name)||'â€”'],
    ['ì£¼ì†Œ',      ev.address||'â€”'],
    ['ì ê¸ˆ',      ev.locked ? 'ğŸ”’ ì ê¸ˆë¨' : 'ì—†ìŒ'],
    ['íŠ¹ìˆ˜ì˜µì…˜',  (ev.specialOpts||[]).map(k=>SPECIAL_LABELS[k]||k).join(', ') || (ev.schedOpt ? SCHED_LABELS[ev.schedOpt] : 'ì—†ìŒ')],
  ]));

  if (ev.desc) body.appendChild(makeSection('ìƒì„¸ ì„¤ëª…', [['ë‚´ìš©', ev.desc]]));

  if (c === 'gold' && ev.gold) {
    const g = ev.gold;
    body.appendChild(makeSection('ì˜ë¢°ì ì •ë³´', [
      ['ì „í™”ë²ˆí˜¸', g.phone||'â€”'], ['í”Œë«í¼',  g.platform||'â€”'],
      ['ë°©ì†¡ì£¼ì œ', g.topic||'â€”'], ['ê²½ë ¥',    g.career||'â€”'],
      ['ê²°ì œ',     g.paid||'â€”'],  ['ì£¼ë¬¸ì œí’ˆ', g.order||'â€”'],
      ['ì”ê¸ˆ',     g.balance||'â€”'],['ì”ê¸ˆê¸ˆì•¡', g.balance_amount||'â€”'],
    ]));
    if (g.equipment) body.appendChild(makeSection('ì¥ë¹„ ëª©ë¡', [['ì¥ë¹„', g.equipment]]));
    if (g.req_topic||g.req_detail) body.appendChild(makeSection('ì˜ë¢° ë‚´ìš©', [['ì£¼ì œ',g.req_topic||'â€”'],['ì„¸ë¶€',g.req_detail||'â€”']]));
    if (g.special)   body.appendChild(makeSection('íŠ¹ì´ì‚¬í•­', [['ë‚´ìš©', g.special]]));
    const imgCount = (g.quoteImgs||[]).length + (g.refImgs||[]).length + (g.roomImgs||[]).length;
    if (imgCount > 0) body.appendChild(makeSection('ì²¨ë¶€ ì´ë¯¸ì§€', [['ì´ë¯¸ì§€ ìˆ˜', `${imgCount}ê°œ`]]));
  }

  if (c === 'purple') {
    const meetFields = [];
    if (ev.name)    meetFields.push(['ë‹´ë‹¹ì/ì°¸ì„ì', ev.name]);
    if (ev.address) meetFields.push(['ì¥ì†Œ', ev.address]);
    if (ev.desc)    meetFields.push(['ë‚´ìš©', ev.desc]);
    if (meetFields.length > 0) body.appendChild(makeSection('ë¯¸íŒ…/ë‚´ë°© ì •ë³´', meetFields));
  }

  if ((ev.attachments||[]).length > 0)
    body.appendChild(makeSection('ì²¨ë¶€ íŒŒì¼', [['íŒŒì¼ ìˆ˜', `${ev.attachments.length}ê°œ`]]));

  /* Raw JSON */
  const jsonSec   = document.createElement('div'); jsonSec.className = 'detail-section';
  const jsonTitle = document.createElement('div'); jsonTitle.className = 'detail-section-title'; jsonTitle.textContent = 'Raw JSON';
  const jsonBox   = document.createElement('div'); jsonBox.className = 'json-view-box';
  const { _id, ...cleanEv } = ev;
  jsonBox.textContent = JSON.stringify(cleanEv, null, 2);
  jsonSec.appendChild(jsonTitle); jsonSec.appendChild(jsonBox);
  body.appendChild(jsonSec);
  body.appendChild(document.createElement('div'));

  document.getElementById('detailOverlay').classList.add('open');
}

function makeSection(title, fields) {
  const sec  = document.createElement('div'); sec.className = 'detail-section';
  const t    = document.createElement('div'); t.className = 'detail-section-title'; t.textContent = title;
  const grid = document.createElement('div'); grid.className = 'detail-grid';
  fields.forEach(([k, v]) => {
    const item = document.createElement('div'); item.className = 'detail-item';
    const key  = document.createElement('div'); key.className = 'detail-key'; key.textContent = k;
    const val  = document.createElement('div');
    val.className = 'detail-val' + (!v || v === 'â€”' ? ' empty' : '');
    val.textContent = v || 'â€”';
    item.appendChild(key); item.appendChild(val); grid.appendChild(item);
  });
  sec.appendChild(t); sec.appendChild(grid);
  return sec;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT / IMPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function stripTimestamps(obj) {
  if (obj === null || obj === undefined) return obj;
  if (typeof obj !== 'object') return obj;
  if (Array.isArray(obj)) return obj.map(stripTimestamps);
  if ('seconds' in obj && 'nanoseconds' in obj) return null;
  const result = {};
  for (const [k, v] of Object.entries(obj)) result[k] = stripTimestamps(v);
  return result;
}

function exportJSON() {
  const toExport = filteredEvents.map(ev => {
    const { _id, ...rest } = ev;
    return { _id, ...stripTimestamps(rest) };
  });
  const blob    = new Blob([JSON.stringify(toExport, null, 2)], { type: 'application/json' });
  const url     = URL.createObjectURL(blob);
  const a       = document.createElement('a');
  const now     = new Date();
  const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
  a.href = url; a.download = `calendar_backup_${dateStr}.json`;
  a.click(); URL.revokeObjectURL(url);
  showToast(`${toExport.length}ê°œ ì¼ì • ë°±ì—… ì™„ë£Œ`, 'success');
}

function handleImportFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) { showToast('ì˜ëª»ëœ JSON í˜•ì‹ì…ë‹ˆë‹¤', 'error'); return; }
      importData = data;
      const prev = document.getElementById('importPreview');
      prev.style.display = '';
      prev.textContent = `âœ“ ${data.length}ê°œ ì¼ì • í™•ì¸ë¨\nìµœì´ˆ ì¼ì •: ${data[0]?.startDate||'?'}\në§ˆì§€ë§‰ ì¼ì •: ${data[data.length-1]?.startDate||'?'}`;
      document.getElementById('importInfo').textContent = `${file.name} Â· ${data.length}ê°œ`;
      document.getElementById('importConfirmBtn').disabled = false;
    } catch { showToast('JSON íŒŒì‹± ì˜¤ë¥˜', 'error'); }
  };
  reader.readAsText(file);
}

function closeImport() {
  document.getElementById('importOverlay').classList.remove('open');
  document.getElementById('importPreview').style.display = 'none';
  document.getElementById('importConfirmBtn').disabled = true;
  document.getElementById('importFile').value = '';
  importData = null;
}

async function runImport(data, db) {
  const total = data.length;
  let ok = 0, fail = 0, skip = 0;

  const overlay = document.getElementById('progressOverlay');
  const bar     = document.getElementById('progressBar');
  const txt     = document.getElementById('progressText');
  const title   = document.getElementById('progressTitle');

  overlay.style.display = 'flex';
  title.textContent = `ë³µì› ì¤‘â€¦ (ì´ ${total}ê°œ)`;
  bar.style.width   = '0%';
  txt.textContent   = `0 / ${total}`;

  for (let i = 0; i < data.length; i++) {
    const ev = data[i];
    try {
      const id = ev._id || ev.id;
      if (!id) { skip++; continue; }

      const { _id, id: _id2, updatedAt, createdAt, ...rawData } = ev;
      const sanitized = stripTimestamps(JSON.parse(JSON.stringify(rawData)));

      await setDoc(doc(db, 'events', id), {
        ...sanitized,
        updatedAt: serverTimestamp()
      });
      ok++;
    } catch(err) {
      console.error('ë³µì› ì‹¤íŒ¨:', ev._id, err);
      fail++;
      title.textContent = `âš ï¸ ì˜¤ë¥˜ ë°œìƒ (${err.code || err.message})`;
    }

    const pct        = Math.round(((i + 1) / total) * 100);
    bar.style.width  = pct + '%';
    txt.textContent  = `${i + 1} / ${total}`;
    if (fail === 0) title.textContent = `ë³µì› ì¤‘â€¦ ${pct}%`;

    if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
  }

  overlay.style.display = 'none';

  const msg = `ë³µì› ì™„ë£Œ: ${ok}ê°œ ì„±ê³µ` +
    (fail > 0 ? `, ${fail}ê°œ ì‹¤íŒ¨` : '') +
    (skip > 0 ? `, ${skip}ê°œ ê±´ë„ˆëœ€` : '');
  showToast(msg, ok > 0 ? 'success' : 'error');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRM / TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showConfirm(title, text, cb, okLabel='ì‚­ì œ', type='delete') {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmText').textContent  = text;
  document.getElementById('confirmOk').textContent    = okLabel;
  document.getElementById('confirmOk').style.background = type === 'import' ? 'var(--accent2)' : 'var(--red)';
  confirmCallback = cb;
  document.getElementById('confirmOverlay').classList.add('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USER MANAGEMENT  (sha256ëŠ” ìœ„ AUTH ì„¹ì…˜ì—ì„œ ê³µìœ )
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initUserMgmt(db) {
  const wrap   = document.getElementById('userMgmtWrap');
  const body   = document.getElementById('userMgmtBody');
  const toggle = document.getElementById('userMgmtToggle');
  wrap.style.display = '';

  toggle.addEventListener('click', () => {
    const isOpen = body.classList.toggle('open');
    toggle.textContent = isOpen ? 'ì ‘ê¸° â–´' : 'í¼ì¹˜ê¸° â–¾';
    if (isOpen) loadUserList(db);
  });

  document.getElementById('userCreateBtn').addEventListener('click', () => createUser(db));
  document.getElementById('newUserPw').addEventListener('keydown', e => { if (e.key === 'Enter') createUser(db); });
  document.getElementById('newUserId').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('newUserName').focus(); });
  document.getElementById('newUserName').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('newUserPw').focus(); });
}

async function loadUserList(db) {
  const listEl = document.getElementById('userList');
  listEl.innerHTML = '<div class="user-list-empty">ë¡œë”© ì¤‘â€¦</div>';
  try {
    const snap = await getDocs(collection(db, 'users'));
    if (snap.empty) {
      listEl.innerHTML = '<div class="user-list-empty">ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    listEl.innerHTML = '';
    snap.docs.forEach(d => {
      const data = d.data();
      const row  = document.createElement('div');
      row.className = 'user-row';
      const createdAt = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleDateString('ko-KR') : 'â€”';
      row.innerHTML = `
        <span class="user-row-id">ğŸ”‘ ${d.id}${data.displayName ? ` <span style="color:var(--accent);font-weight:600;">(${data.displayName})</span>` : ''}</span>
        <span class="user-row-meta">ìƒì„±: ${createdAt}</span>
        <button class="user-row-del" data-uid="${d.id}">ì‚­ì œ</button>`;
      row.querySelector('.user-row-del').addEventListener('click', () => {
        showConfirm(
          'ê³„ì • ì‚­ì œ',
          `"${d.id}" ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ ìº˜ë¦°ë”ì— ì ‘ì†í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.`,
          async () => {
            await deleteDoc(doc(db, 'users', d.id));
            showToast(`ê³„ì • "${d.id}" ì‚­ì œë¨`, 'success');
            loadUserList(db);
          }, 'ì‚­ì œ', 'delete'
        );
      });
      listEl.appendChild(row);
    });
  } catch(err) {
    listEl.innerHTML = `<div class="user-list-empty">ì˜¤ë¥˜: ${err.message}</div>`;
  }
}

async function createUser(db) {
  const idEl   = document.getElementById('newUserId');
  const nameEl = document.getElementById('newUserName');
  const pwEl   = document.getElementById('newUserPw');
  const userId   = idEl.value.trim();
  const userName = nameEl.value.trim();
  const userPw   = pwEl.value;

  idEl.classList.remove('error');
  nameEl.classList.remove('error');
  pwEl.classList.remove('error');

  if (!userId) { idEl.classList.add('error'); idEl.focus(); showToast('ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  if (!userName) { nameEl.classList.add('error'); nameEl.focus(); showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  if (!userPw) { pwEl.classList.add('error'); pwEl.focus(); showToast('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  if (!/^[a-zA-Z0-9_\-ê°€-í£]+$/.test(userId)) {
    idEl.classList.add('error'); idEl.focus();
    showToast('ì•„ì´ë””ëŠ” ì˜ë¬¸, ìˆ«ì, _, - ë˜ëŠ” í•œê¸€ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error'); return;
  }

  try {
    const existing = await getDoc(doc(db, 'users', userId));
    if (existing.exists()) {
      idEl.classList.add('error'); idEl.focus();
      showToast(`"${userId}" ì•„ì´ë””ëŠ” ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤`, 'error'); return;
    }
    const pwHash = await sha256(userPw);
    await setDoc(doc(db, 'users', userId), {
      passwordHash: pwHash,
      displayName: userName,
      createdAt: serverTimestamp()
    });
    idEl.value = ''; nameEl.value = ''; pwEl.value = '';
    showToast(`ê³„ì • "${userId}" (${userName}) ì¶”ê°€ ì™„ë£Œ`, 'success');
    loadUserList(db);
  } catch(err) {
    showToast('ê³„ì • ìƒì„± ì‹¤íŒ¨: ' + err.message, 'error');
  }
}

let toastTimer;
function showToast(msg, type='info') {
  const t = document.getElementById('toast');
  t.textContent = type==='success' ? 'âœ“ '+msg : type==='error' ? 'âœ• '+msg : 'â„¹ '+msg;
  t.className   = 'toast show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 4000);
}
</script>
<!-- â•â•â• PROGRESS OVERLAY â•â•â• -->
<div id="progressOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.78);z-index:9998;backdrop-filter:blur(6px);align-items:center;justify-content:center;flex-direction:column;gap:20px;">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:36px 40px;min-width:320px;text-align:center;">
    <div style="font-size:32px;margin-bottom:12px;">ğŸ“¥</div>
    <div style="font-family:var(--font-mono);font-size:13px;letter-spacing:0.12em;color:var(--accent);margin-bottom:18px;" id="progressTitle">ë³µì› ì¤‘â€¦</div>
    <div style="background:var(--surface2);border-radius:999px;height:8px;overflow:hidden;margin-bottom:14px;">
      <div id="progressBar" style="height:100%;background:var(--accent);border-radius:999px;width:0%;transition:width 0.2s ease;"></div>
    </div>
    <div style="font-family:var(--font-mono);font-size:12px;color:var(--text-muted);" id="progressText">0 / 0</div>
  </div>
</div>

</body>
</html>
